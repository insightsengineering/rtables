<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Intermediate rtables - Identifying Required Analysis Behavior • rtables</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Intermediate rtables - Identifying Required Analysis Behavior">
<link rel="stylesheet" href="../consent.css">
<script src="../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rtables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.13.9003</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/rtables.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/exploratory_analysis.html">Exploratory Analysis</a></li>
    <li><a class="dropdown-item" href="../articles/guided_intermediate_translating_shells.html">Intermediate rtables - Translating Shells To Layouts</a></li>
    <li><a class="dropdown-item" href="../articles/guided_intermediate_afun_reqs.html">Intermediate rtables - Identifying Required Analysis Behavior</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Clinical Trials</h6></li>
    <li><a class="dropdown-item" href="../articles/clinical_trials.html">Example Clinical Trials Tables</a></li>
    <li><a class="dropdown-item" href="../articles/baseline.html">Comparing Against Baselines or Control</a></li>
    <li><a class="dropdown-item" href="../articles/ard_how_to.html">Generating QC-Ready Result Data Frames (ARDs) from Tables</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Table Customization</h6></li>
    <li><a class="dropdown-item" href="../articles/custom_appearance.html">Customizing Appearance</a></li>
    <li><a class="dropdown-item" href="../articles/title_footer.html">Titles, Footers, and Referential Footnotes</a></li>
    <li><a class="dropdown-item" href="../articles/sorting_pruning.html">Pruning and Sorting Tables</a></li>
    <li><a class="dropdown-item" href="../articles/col_counts.html">Column Counts and Formats</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-developer-guide" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Developer Guide</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-developer-guide">
<li><a class="dropdown-item" href="../articles/dev-guide/dg_split_machinery.html">Split Machinery</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_tabulation.html">Tabulation</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_table_hierarchy.html">Table Hierarchy</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_debug_rtables.html">Debugging in {rtables} and Beyond</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_notes.html">Sparse Notes on {rtables} Internals</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report-non-cran/">Non-CRAN unit test report</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/insightsengineering/rtables"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Intermediate rtables - Identifying Required Analysis Behavior</h1>
            <h3 data-toc-skip class="subtitle">Contributed by Johnson
&amp; Johnson Innovative Medicine</h3>
                        <h4 data-toc-skip class="author">Gabriel
Becker</h4>
                        <h4 data-toc-skip class="author">Dan
Hofstaedter</h4>
            
            <h4 data-toc-skip class="date">2025-10-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/rtables/blob/main/vignettes/guided_intermediate_afun_reqs.Rmd" class="external-link"><code>vignettes/guided_intermediate_afun_reqs.Rmd</code></a></small>
      <div class="d-none name"><code>guided_intermediate_afun_reqs.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Analysis functions can do anything. While this provides one of the
backbones of <code>rtables</code>’ power and flexibility, it also means
that analysis functions must be chosen (and designed) with care to
ensure our resulting tables contain the correct statistics.</p>
<p>While the diversity of tables is such that custom analysis functions
will inevitably be needed in some cases, we will not address the
<em>creation</em> of analysis functions in detail here; that is covered
in within the <a href="guided_advanced_afun_design.html">advanced</a>
portion of this guided tour. Here we will focus on <em>selecting</em>
analysis functions and the reasoning that goes into that choice. While
this might seem like a strange distinction at first glance, this is in
fact how most tables will be created - when a template script or
function is not used to create them from whole cloth; packages like <a href="https://cran.r-project.org/package=tern" class="external-link">tern</a> and <a href="https://cran.r-project.org/package=junco" class="external-link">junco</a> provide
libraries of well-tested analysis functions that statistical programmers
will often simply select from when creating production outputs.</p>
</div>
<div class="section level2">
<h2 id="who-are-your-numbers-and-what-do-they-do">Who Are Your Numbers And What Do They Do?<a class="anchor" aria-label="anchor" href="#who-are-your-numbers-and-what-do-they-do"></a>
</h2>
<p>The details of what a desired analysis behavior calls for can be
categorized into two distinct types: specific and fundamental. Specific
analysis behaviors are things like which particular statistical test or
confidence interval method should be used, how missing or censored data
should be handled, etc.</p>
<p>Before specific details can be considered, however, the fundamental
aspects of the desired behavior must be determined. These come down to
three aspects fundamental to how the contents of our table are intended
to be interpreted:</p>
<ol style="list-style-type: decimal">
<li>The <strong>type</strong> of observation being <em>counted or
analyzed</em>,</li>
<li>The <strong>(sub)population</strong> we are <em>analyzing
within</em> or <em>comparing against</em>, and</li>
<li>Whether the behavior is <strong>conditional</strong>, depending on
the facet it is populating.</li>
</ol>
<div class="section level3">
<h3 id="theres-counting-and-then-theres-counting">There’s Counting And Then There’s Counting…<a class="anchor" aria-label="anchor" href="#theres-counting-and-then-theres-counting"></a>
</h3>
<p>Consider the “simple” act of counting the frequency of different
types of adverse events (AEs) that occurred in a clinical trial; this
could mean one of two quite different things:</p>
<ol style="list-style-type: decimal">
<li>The number of <strong>(unique) patients</strong> which suffered a
particular AE, or</li>
<li>The number of <strong>times the AE was suffered</strong>
</li>
</ol>
<p>These will generally give dramatically different numbers, as
illustrated by the table below, and one or both may be desired in a
given table.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">double_count</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/in_rows.html">in_rows</a></span><span class="op">(</span></span>
<span>    <span class="st">"Unique Patients"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="st">"Total Events"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">lyt_counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AEBODSYS"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/split_funcs.html">trim_levels_in_group</a></span><span class="op">(</span><span class="st">"AEDECOD"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AEDECOD"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, afun <span class="op">=</span> <span class="va">double_count</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt_counts</span>, <span class="va">ex_adae</span>, alt_counts_df <span class="op">=</span> <span class="va">ex_adsl</span><span class="op">)</span></span></code></pre></div>
<pre><code>                      A: Drug X   B: Placebo   C: Combination
—————————————————————————————————————————————————————————————
cl A.1                                                       
  dcd A.1.1.1.1                                              
    Unique Patients      50           45             63      
    Total Events         64           62             88      
  dcd A.1.1.1.2                                              
    Unique Patients      48           48             50      
    Total Events         68           68             72      
cl B.1                                                       
  dcd B.1.1.1.1                                              
    Unique Patients      47           49             43      
    Total Events         56           60             62      
cl B.2                                                       
  dcd B.2.1.2.1                                              
    Unique Patients      49           44             52      
    Total Events         65           62             66      
  dcd B.2.2.3.1                                              
    Unique Patients      48           54             51      
    Total Events         64           76             77      
cl C.1                                                       
  dcd C.1.1.1.3                                              
    Unique Patients      43           46             43      
    Total Events         55           63             64      
cl C.2                                                       
  dcd C.2.1.2.1                                              
    Unique Patients      35           48             55      
    Total Events         48           53             65      
cl D.1                                                       
  dcd D.1.1.1.1                                              
    Unique Patients      50           42             51      
    Total Events         61           51             71      
  dcd D.1.1.4.2                                              
    Unique Patients      48           42             50      
    Total Events         66           55             64      
cl D.2                                                       
  dcd D.2.1.5.3                                              
    Unique Patients      47           58             57      
    Total Events         62           72             74      </code></pre>
</div>
<div class="section level3">
<h3 id="denominators">Denominators<a class="anchor" aria-label="anchor" href="#denominators"></a>
</h3>
<p>Once we have defined counting, we often want to display percents
alongside the absolute counts. Even with the meaning of our counts
fixed, however, this can mean a number of different things, depending on
<strong><em>the (sub)population we are considering the count a percent
of</em></strong>. Different denominators used in production can include
the overall relevant count for the:</p>
<ol style="list-style-type: decimal">
<li>column (often trial arm)</li>
<li>individual facet (row x column)</li>
<li>row group (across all columns)</li>
<li>ancestor row facet (across all columns)</li>
<li>ancestor row facet for a single column</li>
</ol>
<p>Keeping in mind that each of the above might be either of the two
<strong>types</strong> of counting discussed above (generally events or
patients in a clinical trial setting).</p>
<p>Furthermore, these denominators can often need to be derived from the
<code>alt_counts_df</code> used to build the table when counting
patients, rather than the data being directly tabulated, due to the fact
that not all patients are guaranteed to appear in event based datasets
(e.g., <code>ADAE</code>).</p>
<p>As before, we can see that these denominators can vary wildly, which
would cause the percents displayed to do so as well. We will use a
custom afun (<code>disp_denoms</code>) to explore the differences
between the above types of denominators. The details of how we implement
the <code>disp_denoms</code> function used below is not germane to our
discussion here but motivated readers can choose to inspect it
below.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">disp_denoms</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">.var</span>, <span class="va">.N_col</span>, <span class="va">.df_row</span>, <span class="va">.alt_df_full</span>, <span class="va">.spl_context</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## myfn &lt;- RefFootnote("Patients observed in AE data", symbol = "*")</span></span>
<span>  <span class="va">parent_df</span> <span class="op">&lt;-</span> <span class="va">.spl_context</span><span class="op">$</span><span class="va">full_parent_df</span><span class="op">[[</span><span class="fl">3</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">parent_df_onecol</span> <span class="op">&lt;-</span> <span class="va">parent_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">cur_col_expr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, envir <span class="op">=</span> <span class="va">parent_df</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="va">gparent_df</span> <span class="op">&lt;-</span> <span class="va">.spl_context</span><span class="op">$</span><span class="va">full_parent_df</span><span class="op">[[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">gparent_df_onecol</span> <span class="op">&lt;-</span> <span class="va">gparent_df</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">cur_col_expr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, envir <span class="op">=</span> <span class="va">gparent_df</span><span class="op">)</span>, <span class="op">]</span></span>
<span>  <span class="va">cur_race</span> <span class="op">&lt;-</span> <span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span></span>
<span>  <span class="va">cur_aebodsys</span> <span class="op">&lt;-</span> <span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span><span class="op">[</span><span class="fl">3</span><span class="op">]</span></span>
<span>  <span class="va">cur_aedecod</span> <span class="op">&lt;-</span> <span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span><span class="op">[</span><span class="fl">4</span><span class="op">]</span></span>
<span>  <span class="va">alt_df_race</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">.alt_df_full</span>, <span class="va">RACE</span> <span class="op">==</span> <span class="va">cur_race</span><span class="op">)</span></span>
<span>  <span class="va">alt_df_race_col</span> <span class="op">&lt;-</span> <span class="va">alt_df_race</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">cur_col_expr</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, envir <span class="op">=</span> <span class="va">alt_df_race</span><span class="op">)</span>, <span class="op">]</span></span>
<span></span>
<span>  <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">.N_col</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="cn">NA</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">.df_row</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">.df_row</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="cn">NA</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">parent_df</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">parent_df</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">parent_df_onecol</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">parent_df_onecol</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">gparent_df</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">gparent_df</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">alt_df_race</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">gparent_df_onecol</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">gparent_df_onecol</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">NROW</a></span><span class="op">(</span><span class="va">alt_df_race_col</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>    <span class="st">"Column N"</span>,</span>
<span>    <span class="st">"facet events"</span>,</span>
<span>    <span class="st">"facet patients"</span>,</span>
<span>    <span class="st">"facet patients - alt df"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s events"</span>, <span class="va">cur_aedecod</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients"</span>, <span class="va">cur_aedecod</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients - alt df"</span>, <span class="va">cur_aedecod</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s events (all arms)"</span>, <span class="va">cur_aebodsys</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients (all arms)"</span>, <span class="va">cur_aebodsys</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s events (this arm)"</span>, <span class="va">cur_aebodsys</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients (this arm)"</span>, <span class="va">cur_aebodsys</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s events (all arms)"</span>, <span class="va">cur_race</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients (all arms)"</span>, <span class="va">cur_race</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients (all arms) - alt df"</span>, <span class="va">cur_race</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s events (this arms)"</span>, <span class="va">cur_race</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients (this arms)"</span>, <span class="va">cur_race</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%s patients (this arms) - alt df"</span>, <span class="va">cur_race</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/in_rows.html">in_rows</a></span><span class="op">(</span>.list <span class="op">=</span> <span class="va">vals</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>With <code>disp_denoms</code> defined, we can proceed with using it
to see how varied the options for denominator are when calculating a
percent:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">RACE</span>, <span class="op">~</span><span class="va">AEBODSYS</span>, <span class="op">~</span><span class="va">AEDECOD</span>,</span>
<span>  <span class="st">"ASIAN"</span>, <span class="st">"cl B.2"</span>, <span class="st">"dcd B.2.2.3.1"</span>,</span>
<span>  <span class="st">"WHITE"</span>, <span class="st">"cl A.1"</span>, <span class="st">"dcd A.1.1.1.1"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lyt_denoms</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"RACE"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/trim_levels_to_map.html">trim_levels_to_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co">## keep_split_levels(c("ASIAN", "WHITE"))) |&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AEBODSYS"</span><span class="op">)</span> <span class="op">|&gt;</span> <span class="co"># , split_fun = trim_levels_in_group("AEDECOD")) |&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AEDECOD"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"USUBJID"</span>, afun <span class="op">=</span> <span class="va">disp_denoms</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt_denoms</span>, <span class="va">ex_adae</span>, alt_counts_df <span class="op">=</span> <span class="va">ex_adsl</span><span class="op">)</span></span></code></pre></div>
<pre><code>                                            A: Drug X   B: Placebo   C: Combination
———————————————————————————————————————————————————————————————————————————————————
ASIAN                                                                              
  cl B.2                                                                           
    dcd B.2.2.3.1                                                                  
      Column N                                 134         134            132      
      facet events                             37           38             48      
      facet patients                           27           27             30      
      facet patients - alt df                  NA           NA             NA      
      dcd B.2.2.3.1 events                     123         123            123      
      dcd B.2.2.3.1 patients                   84           84             84      
      dcd B.2.2.3.1 patients - alt df          NA           NA             NA      
      cl B.2 events (all arms)                 123         123            123      
      cl B.2 patients (all arms)               84           84             84      
      cl B.2 events (this arm)                 37           38             48      
      cl B.2 patients (this arm)               27           27             30      
      ASIAN events (all arms)                  123         123            123      
      ASIAN patients (all arms)                84           84             84      
      ASIAN patients (all arms) - alt df       208         208            208      
      ASIAN events (this arms)                 37           38             48      
      ASIAN patients (this arms)               27           27             30      
      ASIAN patients (this arms) - alt df      68           67             73      
WHITE                                                                              
  cl A.1                                                                           
    dcd A.1.1.1.1                                                                  
      Column N                                 134         134            132      
      facet events                             14           19             13      
      facet patients                            9           14             10      
      facet patients - alt df                  NA           NA             NA      
      dcd A.1.1.1.1 events                     46           46             46      
      dcd A.1.1.1.1 patients                   33           33             33      
      dcd A.1.1.1.1 patients - alt df          NA           NA             NA      
      cl A.1 events (all arms)                 46           46             46      
      cl A.1 patients (all arms)               33           33             33      
      cl A.1 events (this arm)                 14           19             13      
      cl A.1 patients (this arm)                9           14             10      
      WHITE events (all arms)                  46           46             46      
      WHITE patients (all arms)                33           33             33      
      WHITE patients (all arms) - alt df       74           74             74      
      WHITE events (this arms)                 14           19             13      
      WHITE patients (this arms)                9           14             10      
      WHITE patients (this arms) - alt df      27           26             21      </code></pre>
<p>The above table displays the various denominators we might use across
both types of counting discussed in the previous section. Each of these
denominator choices would result in at least one difference in
calculated percent from all other choices across the full table (barring
any coincidental equality between count types in your data). Thus when
programming against a table shell with the ubiquitous “xx (xx.x%)”
family of formats, we must <strong>carefully choose an afun which
calculates the <em>correct type of percent</em></strong>.</p>
<p>Many existing analysis functions provided by production libraries
such as <code>tern</code> and <code>junco</code> support different
denominator options for use when calculating percents out of the box,
though they do not all support the full breadth of variety explored
above. Nonetheless, careful consideration of the existing analysis
functions available to you and what they support should be made before
choosing to create a custom one.</p>
</div>
</div>
<div class="section level2">
<h2 id="yeah-but-what-if-conditionality-in-afuns">“Yeah But What If” … Conditionality In <code>afun</code>s<a class="anchor" aria-label="anchor" href="#yeah-but-what-if-conditionality-in-afuns"></a>
</h2>
<p>While many tables call for analysis functions which perform identical
calculations across all facets they are applied within, this is
<strong>not</strong> a requirement of the <code>rtables</code>
framework. In this vignette we will not discuss the <em>creation</em> of
analysis functions which support creating facet-conditional cell values;
rather we will discuss <em>identifying</em> when such analysis functions
are required, leaving the implementation of <code>afun</code>s with
complex behavior to advanced portion(s) of this tour.</p>
<div class="section level3">
<h3 id="conditionality-based-on-column-facet">Conditionality Based On Column Facet<a class="anchor" aria-label="anchor" href="#conditionality-based-on-column-facet"></a>
</h3>
<p>In point of fact, we saw conditionality on the current column in the
<a href="./guided_intermediate_translating_shells.html">previous
vignette</a> when translating shells with risk difference columns; there
the dummy <code>afun</code> we used calculated count-percent values for
facets in the “main portion” of the table and displayed a custom string
for facets in the risk difference portion. In real tables that string
would be replaced with actual risk difference calculations, of course,
but the conditionality itself is the same.</p>
<p>Generally speaking, <code>afun</code>s we use will need this type of
column-facet conditionality any time we have a <em>heterogeneous column
structure</em> (i.e., any time we have non-nested column faceting in our
layout). In these cases analysts will need to use <code>afuns</code>
specifically designed to support the specific type of column structure
their layout declares.</p>
<p>There is not currently a production-ready way to combine
<code>afun</code>s into a single function and declare the conditions
under which each should be used, though we we will explore this as an
exercise in the advanced portion of this tour.</p>
</div>
<div class="section level3">
<h3 id="conditionality-based-on-row-facet">Conditionality Based On Row Facet<a class="anchor" aria-label="anchor" href="#conditionality-based-on-row-facet"></a>
</h3>
<p>Unlike column-conditional <code>afun</code>s, purely row-conditional
<code>afun</code>s do not generate rows which have values with different
meanings for different cells in the row. Rather, row-conditionality
manifests as different row facets containing different numbers of rows
and/or entire rows or sets of rows with different types of content based
on the current row facet.</p>
<p>A common example of a shell with different numbers of rows depending
on the row facet is one summarizing patient visits
(<code>AVISIT</code>). In such tables, the row facet for the initial or
<code>BASELINE</code> visit will often have only a subset of those in
the other facets, as those will contain comparisons to the baseline
visit.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">avisit_afun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">.var</span>, <span class="va">.spl_context</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">cur_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/head_tail.html">tail</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Patient DIABP"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">pardf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/head_tail.html">head</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">full_parent_df</span>, <span class="fl">1</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">cur_visit</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SCREENING"</span>, <span class="st">"BASELINE"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">pardf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pardf</span>, <span class="va">AVISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BASELINE"</span>, <span class="va">cur_visit</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">difs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pardf</span><span class="op">)</span><span class="op">)</span>, <span class="va">pardf</span><span class="op">$</span><span class="va">USUBJID</span>,</span>
<span>      <span class="kw">function</span><span class="op">(</span><span class="va">iis</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">avalvec</span> <span class="op">&lt;-</span> <span class="va">pardf</span><span class="op">$</span><span class="va">AVAL</span><span class="op">[</span><span class="va">iis</span><span class="op">]</span></span>
<span>        <span class="va">bl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">pardf</span><span class="op">[</span><span class="va">iis</span>, <span class="op">]</span><span class="op">$</span><span class="va">AVISIT</span><span class="op">)</span> <span class="op">==</span> <span class="st">"BASELINE"</span><span class="op">)</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">avalvec</span><span class="op">[</span><span class="op">-</span><span class="va">bl</span><span class="op">]</span> <span class="op">-</span> <span class="va">avalvec</span><span class="op">[</span><span class="va">bl</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vals</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Diff From Patient's Baseline DIABP"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">difs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/in_rows.html">in_rows</a></span><span class="op">(</span>.list <span class="op">=</span> <span class="va">vals</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can see this behavior using a basic row-conditional
<code>afun</code> (defined above for those curious):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lyt_rowcond</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AVISIT"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"AVAL"</span>, <span class="va">avisit_afun</span>, format <span class="op">=</span> <span class="st">"xx.xx"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt_rowcond</span>, <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">ex_advs</span>, <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"DIABP"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>                                            all obs
———————————————————————————————————————————————————
SCREENING                                          
  Mean Patient DIABP                         50.30 
BASELINE                                           
  Mean Patient DIABP                         50.04 
WEEK 1 DAY 8                                       
  Mean Patient DIABP                         49.60 
  Mean Diff From Patient's Baseline DIABP    -0.44 
WEEK 2 DAY 15                                      
  Mean Patient DIABP                         50.18 
  Mean Diff From Patient's Baseline DIABP    0.13  
WEEK 3 DAY 22                                      
  Mean Patient DIABP                         49.92 
  Mean Diff From Patient's Baseline DIABP    -0.13 
WEEK 4 DAY 29                                      
  Mean Patient DIABP                         49.80 
  Mean Diff From Patient's Baseline DIABP    -0.24 
WEEK 5 DAY 36                                      
  Mean Patient DIABP                         49.34 
  Mean Diff From Patient's Baseline DIABP    -0.70 </code></pre>
<p>In the above table, we display only the mean of the measurement for
that visit (simulated <code>DIABP</code> in this case) for the
<code>SCREENING</code> and <code>BASELINE</code> visits, while we
additionally display the mean of the per-patient difference between
their values for that visit and their baseline visit for follow-up
visits.</p>
</div>
<div class="section level3">
<h3 id="why-not-both">Why Not Both?<a class="anchor" aria-label="anchor" href="#why-not-both"></a>
</h3>
<p>It is important to note that while we described row- and column-facet
conditionality separately in this section, an <code>afun</code> can be
both simultaneously. In fact an <code>afun</code>’s column
conditionality can itself be dependent on which row facet it is in.</p>
<p>The most straightforward example of this type of “dual
conditionality” is when we have heterogeneous column structure, but the
additional columns should only be populated for some portions of the
table and left blank for others.</p>
<p>For this example we repeat the same data preparation as in the Risk
Difference Columns section <a href="./guided_intermediate_translating_shells.html">in the previous
chapter</a> without further comment.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">advs</span> <span class="op">&lt;-</span> <span class="va">ex_advs</span></span>
<span><span class="va">advs</span><span class="op">$</span><span class="va">span_label</span> <span class="op">&lt;-</span> <span class="st">"Active Treatment"</span></span>
<span><span class="va">advs</span><span class="op">$</span><span class="va">span_label</span><span class="op">[</span><span class="va">advs</span><span class="op">$</span><span class="va">ARM</span> <span class="op">==</span> <span class="st">"B: Placebo"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">" "</span></span>
<span></span>
<span><span class="va">span_label_map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">span_label</span>, <span class="op">~</span><span class="va">ARM</span>,</span>
<span>  <span class="st">"Active Treatment"</span>, <span class="st">"A: Drug X"</span>,</span>
<span>  <span class="st">"Active Treatment"</span>, <span class="st">"C: Combination"</span>,</span>
<span>  <span class="st">" "</span>, <span class="st">"B: Placebo"</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">advs</span><span class="op">$</span><span class="va">rr_header</span> <span class="op">&lt;-</span> <span class="st">"Risk Differences"</span></span>
<span><span class="va">advs</span><span class="op">$</span><span class="va">rr_label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">advs</span><span class="op">$</span><span class="va">ARM</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span>, <span class="st">"vs B"</span><span class="op">)</span></span></code></pre></div>
<p>We can then define an afun which populates the “risk difference”
columns only for follow up visits and leaves them blank otherwise:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">in_risk_diff</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spl_context</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Risk Differences"</span>, <span class="va">spl_context</span><span class="op">$</span><span class="va">cur_col_id</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">avisit_afun2</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">.var</span>, <span class="va">.spl_context</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">in_rd</span> <span class="op">&lt;-</span> <span class="fu">in_risk_diff</span><span class="op">(</span><span class="va">.spl_context</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">cur_visit</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/head_tail.html">tail</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  <span class="va">is_followup</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">cur_visit</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SCREENING"</span>, <span class="st">"BASELINE"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">in_rd</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Patient DIABP"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">.var</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">is_followup</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Patient DIABP"</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Patient DIABP"</span> <span class="op">=</span> <span class="fu"><a href="../reference/rcell.html">rcell</a></span><span class="op">(</span><span class="st">"-"</span>, format <span class="op">=</span> <span class="st">"xx"</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">pardf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/head_tail.html">head</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">full_parent_df</span>, <span class="fl">1</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">is_followup</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">in_rd</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">pardf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">pardf</span>, <span class="va">AVISIT</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BASELINE"</span>, <span class="va">cur_visit</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="va">difs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/tapply.html" class="external-link">tapply</a></span><span class="op">(</span></span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">pardf</span><span class="op">)</span><span class="op">)</span>, <span class="va">pardf</span><span class="op">$</span><span class="va">USUBJID</span>,</span>
<span>        <span class="kw">function</span><span class="op">(</span><span class="va">iis</span><span class="op">)</span> <span class="op">{</span></span>
<span>          <span class="va">avalvec</span> <span class="op">&lt;-</span> <span class="va">pardf</span><span class="op">$</span><span class="va">AVAL</span><span class="op">[</span><span class="va">iis</span><span class="op">]</span></span>
<span>          <span class="va">bl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">pardf</span><span class="op">[</span><span class="va">iis</span>, <span class="op">]</span><span class="op">$</span><span class="va">AVISIT</span><span class="op">)</span> <span class="op">==</span> <span class="st">"BASELINE"</span><span class="op">)</span></span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">avalvec</span><span class="op">[</span><span class="op">-</span><span class="va">bl</span><span class="op">]</span> <span class="op">-</span> <span class="va">avalvec</span><span class="op">[</span><span class="va">bl</span><span class="op">]</span><span class="op">)</span></span>
<span>        <span class="op">}</span></span>
<span>      <span class="op">)</span></span>
<span>      <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vals</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Diff From Baseline"</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">difs</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">armlabel</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/head_tail.html">tail</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">cur_col_split_val</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span>, <span class="fl">1</span><span class="op">)</span> <span class="co"># last split value, ie arm</span></span>
<span>      <span class="va">armletter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substr.html" class="external-link">substr</a></span><span class="op">(</span><span class="va">armlabel</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>      <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">vals</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"Mean Diff From Baseline"</span> <span class="op">=</span> <span class="fu"><a href="../reference/rcell.html">rcell</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">armletter</span>, <span class="st">"vs B"</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"xx"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="fu"><a href="../reference/in_rows.html">in_rows</a></span><span class="op">(</span>.list <span class="op">=</span> <span class="va">vals</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>With that done, we can construct a table that has dual conditionality
in its cell contents.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lyt_fullcond</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"span_label"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/trim_levels_to_map.html">trim_levels_to_map</a></span><span class="op">(</span><span class="va">span_label_map</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span>, show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"rr_header"</span>, nested <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span>, labels_var <span class="op">=</span> <span class="st">"rr_label"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/split_funcs.html">remove_split_levels</a></span><span class="op">(</span><span class="st">"B: Placebo"</span><span class="op">)</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AVISIT"</span><span class="op">)</span> <span class="op">|&gt;</span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"AVAL"</span>, <span class="va">avisit_afun2</span>, format <span class="op">=</span> <span class="st">"xx.xx"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt_fullcond</span>, <span class="fu"><a href="https://rdrr.io/r/base/subset.html" class="external-link">subset</a></span><span class="op">(</span><span class="va">advs</span>, <span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"DIABP"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<pre><code>                                 Active Treatment                                        
                            A: Drug X   C: Combination   B: Placebo    Risk Differences  
                             (N=938)       (N=924)        (N=938)      A vs B     C vs B 
—————————————————————————————————————————————————————————————————————————————————————————
SCREENING                                                                                
  Mean Patient DIABP          49.97         50.19          50.75                         
BASELINE                                                                                 
  Mean Patient DIABP          48.60         51.11          50.44                         
WEEK 1 DAY 8                                                                             
  Mean Patient DIABP          50.26         48.86          49.67         -          -    
  Mean Diff From Baseline     -0.44         -0.44          -0.44       A vs B     C vs B 
WEEK 2 DAY 15                                                                            
  Mean Patient DIABP          50.84         49.98          49.72         -          -    
  Mean Diff From Baseline     0.13           0.13           0.13       A vs B     C vs B 
WEEK 3 DAY 22                                                                            
  Mean Patient DIABP          50.71         49.94          49.09         -          -    
  Mean Diff From Baseline     -0.13         -0.13          -0.13       A vs B     C vs B 
WEEK 4 DAY 29                                                                            
  Mean Patient DIABP          50.07         49.71          49.62         -          -    
  Mean Diff From Baseline     -0.24         -0.24          -0.24       A vs B     C vs B 
WEEK 5 DAY 36                                                                            
  Mean Patient DIABP          50.57         49.09          48.37         -          -    
  Mean Diff From Baseline     -0.70         -0.70          -0.70       A vs B     C vs B </code></pre>
</div>
</div>
<div class="section level2">
<h2 id="a-final-note-on-afun-complexity">A Final Note On <code>afun</code> Complexity<a class="anchor" aria-label="anchor" href="#a-final-note-on-afun-complexity"></a>
</h2>
<p>Many production <code>afun</code>s, such as those provided by
<code>tern</code> or <code>junco</code>, support multiple behaviors that
are controlled user specified arguments (passed via
<code>extra_args</code>). This can be used to control denominator types,
choice of statistical methods, and anything else the developers wish.
This is a separate type of complexity from behavior that is conditional
on column or row structure – and in fact can be combined with such – but
it is nonetheless important to consider when choosing which
<code>afun</code> to use.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>rtables is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../analytics.js"></script></footer>
</div>





  </body>
</html>
