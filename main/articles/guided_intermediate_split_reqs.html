<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en-US">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Intermediate rtables - Identifying Required Faceting Behavior • rtables</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
<link rel="icon" type="”image/svg+xml”" href="../favicon.svg">
<link rel="apple-touch-icon" sizes="180x180" href="../apple-touch-icon.png">
<link rel="icon" sizes="any" href="../favicon.ico">
<link rel="manifest" href="../site.webmanifest">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Intermediate rtables - Identifying Required Faceting Behavior">
<link rel="stylesheet" href="../consent.css">
<script src="../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rtables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.14.9004</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/rtables.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/exploratory_analysis.html">Exploratory Analysis</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Guided Tour</h6></li>
    <li><a class="dropdown-item" href="../articles/guided_intermediate.html">A Guided Tour of rtables - Intermediate</a></li>
    <li><a class="dropdown-item" href="../articles/guided_intermediate_translating_shells.html">Intermediate rtables - Translating Shells To Layouts</a></li>
    <li><a class="dropdown-item" href="../articles/guided_intermediate_afun_reqs.html">Intermediate rtables - Identifying Required Analysis Behavior</a></li>
    <li><a class="dropdown-item" href="../articles/guided_intermediate_split_reqs.html">Intermediate rtables - Identifying Required Faceting Behavior</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Clinical Trials</h6></li>
    <li><a class="dropdown-item" href="../articles/clinical_trials.html">Example Clinical Trials Tables</a></li>
    <li><a class="dropdown-item" href="../articles/baseline.html">Comparing Against Baselines or Control</a></li>
    <li><a class="dropdown-item" href="../articles/ard_how_to.html">Generating QC-Ready Result Data Frames (ARDs) from Tables</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Table Customization</h6></li>
    <li><a class="dropdown-item" href="../articles/custom_appearance.html">Customizing Appearance</a></li>
    <li><a class="dropdown-item" href="../articles/title_footer.html">Titles, Footers, and Referential Footnotes</a></li>
    <li><a class="dropdown-item" href="../articles/sorting_pruning.html">Pruning and Sorting Tables</a></li>
    <li><a class="dropdown-item" href="../articles/col_counts.html">Column Counts and Formats</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-developer-guide" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Developer Guide</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-developer-guide">
<li><a class="dropdown-item" href="../articles/dev-guide/dg_split_machinery.html">Split Machinery</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_tabulation.html">Tabulation</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_table_hierarchy.html">Table Hierarchy</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_debug_rtables.html">Debugging in {rtables} and Beyond</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_notes.html">Sparse Notes on {rtables} Internals</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report-non-cran/">Non-CRAN unit test report</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/insightsengineering/rtables"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.svg" class="logo" alt=""><h1>Intermediate rtables - Identifying Required Faceting Behavior</h1>
            <h3 data-toc-skip class="subtitle">Contributed by Johnson
&amp; Johnson Innovative Medicine</h3>
                        <h4 data-toc-skip class="author">Gabriel
Becker</h4>
                        <h4 data-toc-skip class="author">Dan
Hofstaedter</h4>
            
            <h4 data-toc-skip class="date">2025-10-22</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/rtables/blob/main/vignettes/guided_intermediate_split_reqs.Rmd" class="external-link"><code>vignettes/guided_intermediate_split_reqs.Rmd</code></a></small>
      <div class="d-none name"><code>guided_intermediate_split_reqs.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p><code>rtables</code> supports <em>generalized</em> faceting when
declaring row and column structure. In particular it, allows faceting
behavior to deviate from that seen in e.g., <code>ggplot2</code>
faceting support in four crucial ways often required for tables:</p>
<ol style="list-style-type: decimal">
<li>Facets need not be mutually exclusive,</li>
<li>Facets need not be exhaustive,</li>
<li>Nested faceting behavior can depend on the parent facet it occurs
within, and</li>
<li>Facets can be created that do not reflect a single categorical value
in the data.</li>
</ol>
<p>While this flexibility provides a cornerstone to
<code>rtables</code>’ power - alongside the flexibility of analysis
functions discussed in the previous chapter - it also means we must
actively think about faceting when creating table layouts in a way
simply not required of users of <code>facet_grid</code> in
<code>ggplot2</code>.</p>
<p>In this chapter we will cover identifying which aspects of a shell or
desired table should be achieved by specifying the correct split
function(s) in the layout. As with the previous chapter’s handling of
analysis behavior, we will leave <em>implementation</em> of fully custom
split functions for the advanced portion of this guide and focus solely
on the identification of required behavior to prepare users to choose
between a selection of pre-existing non-default split functions
available to them.</p>
</div>
<div class="section level2">
<h2 id="a-brief-review">A Brief Review<a class="anchor" aria-label="anchor" href="#a-brief-review"></a>
</h2>
<p>Faceting serves three purposes within the <code>rtables</code>
layouting framework. It declares</p>
<ol style="list-style-type: decimal">
<li>The row- and column-labeling when the table is rendered,</li>
<li>The organization of the sets of cells that will make up the table’s
body, and</li>
<li>The data to be analyzed when calculating contents for each set of
cells in the table.</li>
</ol>
<p>In particular, (3) means that the data passed to analysis functions
is the intersection of the data associated with the row- and
column-facets that define the location of the cell(s) whose contents are
being calculated.</p>
<p><code>rtables</code> is designed such that data should not need to be
duplicated, nor .e.g, levels of a factor, restricted in the dataset
prior to calling <code>build_table</code>. Things like adding
combination levels and restricting or reordering factor levels are all
declared via faceting in the layout and then performed automatically by
the internal <code>rtables</code> machinery during table creation.</p>
<div class="section level3">
<h3 id="split-function-basics">Split Function Basics<a class="anchor" aria-label="anchor" href="#split-function-basics"></a>
</h3>
<p>We will leave a detailed technical discussion of how split functions
work for when we implement our own custom split functions in the
advanced portion of this guide. For our purposes here, it suffices to
consider a split function to be a mapping from an incoming dataset (the
data associated with the parent facet) to a set of one or more facets,
each of which are associated with (sub)sets of that incoming data.</p>
</div>
<div class="section level3">
<h3 id="default-faceting">Default Faceting<a class="anchor" aria-label="anchor" href="#default-faceting"></a>
</h3>
<p>By default, faceting instructions:</p>
<ol style="list-style-type: decimal">
<li>Declare facets based on a <em>partition</em> of incoming data
defined by a categorical variable, and</li>
<li>Nest within previously declared instructions in the same dimension
(row/column).</li>
</ol>
<p>The above behaviors combine to mean that sequential faceting
instructions (i.e., repeated calls to <code>split_cols_by</code> or
<code>split_rows_by</code>) result in <em>full factorial faceting</em>,
where each combination of levels from the variables faceted on is
represented.</p>
<p>This is true with column faceting:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>lyt <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"ARM"</span>) <span class="sc">|&gt;</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"SEX"</span>)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">build_table</span>(lyt, ex_adsl)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a>            A<span class="sc">:</span> Drug X                      B<span class="sc">:</span> Placebo                   C<span class="sc">:</span> Combination       </span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a>   F   M   U   UNDIFFERENTIATED   F   M   U   UNDIFFERENTIATED   F   M   U   UNDIFFERENTIATED</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a>—————————————————————————————————————————————————————————————————————————————————————————————</span></code></pre></div>
<p>as well as with row faceting, with the caveat that row faceting does
not generate individual rows, and thus an analyze call is required:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>lyt2 <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"STRATA1"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"BMRKR2"</span>) <span class="sc">|&gt;</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"AGE"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a><span class="fu">build_table</span>(lyt2, ex_adsl)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>           all obs</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a>——————————————————</span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a>A                 </span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a>  LOW             </span>
<span id="cb2-11"><a href="#cb2-11" tabindex="-1"></a>    Mean    <span class="fl">34.67</span> </span>
<span id="cb2-12"><a href="#cb2-12" tabindex="-1"></a>  MEDIUM          </span>
<span id="cb2-13"><a href="#cb2-13" tabindex="-1"></a>    Mean    <span class="fl">34.35</span> </span>
<span id="cb2-14"><a href="#cb2-14" tabindex="-1"></a>  HIGH            </span>
<span id="cb2-15"><a href="#cb2-15" tabindex="-1"></a>    Mean    <span class="fl">33.52</span> </span>
<span id="cb2-16"><a href="#cb2-16" tabindex="-1"></a>B                 </span>
<span id="cb2-17"><a href="#cb2-17" tabindex="-1"></a>  LOW             </span>
<span id="cb2-18"><a href="#cb2-18" tabindex="-1"></a>    Mean    <span class="fl">33.40</span> </span>
<span id="cb2-19"><a href="#cb2-19" tabindex="-1"></a>  MEDIUM          </span>
<span id="cb2-20"><a href="#cb2-20" tabindex="-1"></a>    Mean    <span class="fl">34.47</span> </span>
<span id="cb2-21"><a href="#cb2-21" tabindex="-1"></a>  HIGH            </span>
<span id="cb2-22"><a href="#cb2-22" tabindex="-1"></a>    Mean    <span class="fl">38.38</span> </span>
<span id="cb2-23"><a href="#cb2-23" tabindex="-1"></a>C                 </span>
<span id="cb2-24"><a href="#cb2-24" tabindex="-1"></a>  LOW             </span>
<span id="cb2-25"><a href="#cb2-25" tabindex="-1"></a>    Mean    <span class="fl">34.33</span> </span>
<span id="cb2-26"><a href="#cb2-26" tabindex="-1"></a>  MEDIUM          </span>
<span id="cb2-27"><a href="#cb2-27" tabindex="-1"></a>    Mean    <span class="fl">34.75</span> </span>
<span id="cb2-28"><a href="#cb2-28" tabindex="-1"></a>  HIGH            </span>
<span id="cb2-29"><a href="#cb2-29" tabindex="-1"></a>    Mean    <span class="fl">35.96</span> </span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="recognizing-non-full-factorial-faceting">Recognizing Non-Full-Factorial Faceting<a class="anchor" aria-label="anchor" href="#recognizing-non-full-factorial-faceting"></a>
</h2>
<p>Any time we need faceting that does not represent a full factorial
combination of one or more variables (i.e., the full set of combinations
of levels from those variables), we will need to use split functions to
declare our desired structure.</p>
<p>The key, then, is to carefully consider how our desired faceting
structure deviates from the full factorial structure that default
faceting would generate. This will tell us what behaviors we need from
our split functions.</p>
<div class="section level3">
<h3 id="excluding-factor-levels">Excluding Factor Levels<a class="anchor" aria-label="anchor" href="#excluding-factor-levels"></a>
</h3>
<p>The simplest deviation from full-factorial faceting is to omit some
levels when faceting based on a single categorical variable. This can
come in two flavors:</p>
<ol style="list-style-type: decimal">
<li>Prescriptive - when the level(s) to be omitted are set a
priori,</li>
<li>Empirical - when the level(s) to be omitted depend on the data.</li>
</ol>
<p>Prescriptively omitting levels(/facets) is fairly straightforward:
you have a set of levels that, for whatever reason, you do not want
facets for in the resulting table. <code>rtables</code> provides the
<code>remove_split_levels</code> to create split functions which achieve
this.</p>
<p>Empirically omitting levels(/facets) is more open ended, as
technically the logic determining what should be omitted can be
completely arbitrary. The most common version, however, is to omit
unobserved levels (which would result in facets whose associated data
subset is empty); the <code>drop_split_levels</code> split function does
this.</p>
<p>We will use a slightly modified version of our synthetic data to
illustrate the difference:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a>adsl <span class="ot">&lt;-</span> <span class="fu">subset</span>(ex_adsl, <span class="fu">as.character</span>(SEX) <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"F"</span>, <span class="st">"M"</span>, <span class="st">"U"</span>))</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">qtable</span>(adsl, <span class="at">col_vars =</span> <span class="st">"SEX"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>           F         M        U     UNDIFFERENTIATED</span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>        (<span class="at">N=</span><span class="dv">222</span>)   (<span class="at">N=</span><span class="dv">166</span>)   (<span class="at">N=</span><span class="dv">9</span>)        (<span class="at">N=</span><span class="dv">0</span>)      </span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>————————————————————————————————————————————————————</span>
<span id="cb3-6"><a href="#cb3-6" tabindex="-1"></a>count     <span class="dv">222</span>       <span class="dv">166</span>       <span class="dv">9</span>            <span class="dv">0</span>        </span></code></pre></div>
<p>First we declare faceting that omits the (rare but observed)
<code>"U"</code> level using <code>remove_split_levels</code>.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a>lyt_pre <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb4-2"><a href="#cb4-2" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"SEX"</span>, <span class="at">split_fun =</span> <span class="fu">remove_split_levels</span>(<span class="st">"U"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb4-3"><a href="#cb4-3" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"STRATA1"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" tabindex="-1"></a></span>
<span id="cb4-5"><a href="#cb4-5" tabindex="-1"></a><span class="fu">build_table</span>(lyt_pre, adsl)</span>
<span id="cb4-6"><a href="#cb4-6" tabindex="-1"></a>    F    M    UNDIFFERENTIATED</span>
<span id="cb4-7"><a href="#cb4-7" tabindex="-1"></a>——————————————————————————————</span>
<span id="cb4-8"><a href="#cb4-8" tabindex="-1"></a>A   <span class="dv">63</span>   <span class="dv">55</span>          <span class="dv">0</span>        </span>
<span id="cb4-9"><a href="#cb4-9" tabindex="-1"></a>B   <span class="dv">73</span>   <span class="dv">59</span>          <span class="dv">0</span>        </span>
<span id="cb4-10"><a href="#cb4-10" tabindex="-1"></a>C   <span class="dv">86</span>   <span class="dv">52</span>          <span class="dv">0</span>        </span></code></pre></div>
<p>Next we will use <code>drop_split_levels</code>:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a>lyt_emp <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"SEX"</span>, <span class="at">split_fun =</span> drop_split_levels) <span class="sc">|&gt;</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"STRATA1"</span>)</span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a></span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a><span class="fu">build_table</span>(lyt_emp, adsl)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a>    F    M    U</span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a>———————————————</span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a>A   <span class="dv">63</span>   <span class="dv">55</span>   <span class="dv">3</span></span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a>B   <span class="dv">73</span>   <span class="dv">59</span>   <span class="dv">3</span></span>
<span id="cb5-10"><a href="#cb5-10" tabindex="-1"></a>C   <span class="dv">86</span>   <span class="dv">52</span>   <span class="dv">3</span></span></code></pre></div>
<p>Here we get exactly – and only – facets for the levels of
<code>SEX</code> observed in the data.</p>
<p>It is important to note that <code>drop_split_levels</code> omits
facets for levels not observed <strong><em>in the incoming
data</em></strong> which is the data for the parent facet. This only
translates to the full data being tabulated in cases of top level
faceting (not nested within anything) and other special cases.</p>
<p>We can see this if we nest faceting using the empirical
<code>drop_split_levels</code> within another faceting instruction:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>lyt_bad_emp <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"ARM"</span>) <span class="sc">|&gt;</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"RACE"</span>, <span class="at">split_fun =</span> drop_split_levels) <span class="sc">|&gt;</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"SEX"</span>, <span class="at">split_fun =</span> drop_split_levels) <span class="sc">|&gt;</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"AGE"</span>)</span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a><span class="fu">build_table</span>(lyt_bad_emp, adsl)</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>                                            A<span class="sc">:</span> Drug X   B<span class="sc">:</span> Placebo   C<span class="sc">:</span> Combination</span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>———————————————————————————————————————————————————————————————————————————————————</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>ASIAN                                                                              </span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  F                                                                                </span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>    Mean                                      <span class="fl">31.22</span>       <span class="fl">35.06</span>          <span class="fl">36.44</span>     </span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  M                                                                                </span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>    Mean                                      <span class="fl">34.60</span>       <span class="fl">38.63</span>          <span class="fl">37.66</span>     </span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>  U                                                                                </span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>    Mean                                      <span class="fl">33.50</span>       <span class="fl">35.00</span>          <span class="fl">34.50</span>     </span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>BLACK OR AFRICAN AMERICAN                                                          </span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  F                                                                                </span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>    Mean                                      <span class="fl">34.06</span>       <span class="fl">33.88</span>          <span class="fl">33.21</span>     </span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  M                                                                                </span>
<span id="cb6-21"><a href="#cb6-21" tabindex="-1"></a>    Mean                                      <span class="fl">34.58</span>       <span class="fl">36.33</span>          <span class="fl">34.21</span>     </span>
<span id="cb6-22"><a href="#cb6-22" tabindex="-1"></a>  U                                                                                </span>
<span id="cb6-23"><a href="#cb6-23" tabindex="-1"></a>    Mean                                       <span class="cn">NA</span>           <span class="cn">NA</span>           <span class="fl">36.00</span>     </span>
<span id="cb6-24"><a href="#cb6-24" tabindex="-1"></a>WHITE                                                                              </span>
<span id="cb6-25"><a href="#cb6-25" tabindex="-1"></a>  F                                                                                </span>
<span id="cb6-26"><a href="#cb6-26" tabindex="-1"></a>    Mean                                      <span class="fl">34.12</span>       <span class="fl">32.41</span>          <span class="fl">33.00</span>     </span>
<span id="cb6-27"><a href="#cb6-27" tabindex="-1"></a>  M                                                                                </span>
<span id="cb6-28"><a href="#cb6-28" tabindex="-1"></a>    Mean                                      <span class="fl">40.00</span>       <span class="fl">34.62</span>          <span class="fl">30.80</span>     </span>
<span id="cb6-29"><a href="#cb6-29" tabindex="-1"></a>  U                                                                                </span>
<span id="cb6-30"><a href="#cb6-30" tabindex="-1"></a>    Mean                                      <span class="fl">28.00</span>       <span class="fl">27.00</span>            <span class="cn">NA</span>      </span>
<span id="cb6-31"><a href="#cb6-31" tabindex="-1"></a>AMERICAN INDIAN OR ALASKA NATIVE                                                   </span>
<span id="cb6-32"><a href="#cb6-32" tabindex="-1"></a>  F                                                                                </span>
<span id="cb6-33"><a href="#cb6-33" tabindex="-1"></a>    Mean                                      <span class="fl">38.33</span>       <span class="fl">34.86</span>          <span class="fl">37.00</span>     </span>
<span id="cb6-34"><a href="#cb6-34" tabindex="-1"></a>  M                                                                                </span>
<span id="cb6-35"><a href="#cb6-35" tabindex="-1"></a>    Mean                                      <span class="fl">34.80</span>       <span class="fl">33.50</span>          <span class="fl">32.75</span>     </span>
<span id="cb6-36"><a href="#cb6-36" tabindex="-1"></a>MULTIPLE                                                                           </span>
<span id="cb6-37"><a href="#cb6-37" tabindex="-1"></a>  M                                                                                </span>
<span id="cb6-38"><a href="#cb6-38" tabindex="-1"></a>    Mean                                       <span class="cn">NA</span>         <span class="fl">53.00</span>            <span class="cn">NA</span>      </span>
<span id="cb6-39"><a href="#cb6-39" tabindex="-1"></a>NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER                                          </span>
<span id="cb6-40"><a href="#cb6-40" tabindex="-1"></a>  F                                                                                </span>
<span id="cb6-41"><a href="#cb6-41" tabindex="-1"></a>    Mean                                       <span class="cn">NA</span>         <span class="fl">28.00</span>            <span class="cn">NA</span>      </span></code></pre></div>
<p>Here we see that different sets of <code>SEX</code> facets are
generated within different <code>RACE</code> facets, with the
<code>"MULTIPLE"</code> and
<code>"NATIVE HAWAIIAN OR OTHER PACIFIC ISLANDER"</code> races each
having only a (different) single facet. This is sometimes the desired
behavior, but often it is not so care should be used with
<code>drop_split_levels</code> in non-trivial faceting structures.</p>
</div>
<div class="section level3">
<h3 id="adding-combination-levels">Adding Combination Levels<a class="anchor" aria-label="anchor" href="#adding-combination-levels"></a>
</h3>
<p>Some shells call for levels to be combined into new virtual levels.
For example, we might need an “All Drug X” category in our table which
represents both arms A (<code>"A: Drug X") and C (</code>“C:
Combination”`) as a single group of patients, either in addition to or
instead of those individual arms.</p>
<p>As with omitting defined factor levels, this is a deviation from the
default full factorial behavior. In this case we want a facet for a
level not present in the data and (assuming the individual arms are left
in alongside our combination arm) our desired facets are not mutually
exclusive.</p>
<p><code>rtables</code> provides the <code>add_combo_levels</code> split
function to directly invoke this behavior. It takes a “combination
data.frame” that declares the combination levels to add.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a>combodf <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>  <span class="sc">~</span>valname, <span class="sc">~</span>label, <span class="sc">~</span>levelcombo, <span class="sc">~</span>exargs,</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>  <span class="st">"A_C"</span>, <span class="st">"Arms A+C"</span>, <span class="fu">c</span>(<span class="st">"A: Drug X"</span>, <span class="st">"C: Combination"</span>), <span class="fu">list</span>()</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>)</span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>lyt_combo1 <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"ARM"</span>, <span class="at">split_fun =</span> <span class="fu">add_combo_levels</span>(combodf), <span class="at">show_colcounts =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a><span class="fu">build_table</span>(lyt_combo1, ex_adsl)</span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>   A<span class="sc">:</span> Drug X   B<span class="sc">:</span> Placebo   C<span class="sc">:</span> Combination   Arms A<span class="sc">+</span>C</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>    (<span class="at">N=</span><span class="dv">134</span>)     (<span class="at">N=</span><span class="dv">134</span>)        (<span class="at">N=</span><span class="dv">132</span>)       (<span class="at">N=</span><span class="dv">266</span>) </span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>—————————————————————————————————————————————————————</span></code></pre></div>
</div>
<div class="section level3">
<h3 id="nested-faceting-on-non-independent-variables">Nested Faceting On Non-Independent Variables<a class="anchor" aria-label="anchor" href="#nested-faceting-on-non-independent-variables"></a>
</h3>
<p>Often times when performing nested faceting, the inner variable
represents the same information as the outer variable in more detail.
Another way to view this is that the information represented by the
outer variable is implicitly included (or embedded) within the
information for the inner variable. When this occurs, most combinations
of levels from the pair of variables are not logically consistent, can
never occur in practice, and most importantly, should not be represented
in our resulting table. Whenever this is the case, we cannot rely on the
default splitting behavior.</p>
<p>An ubiquitous example of this in clinical trials are the System Organ
Class (<code>AESOC</code>) and Preferred Term (<code>AEDECOD</code>)
variables used when describing adverse events. <code>AESOC</code>
represents the broad category an adverse events falls within (e.g.,
“SKELETOMUSCULAR” or “GASTROINTESTINAL”) while <code>AEDECOD</code>
represents the specific type of adverse-event (“BACK PAIN”, “VOMITING”).
In this example, the combination of <code>AESOC</code> being
<code>"SKELETOMUSCULAR"</code> while <code>AEDECOD</code> is
<code>"VOMITING"</code>. In our alternate framing we would say that the
<code>AEDECOD</code> value <code>"VOMITING"</code> implies that
<code>AESOC</code> <em>must</em> be <code>"SKELETOMUSCULAR"</code>.</p>
<p>Note that our synthetic data does not contain realistic values for
<code>AESOC</code> and <code>AEDECOD</code>, but rather values of the
form <code>"cl X</code>” (with X a capital letter) and
<code>"dcd X.m.n.o.p"</code> with m-p individual digits, respectively.
Note this makes the information embedding even more explicit, as the X
is the same between values of <code>AESOC</code> and the values of
<code>AEDECOD</code> they apply to.</p>
<p>As with omitting facets within a single faceting instruction, there
are broadly two ways to approach this type of nested faceting:</p>
<ol style="list-style-type: decimal">
<li>Prescriptively, and</li>
<li>Empirically.</li>
</ol>
<p>In both cases, we can think about this in terms of <em>pairs of
levels we want to represent in our table</em>. The goal here is to
preemptively omit pairs which are not logically consistent (and thus
which we can assume have no observations in the data).</p>
<p>The empirical approach assumes that either:</p>
<ul>
<li>All valid pairs of levels have at least one observation, or</li>
<li>we want to display <em>only</em> observed pairs, omitting any valid
unobserved pairs.</li>
</ul>
<p>To this end, <code>rtables</code> provides the
<code>trim_levels_in_group</code> split function factory, which, for
each observed level in variable being split, levels of a declared
<code>inner_var</code> are restricted to those observed <em>in
combination to that level of the split variable</em>. When we then split
on or analyze the inner variable, we get a table that contains only the
observed pairs:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a>lyt_tig <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"AESOC"</span>, <span class="at">split_fun =</span> <span class="fu">trim_levels_in_group</span>(<span class="st">"AEDECOD"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"AEDECOD"</span>)</span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a></span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a><span class="fu">build_table</span>(lyt_tig, ex_adae)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>                  all obs</span>
<span id="cb8-7"><a href="#cb8-7" tabindex="-1"></a>—————————————————————————</span>
<span id="cb8-8"><a href="#cb8-8" tabindex="-1"></a>cl A                     </span>
<span id="cb8-9"><a href="#cb8-9" tabindex="-1"></a>  dcd A.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>     <span class="dv">214</span>  </span>
<span id="cb8-10"><a href="#cb8-10" tabindex="-1"></a>  dcd A.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.2</span>     <span class="dv">208</span>  </span>
<span id="cb8-11"><a href="#cb8-11" tabindex="-1"></a>cl B                     </span>
<span id="cb8-12"><a href="#cb8-12" tabindex="-1"></a>  dcd B.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>     <span class="dv">178</span>  </span>
<span id="cb8-13"><a href="#cb8-13" tabindex="-1"></a>  dcd B.<span class="dv">2</span>.<span class="dv">1</span>.<span class="fl">2.1</span>     <span class="dv">193</span>  </span>
<span id="cb8-14"><a href="#cb8-14" tabindex="-1"></a>  dcd B.<span class="dv">2</span>.<span class="dv">2</span>.<span class="fl">3.1</span>     <span class="dv">217</span>  </span>
<span id="cb8-15"><a href="#cb8-15" tabindex="-1"></a>cl C                     </span>
<span id="cb8-16"><a href="#cb8-16" tabindex="-1"></a>  dcd C.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.3</span>     <span class="dv">182</span>  </span>
<span id="cb8-17"><a href="#cb8-17" tabindex="-1"></a>  dcd C.<span class="dv">2</span>.<span class="dv">1</span>.<span class="fl">2.1</span>     <span class="dv">166</span>  </span>
<span id="cb8-18"><a href="#cb8-18" tabindex="-1"></a>cl D                     </span>
<span id="cb8-19"><a href="#cb8-19" tabindex="-1"></a>  dcd D.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>     <span class="dv">183</span>  </span>
<span id="cb8-20"><a href="#cb8-20" tabindex="-1"></a>  dcd D.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">4.2</span>     <span class="dv">185</span>  </span>
<span id="cb8-21"><a href="#cb8-21" tabindex="-1"></a>  dcd D.<span class="dv">2</span>.<span class="dv">1</span>.<span class="fl">5.3</span>     <span class="dv">208</span>  </span></code></pre></div>
<p><code>trim_levels_in_group</code> can be used in chains to further
restrict the displayed combinations of more than two variables, if
desired:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>lyt_tig2 <span class="ot">&lt;-</span> <span class="fu">basic_table</span>(<span class="at">title =</span> <span class="st">"Observed Toxicity Grades"</span>) <span class="sc">|&gt;</span></span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"AESOC"</span>, <span class="at">split_fun =</span> <span class="fu">trim_levels_in_group</span>(<span class="st">"AEDECOD"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"AEDECOD"</span>, <span class="at">split_fun =</span> <span class="fu">trim_levels_in_group</span>(<span class="st">"AETOXGR"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb9-4"><a href="#cb9-4" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"AETOXGR"</span>)</span>
<span id="cb9-5"><a href="#cb9-5" tabindex="-1"></a></span>
<span id="cb9-6"><a href="#cb9-6" tabindex="-1"></a><span class="fu">build_table</span>(lyt_tig2, ex_adae)</span>
<span id="cb9-7"><a href="#cb9-7" tabindex="-1"></a>Observed Toxicity Grades</span>
<span id="cb9-8"><a href="#cb9-8" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" tabindex="-1"></a>—————————————————————————</span>
<span id="cb9-10"><a href="#cb9-10" tabindex="-1"></a>                  all obs</span>
<span id="cb9-11"><a href="#cb9-11" tabindex="-1"></a>—————————————————————————</span>
<span id="cb9-12"><a href="#cb9-12" tabindex="-1"></a>cl A                     </span>
<span id="cb9-13"><a href="#cb9-13" tabindex="-1"></a>  dcd A.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>          </span>
<span id="cb9-14"><a href="#cb9-14" tabindex="-1"></a>    <span class="dv">1</span>               <span class="dv">214</span>  </span>
<span id="cb9-15"><a href="#cb9-15" tabindex="-1"></a>  dcd A.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.2</span>          </span>
<span id="cb9-16"><a href="#cb9-16" tabindex="-1"></a>    <span class="dv">2</span>               <span class="dv">208</span>  </span>
<span id="cb9-17"><a href="#cb9-17" tabindex="-1"></a>cl B                     </span>
<span id="cb9-18"><a href="#cb9-18" tabindex="-1"></a>  dcd B.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>          </span>
<span id="cb9-19"><a href="#cb9-19" tabindex="-1"></a>    <span class="dv">5</span>               <span class="dv">178</span>  </span>
<span id="cb9-20"><a href="#cb9-20" tabindex="-1"></a>  dcd B.<span class="dv">2</span>.<span class="dv">1</span>.<span class="fl">2.1</span>          </span>
<span id="cb9-21"><a href="#cb9-21" tabindex="-1"></a>    <span class="dv">3</span>               <span class="dv">193</span>  </span>
<span id="cb9-22"><a href="#cb9-22" tabindex="-1"></a>  dcd B.<span class="dv">2</span>.<span class="dv">2</span>.<span class="fl">3.1</span>          </span>
<span id="cb9-23"><a href="#cb9-23" tabindex="-1"></a>    <span class="dv">1</span>               <span class="dv">217</span>  </span>
<span id="cb9-24"><a href="#cb9-24" tabindex="-1"></a>cl C                     </span>
<span id="cb9-25"><a href="#cb9-25" tabindex="-1"></a>  dcd C.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.3</span>          </span>
<span id="cb9-26"><a href="#cb9-26" tabindex="-1"></a>    <span class="dv">4</span>               <span class="dv">182</span>  </span>
<span id="cb9-27"><a href="#cb9-27" tabindex="-1"></a>  dcd C.<span class="dv">2</span>.<span class="dv">1</span>.<span class="fl">2.1</span>          </span>
<span id="cb9-28"><a href="#cb9-28" tabindex="-1"></a>    <span class="dv">2</span>               <span class="dv">166</span>  </span>
<span id="cb9-29"><a href="#cb9-29" tabindex="-1"></a>cl D                     </span>
<span id="cb9-30"><a href="#cb9-30" tabindex="-1"></a>  dcd D.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>          </span>
<span id="cb9-31"><a href="#cb9-31" tabindex="-1"></a>    <span class="dv">5</span>               <span class="dv">183</span>  </span>
<span id="cb9-32"><a href="#cb9-32" tabindex="-1"></a>  dcd D.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">4.2</span>          </span>
<span id="cb9-33"><a href="#cb9-33" tabindex="-1"></a>    <span class="dv">3</span>               <span class="dv">185</span>  </span>
<span id="cb9-34"><a href="#cb9-34" tabindex="-1"></a>  dcd D.<span class="dv">2</span>.<span class="dv">1</span>.<span class="fl">5.3</span>          </span>
<span id="cb9-35"><a href="#cb9-35" tabindex="-1"></a>    <span class="dv">1</span>               <span class="dv">208</span>  </span></code></pre></div>
<p>Sometimes the above is the desired behavior; many times, however,
there are certain counts or values which are important to display
<em>even when they are not observed</em>. In such cases, we still want
to omit pairs of levels that are impossible/logically inconsistent, but
cannot rely on which combinations are observed in the data.</p>
<p>In such cases, we must <em>prescriptively</em> declare which
combinations we want to appear in our table. <code>rtables</code>
provides the <code>trim_levels_to_map</code> split function factory for
this, which accepts a pre-defined map of all combinations which should
be included (in the form of a data.frame). Any combinations which do not
appear in the map will be omitted <em>even if they are observed in the
data</em>.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a>map <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>  <span class="sc">~</span>AESOC, <span class="sc">~</span>AEDECOD,</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>  <span class="st">"cl A"</span>, <span class="st">"dcd A.1.1.1.2"</span>,</span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>  <span class="st">"cl B"</span>, <span class="st">"dcd B.1.1.1.1"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>  <span class="st">"cl B"</span>, <span class="st">"dcd B.2.2.3.1"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a>  <span class="st">"cl D"</span>, <span class="st">"dcd D.1.1.1.1"</span></span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a>)</span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>lyt_ttm <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"AESOC"</span>, <span class="at">split_fun =</span> <span class="fu">trim_levels_to_map</span>(map)) <span class="sc">|&gt;</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"AEDECOD"</span>)</span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="fu">build_table</span>(lyt_ttm, ex_adae)</span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>                  all obs</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>—————————————————————————</span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a>cl A                     </span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a>  dcd A.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.2</span>     <span class="dv">208</span>  </span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>cl B                     </span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>  dcd B.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>     <span class="dv">178</span>  </span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a>  dcd B.<span class="dv">2</span>.<span class="dv">2</span>.<span class="fl">3.1</span>     <span class="dv">217</span>  </span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a>cl D                     </span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>  dcd D.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>     <span class="dv">183</span>  </span></code></pre></div>
<p>Note that because there were no pairs in the map with an
<code>AESOC</code> of <code>"cl C"</code>, that entire facet is omitted.
This will be true in the case of nested faceting as well:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a>lyt_ttm2 <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"AESOC"</span>, <span class="at">split_fun =</span> <span class="fu">trim_levels_to_map</span>(map)) <span class="sc">|&gt;</span></span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"AEDECOD"</span>, <span class="at">split_fun =</span> <span class="fu">trim_levels_in_group</span>(<span class="st">"AETOXGR"</span>)) <span class="sc">|&gt;</span></span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="st">"AETOXGR"</span>)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a></span>
<span id="cb11-6"><a href="#cb11-6" tabindex="-1"></a><span class="fu">build_table</span>(lyt_ttm2, ex_adae)</span>
<span id="cb11-7"><a href="#cb11-7" tabindex="-1"></a>                  all obs</span>
<span id="cb11-8"><a href="#cb11-8" tabindex="-1"></a>—————————————————————————</span>
<span id="cb11-9"><a href="#cb11-9" tabindex="-1"></a>cl A                     </span>
<span id="cb11-10"><a href="#cb11-10" tabindex="-1"></a>  dcd A.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.2</span>          </span>
<span id="cb11-11"><a href="#cb11-11" tabindex="-1"></a>    <span class="dv">2</span>               <span class="dv">208</span>  </span>
<span id="cb11-12"><a href="#cb11-12" tabindex="-1"></a>cl B                     </span>
<span id="cb11-13"><a href="#cb11-13" tabindex="-1"></a>  dcd B.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>          </span>
<span id="cb11-14"><a href="#cb11-14" tabindex="-1"></a>    <span class="dv">5</span>               <span class="dv">178</span>  </span>
<span id="cb11-15"><a href="#cb11-15" tabindex="-1"></a>  dcd B.<span class="dv">2</span>.<span class="dv">2</span>.<span class="fl">3.1</span>          </span>
<span id="cb11-16"><a href="#cb11-16" tabindex="-1"></a>    <span class="dv">1</span>               <span class="dv">217</span>  </span>
<span id="cb11-17"><a href="#cb11-17" tabindex="-1"></a>cl D                     </span>
<span id="cb11-18"><a href="#cb11-18" tabindex="-1"></a>  dcd D.<span class="dv">1</span>.<span class="dv">1</span>.<span class="fl">1.1</span>          </span>
<span id="cb11-19"><a href="#cb11-19" tabindex="-1"></a>    <span class="dv">5</span>               <span class="dv">183</span>  </span></code></pre></div>
</div>
<div class="section level3">
<h3 id="facets-that-vary-meaning-instead-of-data-subset">Facets That Vary Meaning Instead of Data Subset<a class="anchor" aria-label="anchor" href="#facets-that-vary-meaning-instead-of-data-subset"></a>
</h3>
<p>In our examples so far, faceting has translated to mapping the
incoming data to a set of distinct (if not necessarily mutually
exclusive or exhaustive) subsets of the data. This is the most common
form of faceting, but it is not the only one <code>rtables</code>
supports.</p>
<p>In some cases, we want facets to be <em>semantically</em> distinct
from each other; in other words, instead of representing different
subsets of the data, we want them to represent different aspects of the
same data. This is most commonly useful column space, where individual
columns are defined via faceting, unlike individual rows.</p>
<p>An toy example of this would be</p>
<pre><code>               A: Drug X          B: Placebo          C: Combination   
           n    mean    sd     n    mean    sd      n    mean      sd  
———————————————————————————————————————————————————————————————————————
F          -     -       -     -     -       -      -      -       -   
  AGE      xx   xx.x   xx.xx   xx   xx.x   xx.xx   xx    xx.x    xx.xx 
  BMRKR1   xx   xx.x   xx.xx   xx   xx.x   xx.xx   xx    xx.x    xx.xx 
M          -     -       -     -     -       -      -      -       -   
  AGE      xx   xx.x   xx.xx   xx   xx.x   xx.xx   xx    xx.x    xx.xx 
  BMRKR1   xx   xx.x   xx.xx   xx   xx.x   xx.xx   xx    xx.x    xx.xx </code></pre>
<p>Here we have individual columns for <strong><em>different statistics
calculated using the same data</em></strong> (<code>n</code>,
<code>mean</code> and <code>sd</code>), within a faceting structure that
splits on arm in column space and gender in row space, and calculated
for two different continuous numeric variables (age and “biomarker 1”
value).</p>
<p>To achieve this, we need faceting that creates three columns all of
whose “subsets” of the incoming (arm) data are identical: all of it. We
can achieve this with the <code>add_combo_levels</code> split function
factory we used above; the key is to use the
<code>select_all_levels</code> sentinel value provided by rtables to
indicate that all levels in the data should be combined when creating
each of our new combination levels.</p>
<p>We will turn on column counts at all levels to show that it is doing
what we want, despite it being redundant and not suitable for any actual
table output.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a>my_combo_df <span class="ot">&lt;-</span> <span class="fu">tribble</span>(</span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>  <span class="sc">~</span>valname, <span class="sc">~</span>label, <span class="sc">~</span>levelcombo, <span class="sc">~</span>exargs,</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a>  <span class="st">"n"</span>, <span class="st">"n"</span>, select_all_levels, <span class="fu">list</span>(),</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a>  <span class="st">"mean"</span>, <span class="st">"mean"</span>, select_all_levels, <span class="fu">list</span>(),</span>
<span id="cb13-5"><a href="#cb13-5" tabindex="-1"></a>  <span class="st">"sd"</span>, <span class="st">"sd"</span>, select_all_levels, <span class="fu">list</span>()</span>
<span id="cb13-6"><a href="#cb13-6" tabindex="-1"></a>)</span>
<span id="cb13-7"><a href="#cb13-7" tabindex="-1"></a></span>
<span id="cb13-8"><a href="#cb13-8" tabindex="-1"></a>lyt_tpose_cols_only <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb13-9"><a href="#cb13-9" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"ARM"</span>, <span class="at">show_colcounts =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb13-10"><a href="#cb13-10" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"STUDYID"</span>,</span>
<span id="cb13-11"><a href="#cb13-11" tabindex="-1"></a>    <span class="at">split_fun =</span> <span class="fu">add_combo_levels</span>(my_combo_df, <span class="at">keep_levels =</span> combo_df<span class="sc">$</span>valname),</span>
<span id="cb13-12"><a href="#cb13-12" tabindex="-1"></a>    <span class="at">show_colcounts =</span> <span class="cn">TRUE</span></span>
<span id="cb13-13"><a href="#cb13-13" tabindex="-1"></a>  )</span>
<span id="cb13-14"><a href="#cb13-14" tabindex="-1"></a></span>
<span id="cb13-15"><a href="#cb13-15" tabindex="-1"></a><span class="fu">build_table</span>(lyt_tpose_cols_only, ex_adsl)</span>
<span id="cb13-16"><a href="#cb13-16" tabindex="-1"></a>            A<span class="sc">:</span> Drug X                    B<span class="sc">:</span> Placebo                  C<span class="sc">:</span> Combination       </span>
<span id="cb13-17"><a href="#cb13-17" tabindex="-1"></a>             (<span class="at">N=</span><span class="dv">134</span>)                       (<span class="at">N=</span><span class="dv">134</span>)                       (<span class="at">N=</span><span class="dv">132</span>)          </span>
<span id="cb13-18"><a href="#cb13-18" tabindex="-1"></a>      n       mean       sd         n       mean       sd         n       mean       sd   </span>
<span id="cb13-19"><a href="#cb13-19" tabindex="-1"></a>   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">132</span>)   (<span class="at">N=</span><span class="dv">132</span>)   (<span class="at">N=</span><span class="dv">132</span>)</span>
<span id="cb13-20"><a href="#cb13-20" tabindex="-1"></a>——————————————————————————————————————————————————————————————————————————————————————————</span></code></pre></div>
<p>We split on study id in the above code largely for convenience. Given
that we are defining combination levels using
<code>select_all_levels</code>, we could split on anything and have each
of the facets represent the entirety of the incoming data. This
approach, however, is a generalization of splitting on study id in order
to create a single facet representing all the incoming data, a trick
worth having in our back pocket.</p>
<p>Thus we’ve achieved the column structure we wanted. Now we need an
analysis function with the correct <em>column-conditional behavior</em>
(see <a href="./guided_intermediate_afun_reqs.html">the previous
chapter</a>) and we will have our output.</p>
<p>Without discussing how we construct it (as that will be covered in
the advanced portion of this guide), assuming we have a
<code>tpose_afun</code> which meets our requirements, we can then fully
create our table:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>lyt_tpose_full <span class="ot">&lt;-</span> <span class="fu">basic_table</span>() <span class="sc">|&gt;</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"ARM"</span>, <span class="at">show_colcounts =</span> <span class="cn">TRUE</span>) <span class="sc">|&gt;</span></span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>  <span class="fu">split_cols_by</span>(<span class="st">"STUDYID"</span>,</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>    <span class="at">split_fun =</span> <span class="fu">add_combo_levels</span>(my_combo_df, <span class="at">keep_levels =</span> combo_df<span class="sc">$</span>valname),</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>    <span class="at">show_colcounts =</span> <span class="cn">TRUE</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"SEX"</span>, <span class="at">split_fun =</span> <span class="fu">keep_split_levels</span>(<span class="fu">c</span>(<span class="st">"F"</span>, <span class="st">"M"</span>))) <span class="sc">|&gt;</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  <span class="fu">analyze</span>(<span class="fu">c</span>(<span class="st">"AGE"</span>, <span class="st">"BMRKR1"</span>), <span class="at">afun =</span> tpose_afun, <span class="at">show_labels =</span> <span class="st">"hidden"</span>)</span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a><span class="fu">build_table</span>(lyt_tpose_full, ex_adsl)</span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>                    A<span class="sc">:</span> Drug X                    B<span class="sc">:</span> Placebo                  C<span class="sc">:</span> Combination       </span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>                     (<span class="at">N=</span><span class="dv">134</span>)                       (<span class="at">N=</span><span class="dv">134</span>)                       (<span class="at">N=</span><span class="dv">132</span>)          </span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>              n       mean       sd         n       mean       sd         n       mean       sd   </span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>           (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">134</span>)   (<span class="at">N=</span><span class="dv">132</span>)   (<span class="at">N=</span><span class="dv">132</span>)   (<span class="at">N=</span><span class="dv">132</span>)</span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>——————————————————————————————————————————————————————————————————————————————————————————————————</span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>F                                                                                                 </span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  AGE        <span class="dv">79</span>       <span class="fl">32.8</span>      <span class="fl">6.09</span>       <span class="dv">77</span>       <span class="fl">34.1</span>      <span class="fl">7.06</span>       <span class="dv">66</span>       <span class="fl">35.2</span>      <span class="fl">7.43</span>  </span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  BMRKR1     <span class="dv">79</span>        <span class="fl">5.8</span>      <span class="fl">3.31</span>       <span class="dv">77</span>        <span class="fl">5.6</span>      <span class="fl">3.36</span>       <span class="dv">66</span>        <span class="fl">5.7</span>      <span class="fl">4.12</span>  </span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>M                                                                                                 </span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  AGE        <span class="dv">51</span>       <span class="fl">35.6</span>      <span class="fl">7.08</span>       <span class="dv">55</span>       <span class="fl">37.4</span>      <span class="fl">8.69</span>       <span class="dv">60</span>       <span class="fl">35.4</span>      <span class="fl">8.24</span>  </span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>  BMRKR1     <span class="dv">51</span>        <span class="fl">6.3</span>      <span class="fl">3.99</span>       <span class="dv">55</span>        <span class="fl">5.9</span>      <span class="fl">3.30</span>       <span class="dv">60</span>        <span class="fl">5.3</span>      <span class="fl">2.57</span>  </span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="combining-these-faceting-needs">Combining These Faceting Needs<a class="anchor" aria-label="anchor" href="#combining-these-faceting-needs"></a>
</h2>
<p>For some table shells, we need to combine the types of needs we
explored above; we might need <code>trim_levels_to_map</code> type
behavior, but also need to include a virtual combination treatment/arm.
The split functions/function factories we discussed here generally
cannot achieve this, though our reasoning for <strong><em>how to think
about the faceting we need</em></strong> still applies. In such cases,
we will construct fully custom split functions which exactly meet our
needs, which will be the topic of an entire chapter in the advanced
portion of this guide.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>rtables is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../analytics.js"></script></footer>
</div>





  </body>
</html>
