<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Controlling Splitting Behavior • rtables</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Controlling Splitting Behavior">
<link rel="stylesheet" href="../consent.css">
<script src="../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rtables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.10.9001</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../articles/rtables.html">Get started</a></li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Getting Started</h6></li>
    <li><a class="dropdown-item" href="../articles/exploratory_analysis.html">Exploratory Analysis</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Clinical Trials</h6></li>
    <li><a class="dropdown-item" href="../articles/clinical_trials.html">Example Clinical Trials Tables</a></li>
    <li><a class="dropdown-item" href="../articles/baseline.html">Comparing Against Baselines or Control</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><h6 class="dropdown-header" data-toc-skip>Table Customization</h6></li>
    <li><a class="dropdown-item" href="../articles/custom_appearance.html">Customizing Appearance</a></li>
    <li><a class="dropdown-item" href="../articles/title_footer.html">Titles, Footers, and Referential Footnotes</a></li>
    <li><a class="dropdown-item" href="../articles/sorting_pruning.html">Pruning and Sorting Tables</a></li>
    <li><a class="dropdown-item" href="../articles/col_counts.html">Column Counts and Formats</a></li>
    <li><hr class="dropdown-divider"></li>
    <li><a class="dropdown-item" href="../articles/index.html">More articles...</a></li>
  </ul>
</li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-developer-guide" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Developer Guide</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-developer-guide">
<li><a class="dropdown-item" href="../articles/dev-guide/dg_split_machinery.html">Split Machinery</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_tabulation.html">Tabulation</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_table_hierarchy.html">Table Hierarchy</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_debug_rtables.html">Debugging in {rtables} and Beyond</a></li>
    <li><a class="dropdown-item" href="../articles/dev-guide/dg_notes.html">Sparse Notes on {rtables} Internals</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-reports" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Reports</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-reports">
<li><a class="dropdown-item" href="../coverage-report/">Coverage report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report/">Unit test report</a></li>
    <li><a class="dropdown-item" href="../unit-test-report-non-cran/">Non-CRAN unit test report</a></li>
  </ul>
</li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/insightsengineering/rtables"><span class="fa fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Controlling Splitting Behavior</h1>
                        <h4 data-toc-skip class="author">Gabriel
Becker</h4>
            
            <h4 data-toc-skip class="date">2024-10-29</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/rtables/blob/main/vignettes/split_functions.Rmd" class="external-link"><code>vignettes/split_functions.Rmd</code></a></small>
      <div class="d-none name"><code>split_functions.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="controlling-facet-levels">Controlling Facet Levels<a class="anchor" aria-label="anchor" href="#controlling-facet-levels"></a>
</h2>
<div class="section level3">
<h3 id="provided-functions">Provided Functions<a class="anchor" aria-label="anchor" href="#provided-functions"></a>
</h3>
<p>By default, <code>split_*_by(varname, ...)</code> generates a facet
for each <em>level</em> the variable <code>varname</code> takes in the
data - including unobserved ones in the <code>factor</code> case. This
behavior can be customized in various ways.</p>
<p>The most straightforward way to customize which facets are generated
by a split is with one of the split functions or split function families
provided by <code>rtables</code>.</p>
<p>These predefined split functions and function factories implement
commonly desired customization patterns of splitting behavior (i.e.,
faceting behavior). They include:</p>
<ul>
<li>
<code>remove_split_levels</code> - remove specified levels from the
data for facet generation.</li>
<li>
<code>keep_split_levels</code> - keep only specified levels in the
data for facet generation (removing all others).</li>
<li>
<code>drop_split_levels</code> - drop levels that are unobserved
<em>within the data being split</em>, i.e., associated with the parent
facet.</li>
<li>
<code>reorder_split_levels</code> - reorder the levels (and thus the
generated facets) to the specified order.</li>
<li>
<code>trim_levels_in_group</code> - drop unobserved levels <em>of
another variable</em> independently within the data associated with each
facet generated by the current split.</li>
<li>
<code>add_overall_level</code>, <code>add_combo_levels</code> - add
additional “virtual” levels which combine two or more levels of the
variable being split. See the following section.</li>
<li>
<code>trim_levels_to_map</code> - trim the levels of multiple
variables to a pre-specified set of value combinations. See the
following section.</li>
</ul>
<p>The first four of these are fairly self-describing and for brevity,
we refer our readers to <code><a href="../reference/split_funcs.html">?split_funcs</a></code> for details including
working examples.</p>
</div>
<div class="section level3">
<h3 id="controlling-combinations-of-levels-across-multiple-variables">Controlling Combinations of Levels Across Multiple Variables<a class="anchor" aria-label="anchor" href="#controlling-combinations-of-levels-across-multiple-variables"></a>
</h3>
<p>Often with nested splitting involving multiple variables, the values
of the variables in question are <em>logically nested</em>; meaning that
certain values of the inner variable are only coherent in combination
with a specific value or values of the outer variable.</p>
<p>As an example, suppose we have a variable <code>vehicle_class</code>,
which can take the values <code>"automobile"</code>, and
<code>"boat"</code>, and a variable <code>vehicle_type</code>, which can
take the values <code>"car"</code>, <code>"truck"</code>,
<code>"suv"</code>,<code>"sailboat"</code>, and
<code>"cruiseliner"</code>. The combination (<code>"automobile"</code>,
<code>"cruiseliner"</code>) does not make sense and will never occur in
any (correctly cleaned) data set; nor does the combination
(<code>"boat"</code>, <code>"truck"</code>).</p>
<p>We will showcase strategies to deal with this in the next sections
using the following artificial data:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">levs_type</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"car"</span>, <span class="st">"truck"</span>, <span class="st">"suv"</span>, <span class="st">"sailboat"</span>, <span class="st">"cruiseliner"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">vclass</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"auto"</span>, <span class="st">"boat"</span><span class="op">)</span>, <span class="fl">1000</span>, replace <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">auto_inds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">vclass</span> <span class="op">==</span> <span class="st">"auto"</span><span class="op">)</span></span>
<span><span class="va">vtype</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="cn">NA_character_</span>, <span class="fl">1000</span><span class="op">)</span></span>
<span><span class="va">vtype</span><span class="op">[</span><span class="va">auto_inds</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"car"</span>, <span class="st">"truck"</span><span class="op">)</span>, <span class="co">## suv missing on purpose</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">auto_inds</span><span class="op">)</span>,</span>
<span>  replace <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span><span class="va">vtype</span><span class="op">[</span><span class="op">-</span><span class="va">auto_inds</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"sailboat"</span>, <span class="st">"cruiseliner"</span><span class="op">)</span>,</span>
<span>  <span class="fl">1000</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">auto_inds</span><span class="op">)</span>,</span>
<span>  replace <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">vehic_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>  vehicle_class <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vclass</span><span class="op">)</span>,</span>
<span>  vehicle_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vtype</span>, levels <span class="op">=</span> <span class="va">levs_type</span><span class="op">)</span>,</span>
<span>  color <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"white"</span>, <span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>, <span class="fl">1000</span>,</span>
<span>    prob <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fl">2</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>    replace <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span>,</span>
<span>  cost <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span></span>
<span>    <span class="va">vclass</span> <span class="op">==</span> <span class="st">"boat"</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">100000</span>, sd <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span>,</span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="fl">1000</span>, <span class="fl">40000</span>, sd <span class="op">=</span> <span class="fl">5000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="fu"><a href="../reference/head_tail.html">head</a></span><span class="op">(</span><span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;   vehicle_class vehicle_type color      cost</span></span>
<span><span class="co">#&gt; 1          boat     sailboat black 100393.81</span></span>
<span><span class="co">#&gt; 2          auto          car white  38150.17</span></span>
<span><span class="co">#&gt; 3          boat     sailboat white  98696.13</span></span>
<span><span class="co">#&gt; 4          auto        truck white  37677.16</span></span>
<span><span class="co">#&gt; 5          auto        truck black  38489.27</span></span>
<span><span class="co">#&gt; 6          boat  cruiseliner black 108709.72</span></span></code></pre></div>
<div class="section level4">
<h4 id="trim_levels_in_group">
<code>trim_levels_in_group</code><a class="anchor" aria-label="anchor" href="#trim_levels_in_group"></a>
</h4>
<p>The <code>trim_levels_in_group</code> split function factory creates
split functions which deal with this issue empirically; any combination
which <em>is observed in the data being tabulated</em> will appear as
nested facets within the table, while those that do not, will not.</p>
<p>If we use default level-based faceting, we get several logically
incoherent cells within our table:</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/rtables" class="external-link">rtables</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   black      white        red   </span></span>
<span><span class="co">#&gt; ————————————————————————————————————————————————</span></span>
<span><span class="co">#&gt; auto                                            </span></span>
<span><span class="co">#&gt;   car                                           </span></span>
<span><span class="co">#&gt;     Mean        40431.92    40518.92   38713.14 </span></span>
<span><span class="co">#&gt;   truck                                         </span></span>
<span><span class="co">#&gt;     Mean        40061.70    40635.74   40024.41 </span></span>
<span><span class="co">#&gt;   suv                                           </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt;   sailboat                                      </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt;   cruiseliner                                   </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt; boat                                            </span></span>
<span><span class="co">#&gt;   car                                           </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt;   truck                                         </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt;   suv                                           </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt;   sailboat                                      </span></span>
<span><span class="co">#&gt;     Mean        99349.69    99996.54   101865.73</span></span>
<span><span class="co">#&gt;   cruiseliner                                   </span></span>
<span><span class="co">#&gt;     Mean        100212.00   99340.25   100363.52</span></span></code></pre></div>
<p>This is obviously not the table we want, as the majority of its space
is taken up by meaningless combinations. If we use
<code>trim_levels_in_group</code> to trim the levels of
<code>vehicle_type</code> separately within each level of
<code>vehicle_class</code>, we get a table which only has meaningful
combinations:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lyt2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/split_funcs.html">trim_levels_in_group</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt2</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   black      white        red   </span></span>
<span><span class="co">#&gt; ————————————————————————————————————————————————</span></span>
<span><span class="co">#&gt; auto                                            </span></span>
<span><span class="co">#&gt;   car                                           </span></span>
<span><span class="co">#&gt;     Mean        40431.92    40518.92   38713.14 </span></span>
<span><span class="co">#&gt;   truck                                         </span></span>
<span><span class="co">#&gt;     Mean        40061.70    40635.74   40024.41 </span></span>
<span><span class="co">#&gt; boat                                            </span></span>
<span><span class="co">#&gt;   sailboat                                      </span></span>
<span><span class="co">#&gt;     Mean        99349.69    99996.54   101865.73</span></span>
<span><span class="co">#&gt;   cruiseliner                                   </span></span>
<span><span class="co">#&gt;     Mean        100212.00   99340.25   100363.52</span></span></code></pre></div>
<p>Note, however, that it does not contain <em>all</em> meaningful
combinations, only those that were actually observed in our data; which
<em>happens</em> to not include the perfectly valid <code>"auto"</code>,
<code>"suv"</code> combination.</p>
<p>To restrict level combinations to those which are valid
<em>regardless of whether the combination was observed</em>, we must use
<code><a href="../reference/trim_levels_to_map.html">trim_levels_to_map()</a></code> instead.</p>
</div>
<div class="section level4">
<h4 id="trim_levels_to_map">
<code>trim_levels_to_map</code><a class="anchor" aria-label="anchor" href="#trim_levels_to_map"></a>
</h4>
<p><code>trim_levels_to_map</code> is similar to
<code>trim_levels_in_group</code> in that its purpose is to avoid
combinatorial explosion when nesting splitting with logically nested
variables. Unlike its sibling function, however, with
<code>trim_levels_to_map</code> we define the exact set of allowed
combinations <em>a priori</em>, and that exact set of combinations is
produced in the resulting table, regardless of whether they are observed
or not.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/" class="external-link">tibble</a></span><span class="op">)</span></span>
<span><span class="va">map</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">vehicle_class</span>, <span class="op">~</span><span class="va">vehicle_type</span>,</span>
<span>  <span class="st">"auto"</span>,         <span class="st">"truck"</span>,</span>
<span>  <span class="st">"auto"</span>,         <span class="st">"suv"</span>,</span>
<span>  <span class="st">"auto"</span>,         <span class="st">"car"</span>,</span>
<span>  <span class="st">"boat"</span>,         <span class="st">"sailboat"</span>,</span>
<span>  <span class="st">"boat"</span>,         <span class="st">"cruiseliner"</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lyt3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/trim_levels_to_map.html">trim_levels_to_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt3</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   black      white        red   </span></span>
<span><span class="co">#&gt; ————————————————————————————————————————————————</span></span>
<span><span class="co">#&gt; auto                                            </span></span>
<span><span class="co">#&gt;   car                                           </span></span>
<span><span class="co">#&gt;     Mean        40431.92    40518.92   38713.14 </span></span>
<span><span class="co">#&gt;   truck                                         </span></span>
<span><span class="co">#&gt;     Mean        40061.70    40635.74   40024.41 </span></span>
<span><span class="co">#&gt;   suv                                           </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA    </span></span>
<span><span class="co">#&gt; boat                                            </span></span>
<span><span class="co">#&gt;   sailboat                                      </span></span>
<span><span class="co">#&gt;     Mean        99349.69    99996.54   101865.73</span></span>
<span><span class="co">#&gt;   cruiseliner                                   </span></span>
<span><span class="co">#&gt;     Mean        100212.00   99340.25   100363.52</span></span></code></pre></div>
<p>Now we see that the <code>"auto"</code>, <code>"suv"</code>
combination is again present, even though it is populated with
<code>NA</code>s (because there is no data in that category), but the
logically invalid combinations are still absent.</p>
</div>
</div>
<div class="section level3">
<h3 id="combining-levels">Combining Levels<a class="anchor" aria-label="anchor" href="#combining-levels"></a>
</h3>
<p>Another very common manipulation of faceting in a table context is
the introduction of combination levels that are not explicitly modeled
in the data. Most often, this involves the addition of an “overall”
category, but in both principle and practice it can involve any
arbitrary combination of levels.</p>
<p><code>rtables</code> explicitly supports this via the
<code>add_overall_level</code> (for the all case) and
<code>add_combo_levels</code> split function factories.</p>
<div class="section level4">
<h4 id="add_overall_level">
<code>add_overall_level</code><a class="anchor" aria-label="anchor" href="#add_overall_level"></a>
</h4>
<p><code>add_overall_level</code> accepts <code>valname</code> which is
the name of the new level, as well as <code>label</code>, and
<code>first</code> (whether it should come first, if <code>TRUE</code>,
or last, if <code>FALSE</code>, in the ordering).</p>
<p>Building further on our arbitrary vehicles table, we can use this to
create an “all colors” category:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lyt4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/add_overall_level.html">add_overall_level</a></span><span class="op">(</span><span class="st">"allcolors"</span>, label <span class="op">=</span> <span class="st">"All Colors"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/trim_levels_to_map.html">trim_levels_to_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt4</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                 All Colors     black      white        red   </span></span>
<span><span class="co">#&gt;                  (N=1000)     (N=521)    (N=251)     (N=228) </span></span>
<span><span class="co">#&gt; —————————————————————————————————————————————————————————————</span></span>
<span><span class="co">#&gt; auto                                                         </span></span>
<span><span class="co">#&gt;   car                                                        </span></span>
<span><span class="co">#&gt;     Mean         40095.49    40431.92    40518.92   38713.14 </span></span>
<span><span class="co">#&gt;   truck                                                      </span></span>
<span><span class="co">#&gt;     Mean         40194.68    40061.70    40635.74   40024.41 </span></span>
<span><span class="co">#&gt;   suv                                                        </span></span>
<span><span class="co">#&gt;     Mean            NA          NA          NA         NA    </span></span>
<span><span class="co">#&gt; boat                                                         </span></span>
<span><span class="co">#&gt;   sailboat                                                   </span></span>
<span><span class="co">#&gt;     Mean        100133.22    99349.69    99996.54   101865.73</span></span>
<span><span class="co">#&gt;   cruiseliner                                                </span></span>
<span><span class="co">#&gt;     Mean        100036.76    100212.00   99340.25   100363.52</span></span></code></pre></div>
<p>With the column counts turned on, we can see that the “All Colors”
column encompasses the full 1000 (completely fake) vehicles in our data
set.</p>
<p>To add more arbitrary combinations, we use
<code>add_combo_levels</code>.</p>
</div>
<div class="section level4">
<h4 id="add_combo_levels">
<code>add_combo_levels</code><a class="anchor" aria-label="anchor" href="#add_combo_levels"></a>
</h4>
<p><code>add_combo_levels</code> allows us to add one or more arbitrary
combination levels to the faceting structure of our table.</p>
<p>We do this by defining a <em>combination data.frame</em> which
describes the levels we want to add. A combination
<code>data.frame</code> has the following columns and one row for each
combination to add:</p>
<ul>
<li>
<code>valname</code> - string indicating the name of the value,
which will appear in paths.</li>
<li>
<code>label</code> - a string indicating the label which should be
displayed when rendering.</li>
<li>
<code>levelcombo</code> - character vector of the individual levels
to be combined in this combination level.</li>
<li>
<code>exargs</code> - a list (usually <code><a href="https://rdrr.io/r/base/list.html" class="external-link">list()</a></code>) of extra
arguments which should be passed to analysis and content functions when
tabulated within this column or row.</li>
</ul>
<p>Suppose we wanted combinations levels for all non-white colors, and
for white and black colors. We do this like so:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">combodf</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tribble.html" class="external-link">tribble</a></span><span class="op">(</span></span>
<span>  <span class="op">~</span><span class="va">valname</span>, <span class="op">~</span><span class="va">label</span>, <span class="op">~</span><span class="va">levelcombo</span>, <span class="op">~</span><span class="va">exargs</span>,</span>
<span>  <span class="st">"non-white"</span>, <span class="st">"Non-White"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"red"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>  <span class="st">"blackwhite"</span>, <span class="st">"Black or White"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="va">lyt5</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/add_overall_level.html">add_combo_levels</a></span><span class="op">(</span><span class="va">combodf</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/trim_levels_to_map.html">trim_levels_to_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt5</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   black      white        red      Non-White   Black or White</span></span>
<span><span class="co">#&gt;                  (N=521)    (N=251)     (N=228)     (N=749)       (N=772)    </span></span>
<span><span class="co">#&gt; —————————————————————————————————————————————————————————————————————————————</span></span>
<span><span class="co">#&gt; auto                                                                         </span></span>
<span><span class="co">#&gt;   car                                                                        </span></span>
<span><span class="co">#&gt;     Mean        40431.92    40518.92   38713.14    39944.93       40460.77   </span></span>
<span><span class="co">#&gt;   truck                                                                      </span></span>
<span><span class="co">#&gt;     Mean        40061.70    40635.74   40024.41    40050.66       40243.57   </span></span>
<span><span class="co">#&gt;   suv                                                                        </span></span>
<span><span class="co">#&gt;     Mean           NA          NA         NA          NA             NA      </span></span>
<span><span class="co">#&gt; boat                                                                         </span></span>
<span><span class="co">#&gt;   sailboat                                                                   </span></span>
<span><span class="co">#&gt;     Mean        99349.69    99996.54   101865.73   100179.72      99567.50   </span></span>
<span><span class="co">#&gt;   cruiseliner                                                                </span></span>
<span><span class="co">#&gt;     Mean        100212.00   99340.25   100363.52   100258.56      99937.47</span></span></code></pre></div>
</div>
</div>
</div>
<div class="section level2">
<h2 id="fully-customizing-split-facet-behavior">Fully Customizing Split (Facet) Behavior<a class="anchor" aria-label="anchor" href="#fully-customizing-split-facet-behavior"></a>
</h2>
<p>Beyond the ability to select common splitting customizations from the
split functions and split function factories <code>rtables</code>
provides, we can also fully customize every aspect of splitting behavior
by creating our own split functions. While it is possible to do so by
hand, the primary way we do this is via the
<code><a href="../reference/make_split_fun.html">make_split_fun()</a></code> function, which accepts functions
implementing different component behaviors and combines them into a
split function which can be used in a layout.</p>
<p>Splitting, or faceting as it is done in <code>rtables</code>, can be
thought of as the combination of 3 steps:</p>
<ol style="list-style-type: decimal">
<li>preprocessing - transformation of the incoming data which will be
faceted</li>
</ol>
<ul>
<li>e.g., dropping unused factor levels, etc.</li>
</ul>
<ol start="2" style="list-style-type: decimal">
<li>splitting - mapping the incoming data to a set of 1 or more subsets
representing individual facets.</li>
<li>postprocessing - operations on the facets - e.g., combining them,
removing them, etc.</li>
</ol>
<p>The <code><a href="../reference/make_split_fun.html">make_split_fun()</a></code> function allows us to specify
custom behaviors for each of these steps independently when defining
custom splitting behavior via the <code>pre</code>,
<code>core_split</code>, and <code>post</code> arguments, which dictate
the above steps, respectively.</p>
<p>The <code>pre</code> argument accepts zero or more pre-processing
functions, which must accept: <code>df</code>, <code>spl</code>,
<code>vals</code>, <code>labels</code>, and can optionally accept
<code>.spl_context</code>. They then manipulate <code>df</code> (the
incoming data for the split) and return a modified data.frame. This
modified data.frame <em>must</em> contain all columns present in the
incoming data.frame, but can add columns if necessary. Although, we note
that these new columns <em>cannot be used in the layout as split or
analysis variables</em>, because they will not be present when validity
checking is done.</p>
<p>The pre-processing component is useful for things such as
manipulating factor levels, e.g., to trim unobserved ones or to reorder
levels based on observed counts, etc.</p>
<p>For a more detailed discussion on what custom split functions do, and
an example of a custom split function not implemented via
<code><a href="../reference/make_split_fun.html">make_split_fun()</a></code>, see <code><a href="../reference/custom_split_funs.html">?custom_split_funs</a></code>.</p>
<div class="section level3">
<h3 id="an-example-custom-split-function">An Example Custom Split Function<a class="anchor" aria-label="anchor" href="#an-example-custom-split-function"></a>
</h3>
<p>Here we will implement an arbitrary, custom split function where we
specify both pre- and post-processing instructions. It is unusual for
users to need to override the core splitting logic - and, in fact, is
only supported in row space currently - so we leave this off of our
example here but will provide another narrow example of that usage
below.</p>
<div class="section level4">
<h4 id="an-illustrative-example-of-a-custom-split-function">An Illustrative Example of A Custom Split Function<a class="anchor" aria-label="anchor" href="#an-illustrative-example-of-a-custom-split-function"></a>
</h4>
<p>First, we define two aspects of ‘pre-processing step’ behavior:</p>
<ol style="list-style-type: decimal">
<li>A function which reverses the order of the levels of a variable
(while retaining which level is associated with which observation),
and</li>
<li>A function factory which creates a function that removes a level and
the data associated with it.</li>
</ol>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## reverse order of levels</span></span>
<span></span>
<span><span class="va">rev_lev</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span>, <span class="va">vals</span>, <span class="va">labels</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## in the split_rows_by() and split_cols_by() cases,</span></span>
<span>  <span class="co">## spl_variable() gives us the variable</span></span>
<span>  <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spl_variable.html">spl_variable</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span></span>
<span>  <span class="va">vec</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">levs</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span></span>
<span>  <span class="va">df</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">vec</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="va">levs</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">df</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">rem_lev_facet</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">torem</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span>, <span class="va">vals</span>, <span class="va">labels</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">var</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/spl_variable.html">spl_variable</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span></span>
<span>    <span class="va">vec</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">bad</span> <span class="op">&lt;-</span> <span class="va">vec</span> <span class="op">==</span> <span class="va">torem</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="va">df</span><span class="op">[</span><span class="op">!</span><span class="va">bad</span>, <span class="op">]</span></span>
<span>    <span class="va">levs</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">is.character</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">vec</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">vec</span><span class="op">[</span><span class="op">!</span><span class="va">bad</span><span class="op">]</span><span class="op">)</span>, levels <span class="op">=</span> <span class="fu"><a href="https://generics.r-lib.org/reference/setops.html" class="external-link">setdiff</a></span><span class="op">(</span><span class="va">levs</span>, <span class="va">torem</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">df</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Finally we implement our post-processing function. Here we will
reorder the facets based on the amount of data each of them
represents.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">sort_them_facets</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">splret</span>, <span class="va">spl</span>, <span class="va">fulldf</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">ord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">splret</span><span class="op">$</span><span class="va">datasplit</span>, <span class="va">nrow</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="../reference/make_split_result.html">make_split_result</a></span><span class="op">(</span></span>
<span>    <span class="va">splret</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>,</span>
<span>    <span class="va">splret</span><span class="op">$</span><span class="va">datasplit</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span>,</span>
<span>    <span class="va">splret</span><span class="op">$</span><span class="va">labels</span><span class="op">[</span><span class="va">ord</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>Finally, we construct our custom split function and use it to create
our table:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">silly_splfun1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_split_fun.html">make_split_fun</a></span><span class="op">(</span></span>
<span>  pre <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    <span class="va">rev_lev</span>,</span>
<span>    <span class="fu">rem_lev_facet</span><span class="op">(</span><span class="st">"white"</span><span class="op">)</span></span>
<span>  <span class="op">)</span>,</span>
<span>  post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">sort_them_facets</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">lyt6</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span>, split_fun <span class="op">=</span> <span class="va">silly_splfun1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../reference/trim_levels_to_map.html">trim_levels_to_map</a></span><span class="op">(</span><span class="va">map</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt6</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                    red        black  </span></span>
<span><span class="co">#&gt;                  (N=228)     (N=521) </span></span>
<span><span class="co">#&gt; —————————————————————————————————————</span></span>
<span><span class="co">#&gt; auto                                 </span></span>
<span><span class="co">#&gt;   car                                </span></span>
<span><span class="co">#&gt;     Mean        38713.14    40431.92 </span></span>
<span><span class="co">#&gt;   truck                              </span></span>
<span><span class="co">#&gt;     Mean        40024.41    40061.70 </span></span>
<span><span class="co">#&gt;   suv                                </span></span>
<span><span class="co">#&gt;     Mean           NA          NA    </span></span>
<span><span class="co">#&gt; boat                                 </span></span>
<span><span class="co">#&gt;   sailboat                           </span></span>
<span><span class="co">#&gt;     Mean        101865.73   99349.69 </span></span>
<span><span class="co">#&gt;   cruiseliner                        </span></span>
<span><span class="co">#&gt;     Mean        100363.52   100212.00</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="overriding-the-core-split-function">Overriding the Core Split Function<a class="anchor" aria-label="anchor" href="#overriding-the-core-split-function"></a>
</h4>
<p><strong>Currently, overriding core split behavior is only supported
in functions used for row splits.</strong></p>
<p>Next, we write a custom core-splitting function which divides the
observations into 4 groups: the first 100, observations 101-500,
observations 501-900, and the last hundred. We could claim this was to
test for structural bias in the first and last observations, but really
its to simply illustrate overriding the core splitting machinery and has
no meaningful statistical purpose.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">silly_core_split</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span>, <span class="va">labels</span>, <span class="va">.spl_context</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="../reference/make_split_result.html">make_split_result</a></span><span class="op">(</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"first"</span>, <span class="st">"lowmid"</span>, <span class="st">"highmid"</span>, <span class="st">"last"</span><span class="op">)</span>,</span>
<span>    datasplit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      <span class="va">df</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span>,</span>
<span>      <span class="va">df</span><span class="op">[</span><span class="fl">101</span><span class="op">:</span><span class="fl">500</span>, <span class="op">]</span>,</span>
<span>      <span class="va">df</span><span class="op">[</span><span class="fl">501</span><span class="op">:</span><span class="fl">900</span>, <span class="op">]</span>,</span>
<span>      <span class="va">df</span><span class="op">[</span><span class="fl">901</span><span class="op">:</span><span class="fl">1000</span>, <span class="op">]</span></span>
<span>    <span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>      <span class="st">"first 100"</span>,</span>
<span>      <span class="st">"obs 101-500"</span>,</span>
<span>      <span class="st">"obs 501-900"</span>,</span>
<span>      <span class="st">"last 100"</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can use this to construct a splitting function. This can be
combined with pre- and post-processing functions, as each of the stages
is performed independently, but in this case, we won’t, because our core
splitting behavior is such that pre- or post-processing do not make much
sense.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">even_sillier_splfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/make_split_fun.html">make_split_fun</a></span><span class="op">(</span>core_split <span class="op">=</span> <span class="va">silly_core_split</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lyt7</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"color"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_class"</span>, split_fun <span class="op">=</span> <span class="va">even_sillier_splfun</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"vehicle_type"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"cost"</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt7</span>, <span class="va">vehic_data</span><span class="op">)</span></span>
<span><span class="co">#&gt;                   black       white        red   </span></span>
<span><span class="co">#&gt;                  (N=521)     (N=251)     (N=228) </span></span>
<span><span class="co">#&gt; —————————————————————————————————————————————————</span></span>
<span><span class="co">#&gt; first 100                                        </span></span>
<span><span class="co">#&gt;   car                                            </span></span>
<span><span class="co">#&gt;     Mean        40496.05    37785.41    37623.17 </span></span>
<span><span class="co">#&gt;   truck                                          </span></span>
<span><span class="co">#&gt;     Mean        41094.17    40437.29    37866.81 </span></span>
<span><span class="co">#&gt;   suv                                            </span></span>
<span><span class="co">#&gt;     Mean           NA          NA          NA    </span></span>
<span><span class="co">#&gt;   sailboat                                       </span></span>
<span><span class="co">#&gt;     Mean        100560.80   102017.05   101185.96</span></span>
<span><span class="co">#&gt;   cruiseliner                                    </span></span>
<span><span class="co">#&gt;     Mean        100838.12   96952.27    100610.71</span></span>
<span><span class="co">#&gt; obs 101-500                                      </span></span>
<span><span class="co">#&gt;   car                                            </span></span>
<span><span class="co">#&gt;     Mean        39350.88    41185.98    37978.72 </span></span>
<span><span class="co">#&gt;   truck                                          </span></span>
<span><span class="co">#&gt;     Mean        40166.87    41385.32    39885.72 </span></span>
<span><span class="co">#&gt;   suv                                            </span></span>
<span><span class="co">#&gt;     Mean           NA          NA          NA    </span></span>
<span><span class="co">#&gt;   sailboat                                       </span></span>
<span><span class="co">#&gt;     Mean        98845.47    99563.02    101462.79</span></span>
<span><span class="co">#&gt;   cruiseliner                                    </span></span>
<span><span class="co">#&gt;     Mean        101558.62   99039.91    97335.05 </span></span>
<span><span class="co">#&gt; obs 501-900                                      </span></span>
<span><span class="co">#&gt;   car                                            </span></span>
<span><span class="co">#&gt;     Mean        40721.82    40379.48    38681.26 </span></span>
<span><span class="co">#&gt;   truck                                          </span></span>
<span><span class="co">#&gt;     Mean        39951.92    39846.89    39840.39 </span></span>
<span><span class="co">#&gt;   suv                                            </span></span>
<span><span class="co">#&gt;     Mean           NA          NA          NA    </span></span>
<span><span class="co">#&gt;   sailboat                                       </span></span>
<span><span class="co">#&gt;     Mean        99533.20    100347.18   102732.12</span></span>
<span><span class="co">#&gt;   cruiseliner                                    </span></span>
<span><span class="co">#&gt;     Mean        99140.43    100074.43   101994.99</span></span>
<span><span class="co">#&gt; last 100                                         </span></span>
<span><span class="co">#&gt;   car                                            </span></span>
<span><span class="co">#&gt;     Mean        45204.44    40626.95    41214.33 </span></span>
<span><span class="co">#&gt;   truck                                          </span></span>
<span><span class="co">#&gt;     Mean        38920.70    40620.47    42899.14 </span></span>
<span><span class="co">#&gt;   suv                                            </span></span>
<span><span class="co">#&gt;     Mean           NA          NA          NA    </span></span>
<span><span class="co">#&gt;   sailboat                                       </span></span>
<span><span class="co">#&gt;     Mean        99380.21    97644.77    101691.92</span></span>
<span><span class="co">#&gt;   cruiseliner                                    </span></span>
<span><span class="co">#&gt;     Mean        100017.53   99581.94    100751.30</span></span></code></pre></div>
</div>
<div class="section level4">
<h4 id="design-of-pre--and-post-processing-functions-for-use-in-make_split_fun">Design of Pre- and Post-Processing Functions For Use in
<code>make_split_fun</code><a class="anchor" aria-label="anchor" href="#design-of-pre--and-post-processing-functions-for-use-in-make_split_fun"></a>
</h4>
<p>Pre-processing and post-processing functions in the custom-splitting
context are best thought of as (and implemented as) independent, atomic
building blocks for the desired overall behavior. This allows them to be
reused in a flexible mix-and-match way.</p>
<p><code>rtables</code> provides several behavior components implemented
as either functions or function factories:</p>
<ul>
<li>Pre-processing “behavior blocks”
<ul>
<li>
<code>drop_facet_levels</code> - drop unobserved levels in the
variable being split</li>
</ul>
</li>
<li>Post-processing “behavior blocks”
<ul>
<li>
<code>trim_levels_in_facets</code> - provides
<code>trim_levels_in_group</code> behavior</li>
<li>
<code>add_overall_facet</code> - add a combination facet for the
full data</li>
<li>
<code>add_combo_facet</code> - add a single combination facet (can
be used more than once in a single <code>make_split_fun</code>
call)</li>
</ul>
</li>
</ul>
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>rtables is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../analytics.js"></script></footer>
</div>





  </body>
</html>
