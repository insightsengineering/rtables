<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rtables">
<title>Split Machinery • rtables</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.2.2/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.2.2/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Split Machinery">
<meta property="og:description" content="rtables">
<meta property="og:image" content="https://insightsengineering.github.io/rtables/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="../../consent.css">
<script src="../../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../../index.html">rtables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.6</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Getting Started</h6>
    <a class="dropdown-item" href="../../articles/introduction.html">Introduction to {rtables}</a>
    <a class="dropdown-item" href="../../articles/exploratory_analysis.html">Exploratory Analysis</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Clinical Trials</h6>
    <a class="dropdown-item" href="../../articles/clinical_trials.html">Example Clinical Trials Tables</a>
    <a class="dropdown-item" href="../../articles/baseline.html">Comparing Against Baselines or Control</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Table Customization</h6>
    <a class="dropdown-item" href="../../articles/custom_appearance.html">Customizing Appearance</a>
    <a class="dropdown-item" href="../../articles/title_footer.html">Titles, Footers, and Referential Footnotes</a>
    <a class="dropdown-item" href="../../articles/sorting_pruning.html">Pruning and Sorting Tables</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../../articles/index.html">More articles...</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-developer-guide">Developer Guide</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-developer-guide">
    <a class="dropdown-item" href="../../articles/dev-guide/dg_split_machinery.html">Split Machinery</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_tabulation.html">Tabulation</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_table_hierarchy.html">Table Hierarchy</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_debug_rtables.html">Debugging in {rtables} and Beyond</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_notes.html">Sparse Notes on {rtables} Internals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">Changelog</a>
</li>
<!-- start dropdown for versions --> <li class="nav-item dropdown">
        <a href="#" class="nav-link dropdown-toggle"
          data-bs-toggle="dropdown" role="button"
          aria-expanded="false" aria-haspopup="true"
          id="dropdown-versions">Versions</a> <div class="dropdown-menu" aria-labelledby="dropdown-versions"> <a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/release-candidate">release-candidate</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/latest-release">latest-release</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.6-rc1">v0.6.6-rc1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.9">v0.6.9</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.8">v0.6.8</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.7">v0.6.7</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.6">v0.6.6</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.5">v0.6.5</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.4">v0.6.4</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.3">v0.6.3</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.2">v0.6.2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.1">v0.6.1</a> </div></li>
<!-- end dropdown for versions -->
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../../unit-test-report/">Unit test report</a>
  </div>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/insightsengineering/rtables">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Split Machinery</h1>
                        <h4 data-toc-skip class="author">Davide
Garolini</h4>
            
            <h4 data-toc-skip class="date">2023-12-07</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/rtables/blob/main/vignettes/dev-guide/dg_split_machinery.Rmd" class="external-link"><code>vignettes/dev-guide/dg_split_machinery.Rmd</code></a></small>
      <div class="d-none name"><code>dg_split_machinery.Rmd</code></div>
    </div>

    
    
<div class="section level2">
<h2 id="disclaimer">Disclaimer<a class="anchor" aria-label="anchor" href="#disclaimer"></a>
</h2>
<p>This article is intended for use by developers only and will contain
low-level explanations of the topics covered. For user-friendly
vignettes, please see the <a href="https://insightsengineering.github.io/rtables/main/articles/index.html">Articles</a>
page on the <code>rtables</code> website.</p>
<p>Any code or prose which appears in the version of this article on the
<code>main</code> branch of the repository may reflect a specific state
of things that can be more or less recent. This guide describes very
important pieces of the split machinery that are unlikely to change.
Regardless, we invite the reader to keep in mind that the current
repository code may have drifted from the following material in this
document, and it is always the best practice to read the code directly
on <code>main</code>.</p>
<p>Please keep in mind that <code>rtables</code> is still under active
development, and it has seen the efforts of multiple contributors across
different years. Therefore, there may be legacy mechanisms and ongoing
transformations that could look different in the future.</p>
<p>Being that this a working document that may be subjected to both
deprecation and updates, we keep <code>xxx</code> comments to indicate
placeholders for warnings and to-do’s that need further work.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The scope of this article is understanding how <code>rtables</code>
creates facets by splitting the incoming data into hierarchical groups
that go from the root node to singular <code>rcell</code>s. The latter
level, also called the leaf-level, contains the final partition that is
subjected to analysis functions. More details from the user perspective
can be found in the <a href="https://insightsengineering.github.io/rtables/main/articles/split_functions.html">Split
Functions vignette</a> and in function documentation like
<code><a href="../../reference/split_rows_by.html">?split_rows_by</a></code> and <code><a href="../../reference/split_funcs.html">?split_funcs</a></code>.</p>
<p>The following article will describe how the split machinery works in
the row domain. Further information on how the split machinery works in
the column domain will be covered in a separate article.</p>
</div>
<div class="section level2">
<h2 id="process-and-methods">Process and Methods<a class="anchor" aria-label="anchor" href="#process-and-methods"></a>
</h2>
<p>Beforehand, we encourage the reader to familiarize themselves with
the <a href="https://insightsengineering.github.io/rtables/main/articles/dev-guide/dg_debug_rtables.html">Debugging
in {rtables} article</a> from the <code>rtables</code> Developers Guide.
This document is generally valid for R programming, but has been
tailored to study and understand complex packages that rely heavily on
S3 and S4 object programming like <code>rtables</code>.</p>
<p>Here, we explore and study the split machinery with a growing amount
of complexity, following relevant functions and methods throughout their
execution. By going from basic to complex and by discussing important
and special cases, we hope to be able to give you a good understanding
of how the split machinery works.</p>
<p>In practice, the majority of the split engine resides in the source
file <code>R/split_funs.R</code>, with occasional incursion into
<code>R/make_split_fun.R</code> for custom split function creation and
rarer references to other more general tabulation files.</p>
</div>
<div class="section level2">
<h2 id="do_split">
<code>do_split</code><a class="anchor" aria-label="anchor" href="#do_split"></a>
</h2>
<p>The split machinery is so fundamental to <code>rtables</code> that
relevant functions like <code>do_split</code> are executed even when no
split is requested. The following example shows how we can enter
<code>do_split</code> and start understanding the class hierarchy and
the main split engine.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/rtables" class="external-link">rtables</a></span><span class="op">)</span></span>
<span><span class="co"># debugonce(rtables:::do_split) # Uncomment me to enter the function!!!</span></span>
<span><span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##    all obs</span></span>
<span><span class="co">## ——————————</span></span></code></pre>
<p>In the following code, we copied the <code>do_split</code> function
code to allow the reader to go through the general structure with
enhanced comments and sections. Each section in the code reflects
roughly one section of this article.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="co">### NB This is called at EACH level of recursive splitting</span></span>
<span><span class="va">do_split</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>,</span>
<span>                     <span class="va">df</span>,</span>
<span>                     <span class="va">vals</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     <span class="va">labels</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     <span class="va">trim</span> <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>                     <span class="va">spl_context</span><span class="op">)</span> <span class="op">{</span></span>
<span><span class="co"># - CHECKS - #</span></span>
<span>  <span class="co">## This will error if, e.g., df does not have columns</span></span>
<span>  <span class="co">##  required by spl, or generally any time the split (spl)</span></span>
<span>  <span class="co">##  can not be applied to df</span></span>
<span>  <span class="fu">check_validsplit</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># - SPLIT FUNCTION - #</span></span>
<span>  <span class="co">## In special cases, we need to partition data (split)</span></span>
<span>  <span class="co">##  in a very specific way, e.g. depending on the data or</span></span>
<span>  <span class="co">##  external values. These can be achieved by using a custom</span></span>
<span>  <span class="co">##  split function.</span></span>
<span></span>
<span>  <span class="co">## note the &lt;- here!!!</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">splfun</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/int_methods.html">split_fun</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## Currently split functions take df, vals, labels and</span></span>
<span>    <span class="co">## return list(values = ..., datasplit = ..., labels = ...),</span></span>
<span>    <span class="co">## with an optional additional 'extras' element</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu">func_takes</span><span class="op">(</span><span class="va">splfun</span>, <span class="st">".spl_context"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">ret</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span></span>
<span>        <span class="fu">splfun</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span>, <span class="va">vals</span>, <span class="va">labels</span>,</span>
<span>          trim <span class="op">=</span> <span class="va">trim</span>,</span>
<span>          .spl_context <span class="op">=</span> <span class="va">spl_context</span></span>
<span>        <span class="op">)</span>,</span>
<span>        error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="va">e</span></span>
<span>      <span class="op">)</span> <span class="co">## rawvalues(spl_context))</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">ret</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu">splfun</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span>, <span class="va">vals</span>, <span class="va">labels</span>, trim <span class="op">=</span> <span class="va">trim</span><span class="op">)</span>,</span>
<span>        error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="va">e</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/is.html" class="external-link">is</a></span><span class="op">(</span><span class="va">ret</span>, <span class="st">"error"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>        <span class="st">"Error applying custom split function: "</span>, <span class="va">ret</span><span class="op">$</span><span class="va">message</span>, <span class="st">"\n\tsplit: "</span>,</span>
<span>        <span class="fu"><a href="https://rdrr.io/r/base/class.html" class="external-link">class</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span>, <span class="st">" ("</span>, <span class="fu">payloadmsg</span><span class="op">(</span><span class="va">spl</span><span class="op">)</span>, <span class="st">")\n"</span>,</span>
<span>        <span class="st">"\toccured at path: "</span>,</span>
<span>        <span class="fu"><a href="../../reference/spl_context_to_disp_path.html">spl_context_to_disp_path</a></span><span class="op">(</span><span class="va">spl_context</span><span class="op">)</span>, <span class="st">"\n"</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span><span class="co"># - .apply_split_inner - #</span></span>
<span>    <span class="co">## This is called when no split function is provided. Please note that this function</span></span>
<span>    <span class="co">##  will also probably be called when the split function is provided, as long as the</span></span>
<span>    <span class="co">##  main splitting method is not willingly modified by the split function.</span></span>
<span>    <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu">.apply_split_inner</span><span class="op">(</span>df <span class="op">=</span> <span class="va">df</span>, spl <span class="op">=</span> <span class="va">spl</span>, vals <span class="op">=</span> <span class="va">vals</span>, labels <span class="op">=</span> <span class="va">labels</span>, trim <span class="op">=</span> <span class="va">trim</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># - EXTRA - #</span></span>
<span>  <span class="co">## this adds .ref_full and .in_ref_col</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/is.html" class="external-link">is</a></span><span class="op">(</span><span class="va">spl</span>, <span class="st">"VarLevWBaselineSplit"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu">.add_ref_extras</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">ret</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span><span class="co"># - FIXUPVALS - #</span></span>
<span>  <span class="co">## This:</span></span>
<span>  <span class="co">##  - guarantees that ret$values contains SplitValue objects</span></span>
<span>  <span class="co">##  - removes the extras element since its redundant after the above</span></span>
<span>  <span class="co">##  - ensures datasplit and values lists are named according to labels</span></span>
<span>  <span class="co">##  - ensures labels are character not factor</span></span>
<span>  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu">.fixupvals</span><span class="op">(</span><span class="va">ret</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># - RETURN - #</span></span>
<span>  <span class="va">ret</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We will see where and how input parameters are used. The most
important parameters are <code>spl</code> and <code>df</code> - the
split objects and the input <code>data.frame</code>, respectively.</p>
<div class="section level3">
<h3 id="checks-and-classes">Checks and Classes<a class="anchor" aria-label="anchor" href="#checks-and-classes"></a>
</h3>
<p>We will start by looking at the first function called from
<code>do_split</code>. This will give us a good overview of how the
split itself is defined. This function is, of course, the check function
(<code>check_validsplit</code>) that is used to verify if the split is
valid for the data. In the following we will describe the split-class
hierarchy step-by-step, but we invite the reader to explore this further
on their own as well.</p>
<p>Let’s first search the package for <code>check_validsplit</code>. You
will find that it is defined as a generic in
<code>R/split_funs.R</code>, where it is applied to the following
“split” classes: <code>VarLevelSplit</code>, <code>MultiVarSplit</code>,
<code>VAnalyzeSplit</code>, <code>CompoundSplit</code>, and
<code>Split</code>. Another way to find this information, which is more
useful for more spread out and complicated objects, is by using
<code>showMethods(check_validsplit)</code>. The virtual class
<code>VAnalyzeSplit</code> (by convention virtual classes start with
“V”) defines the main parent of the analysis split which we discuss in
detail in the related vignette <code><a href="https://rdrr.io/r/utils/vignette.html" class="external-link">vignette()</a></code> (xxx). From this,
we can see that the <code><a href="../../reference/analyze.html">analyze()</a></code> calls actually mimic split
objects as they create different results under a specific final split
(or node). Now, notice that <code>check_validsplit</code> is also called
in another location, the main <code>R/tt_dotabulation.R</code> source
file. This is again something related to making “analyze” rows as it
mainly checks for <code>VAnalyzeSplit</code>. See the <a href="https://insightsengineering.github.io/rtables/main/articles/dev-guide/dg_tabulation.html">Tabulation
article</a> for more details. We will discuss the other classes as they
appear in our examples. See more about class hierarchy in the <a href="https://insightsengineering.github.io/rtables/main/articles/dev-guide/dg_table_hierarchy.html">Table
Hierarchy article</a>.</p>
<p>For the moment, we see with <code>class(spl)</code> (from the main
<code>do_split</code> function) that we are dealing with an
<code>AllSplit</code> object. By calling
<code>showMethods(check_validsplit)</code> we produce the following:</p>
<pre><code># rtables 0.6.2
Function: check_validsplit (package rtables)
spl="AllSplit"
    (inherited from: spl="Split")
spl="CompoundSplit"
spl="MultiVarSplit"
spl="Split"
spl="VAnalyzeSplit"
spl="VarLevelSplit"</code></pre>
<p>This means that each of the listed classes has a dedicated definition
of <code>check_validsplit</code> that may largely differ from the
others. Only the class <code>AllSplit</code> does not have its own
function definition as it is inherited from the <code>Split</code>
class. Therefore, we understand that <code>AllSplit</code> is a parent
class of <code>Split</code>. This is one of the first definitions of a
virtual class in the package and it is the only one that does not
include the “V” prefix. These classes are defined along with their
constructors in <code>R/00tabletrees.R</code>. Reading about how
<code>AllSplit</code> is structured can be useful in understanding how
split objects are expected to work. Please see the comments in the
following:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setClass.html" class="external-link">setClass</a></span><span class="op">(</span><span class="st">"AllSplit"</span>, contains <span class="op">=</span> <span class="st">"Split"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">AllSplit</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">split_label</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                     <span class="va">cfun</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     <span class="va">cformat</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     <span class="va">cna_str</span> <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>                     <span class="va">split_format</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     <span class="va">split_na_str</span> <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>                     <span class="va">split_name</span> <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>                     <span class="va">extra_args</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     <span class="va">indent_mod</span> <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                     <span class="va">cindent_mod</span> <span class="op">=</span> <span class="fl">0L</span>,</span>
<span>                     <span class="va">cvar</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                     <span class="va">cextra_args</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                     <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">split_name</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># If the split has no name</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nzchar</a></span><span class="op">(</span><span class="va">split_label</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># (std is "")</span></span>
<span>      <span class="va">split_name</span> <span class="op">&lt;-</span> <span class="va">split_label</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">split_name</span> <span class="op">&lt;-</span> <span class="st">"all obs"</span> <span class="co"># No label, a standard split with all</span></span>
<span>                              <span class="co"># observations is assigned.</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/new.html" class="external-link">new</a></span><span class="op">(</span><span class="st">"AllSplit"</span>,</span>
<span>    split_label <span class="op">=</span> <span class="va">split_label</span>,</span>
<span>    content_fun <span class="op">=</span> <span class="va">cfun</span>,</span>
<span>    content_format <span class="op">=</span> <span class="va">cformat</span>,</span>
<span>    content_na_str <span class="op">=</span> <span class="va">cna_str</span>,</span>
<span>    split_format <span class="op">=</span> <span class="va">split_format</span>,</span>
<span>    split_na_str <span class="op">=</span> <span class="va">split_na_str</span>,</span>
<span>    name <span class="op">=</span> <span class="va">split_name</span>,</span>
<span>    label_children <span class="op">=</span> <span class="cn">FALSE</span>,</span>
<span>    extra_args <span class="op">=</span> <span class="va">extra_args</span>,</span>
<span>    indent_modifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">indent_mod</span><span class="op">)</span>,</span>
<span>    content_indent_modifier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/integer.html" class="external-link">as.integer</a></span><span class="op">(</span><span class="va">cindent_mod</span><span class="op">)</span>,</span>
<span>    content_var <span class="op">=</span> <span class="va">cvar</span>,</span>
<span>    split_label_position <span class="op">=</span> <span class="st">"hidden"</span>,</span>
<span>    content_extra_args <span class="op">=</span> <span class="va">cextra_args</span>,</span>
<span>    page_title_prefix <span class="op">=</span> <span class="cn">NA_character_</span>,</span>
<span>    child_section_div <span class="op">=</span> <span class="cn">NA_character_</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can also print this information by calling
<code>getClass("AllSplit")</code> for the general slot definition, or by
calling <code>getClass(spl)</code>. Note that the first call will give
also a lot of information about the class hierarchy. For more
information regarding class hierarchy, please refer to the relevant
article <a href="https://insightsengineering.github.io/rtables/main/articles/dev-guide/dg_talbe_hierarchy.html">here</a>.
We will discuss the majority of the slots by the end of this document.
Now, let’s see if we can find some of the values described in the
constructor within our object. To do so, we will show the more compact
representation given by <code>str</code>. When there are multiple and
hierarchical slots that contain objects themselves, calling
<code>str</code> will be much less or not at all informative if the
maximum level of nesting is not set
(e.g. <code>max.level = 2</code>).</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>Browse[<span class="dv">2</span>]<span class="sc">&gt;</span> <span class="fu">str</span>(spl, <span class="at">max.level =</span> <span class="dv">2</span>)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>Formal class <span class="st">'AllSplit'</span> [package <span class="st">"rtables"</span>] with <span class="dv">17</span> slots</span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  ..<span class="sc">@</span> payload                <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  ..<span class="sc">@</span> name                   <span class="sc">:</span> chr <span class="st">"all obs"</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a>  ..<span class="sc">@</span> split_label            <span class="sc">:</span> chr <span class="st">""</span></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>  ..<span class="sc">@</span> split_format           <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a>  ..<span class="sc">@</span> split_na_str           <span class="sc">:</span> chr <span class="cn">NA</span></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>  ..<span class="sc">@</span> split_label_position   <span class="sc">:</span> chr <span class="st">"hidden"</span></span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>  ..<span class="sc">@</span> content_fun            <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  ..<span class="sc">@</span> content_format         <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  ..<span class="sc">@</span> content_na_str         <span class="sc">:</span> chr <span class="cn">NA</span></span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  ..<span class="sc">@</span> content_var            <span class="sc">:</span> chr <span class="st">""</span></span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>  ..<span class="sc">@</span> label_children         <span class="sc">:</span> logi <span class="cn">FALSE</span></span>
<span id="cb6-15"><a href="#cb6-15" tabindex="-1"></a>  ..<span class="sc">@</span> extra_args             <span class="sc">:</span> <span class="fu">list</span>()</span>
<span id="cb6-16"><a href="#cb6-16" tabindex="-1"></a>  ..<span class="sc">@</span> indent_modifier        <span class="sc">:</span> int <span class="dv">0</span></span>
<span id="cb6-17"><a href="#cb6-17" tabindex="-1"></a>  ..<span class="sc">@</span> content_indent_modifier<span class="sc">:</span> int <span class="dv">0</span></span>
<span id="cb6-18"><a href="#cb6-18" tabindex="-1"></a>  ..<span class="sc">@</span> content_extra_args     <span class="sc">:</span> <span class="fu">list</span>()</span>
<span id="cb6-19"><a href="#cb6-19" tabindex="-1"></a>  ..<span class="sc">@</span> page_title_prefix      <span class="sc">:</span> chr <span class="cn">NA</span></span>
<span id="cb6-20"><a href="#cb6-20" tabindex="-1"></a>  ..<span class="sc">@</span> child_section_div      <span class="sc">:</span> chr <span class="cn">NA</span></span></code></pre></div>
<p>Details about these slots will become necessary in future examples,
and we will deal with them at that time. Now, we gave you a hint of the
complex class hierarchy that makes up <code>rtables</code>, and how to
explore it autonomously. Let’s go forward in <code>do_split</code>. In
our case, with <code>AllSplit</code> inherited from <code>Split</code>,
we are sure that the called function will be the following (read the
comment!):</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="co">## Default does nothing, add methods as they become required</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setMethod.html" class="external-link">setMethod</a></span><span class="op">(</span></span>
<span>  <span class="st">"check_validsplit"</span>, <span class="st">"Split"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/invisible.html" class="external-link">invisible</a></span><span class="op">(</span><span class="cn">NULL</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="split-functions-and--apply_split_inner">Split Functions and <code>.apply_split_inner</code><a class="anchor" aria-label="anchor" href="#split-functions-and--apply_split_inner"></a>
</h3>
<p>Before diving into custom split functions, we need to take a moment
to analyze how <code>.apply_split_inner</code> works. This function is
routinely called whether or not we have a split function. Let’s see why
this is the case by entering it with
<code>debugonce(.apply_split_inner)</code>. Of course, we are still
currently browsing within <code>do_split</code> in debug mode from the
first example. We print and comment on the function in the
following:</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="va">.apply_split_inner</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">labels</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">trim</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># - INPUTS - #</span></span>
<span>  <span class="co"># In this case .applysplit_rawvals will attempt to find the split values if vals is NULL.</span></span>
<span>  <span class="co"># Please notice that there may be a non-mutually exclusive set or subset of elements that</span></span>
<span>  <span class="co"># will constitute the split.</span></span>
<span></span>
<span>  <span class="co"># - SPLIT VALS - #</span></span>
<span>  <span class="co">## Try to calculate values first - most of the time we can</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu">.applysplit_rawvals</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># - EXTRA PARAMETERS - #</span></span>
<span>  <span class="co"># This call extracts extra parameters from the split, according to the split values</span></span>
<span>  <span class="va">extr</span> <span class="op">&lt;-</span> <span class="fu">.applysplit_extras</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># If there are no values to do the split upon, we return an empty final split</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      datasplit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>      extras <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>    <span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># - DATA SUBSETTING - #</span></span>
<span>  <span class="va">dpart</span> <span class="op">&lt;-</span> <span class="fu">.applysplit_datapart</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># - LABEL RETRIEVAL - #</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">labels</span> <span class="op">&lt;-</span> <span class="fu">.applysplit_partlabels</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span>, <span class="va">labels</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/stopifnot.html" class="external-link">stopifnot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span> <span class="op">==</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># - TRIM - #</span></span>
<span>  <span class="co">## Get rid of columns that would not have any observations,</span></span>
<span>  <span class="co">## but only if there were any rows to start with - if not</span></span>
<span>  <span class="co">## we're in a manually constructed table column tree</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="va">trim</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">hasdata</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">dpart</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span> <span class="op">&amp;&amp;</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">dpart</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">hasdata</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># some empties</span></span>
<span>      <span class="va">dpart</span> <span class="op">&lt;-</span> <span class="va">dpart</span><span class="op">[</span><span class="va">hasdata</span><span class="op">]</span></span>
<span>      <span class="va">vals</span> <span class="op">&lt;-</span> <span class="va">vals</span><span class="op">[</span><span class="va">hasdata</span><span class="op">]</span></span>
<span>      <span class="va">extr</span> <span class="op">&lt;-</span> <span class="va">extr</span><span class="op">[</span><span class="va">hasdata</span><span class="op">]</span></span>
<span>      <span class="va">labels</span> <span class="op">&lt;-</span> <span class="va">labels</span><span class="op">[</span><span class="va">hasdata</span><span class="op">]</span></span>
<span>    <span class="op">}</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co"># - ORDER RESULTS - #</span></span>
<span>  <span class="co"># Finds relevant order depending on spl_child_order()</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="fu"><a href="../../reference/int_methods.html">spl_child_order</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/methods/is.html" class="external-link">is</a></span><span class="op">(</span><span class="va">spl</span>, <span class="st">"AllSplit"</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">vord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">vord</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/match.html" class="external-link">match</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="../../reference/int_methods.html">spl_child_order</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span>,</span>
<span>      <span class="va">vals</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">vord</span> <span class="op">&lt;-</span> <span class="va">vord</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">vord</span><span class="op">)</span><span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="co">## FIXME: should be an S4 object, not a list</span></span>
<span>  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>    values <span class="op">=</span> <span class="va">vals</span><span class="op">[</span><span class="va">vord</span><span class="op">]</span>,</span>
<span>    datasplit <span class="op">=</span> <span class="va">dpart</span><span class="op">[</span><span class="va">vord</span><span class="op">]</span>,</span>
<span>    labels <span class="op">=</span> <span class="va">labels</span><span class="op">[</span><span class="va">vord</span><span class="op">]</span>,</span>
<span>    extras <span class="op">=</span> <span class="va">extr</span><span class="op">[</span><span class="va">vord</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">ret</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>After reading through <code>.apply_split_inner</code>, we see that
there are some fundamental functions - defined strictly for internal use
(by convention they start with “.”) - that are generics and depend on
the kind of split in input. <code>R/split_funs.R</code> is very kind and
groups generic definitions at the beginning of the file. These functions
are the main dispatchers for the majority of the split machinery. This
is a clear example that shows how using <code>S4</code> logic enables
better clarity and flexibility in programming, allowing for easy
extension of the program. For compactness we also show the
<code>showMethods</code> result for each generic.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="co"># Retrieves the values that will constitute the splits (facets), not necessarily a unique list.</span></span>
<span><span class="co"># They could come from the data cuts for example -&gt; it can be anything that produces a set of strings.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html" class="external-link">setGeneric</a></span><span class="op">(</span></span>
<span>  <span class="st">".applysplit_rawvals"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html" class="external-link">standardGeneric</a></span><span class="op">(</span><span class="st">".applysplit_rawvals"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Browse[2]&gt; showMethods(.applysplit_rawvals)</span></span>
<span><span class="co"># Function: .applysplit_rawvals (package rtables)</span></span>
<span><span class="co"># spl="AllSplit"</span></span>
<span><span class="co"># spl="ManualSplit"</span></span>
<span><span class="co"># spl="MultiVarSplit"</span></span>
<span><span class="co"># spl="VAnalyzeSplit"</span></span>
<span><span class="co"># spl="VarLevelSplit"</span></span>
<span><span class="co"># spl="VarStaticCutSplit"</span></span>
<span><span class="co"># Nothing here is inherited from the virtual class Split!!!</span></span>
<span></span>
<span><span class="co"># Contains the subset of the data (default, but these can overlap and can also NOT be mutually exclusive).</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html" class="external-link">setGeneric</a></span><span class="op">(</span></span>
<span>  <span class="st">".applysplit_datapart"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html" class="external-link">standardGeneric</a></span><span class="op">(</span><span class="st">".applysplit_datapart"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Same as .applysplit_rawvals</span></span>
<span></span>
<span><span class="co"># Extract the extra parameter for the split</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html" class="external-link">setGeneric</a></span><span class="op">(</span></span>
<span>  <span class="st">".applysplit_extras"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html" class="external-link">standardGeneric</a></span><span class="op">(</span><span class="st">".applysplit_extras"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Browse[2]&gt; showMethods(.applysplit_extras)</span></span>
<span><span class="co"># Function: .applysplit_extras (package rtables)</span></span>
<span><span class="co"># spl="AllSplit"</span></span>
<span><span class="co">#     (inherited from: spl="Split")</span></span>
<span><span class="co"># spl="Split"</span></span>
<span><span class="co"># This means there is only a function for the virtual class Split.</span></span>
<span><span class="co">#  So all splits behave the same!!!</span></span>
<span></span>
<span><span class="co"># Split label retrieval and assignment if visible.</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html" class="external-link">setGeneric</a></span><span class="op">(</span></span>
<span>  <span class="st">".applysplit_partlabels"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span>, <span class="va">labels</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html" class="external-link">standardGeneric</a></span><span class="op">(</span><span class="st">".applysplit_partlabels"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Browse[2]&gt; showMethods(.applysplit_partlabels)</span></span>
<span><span class="co"># Function: .applysplit_partlabels (package rtables)</span></span>
<span><span class="co"># spl="AllSplit"</span></span>
<span><span class="co">#     (inherited from: spl="Split")</span></span>
<span><span class="co"># spl="MultiVarSplit"</span></span>
<span><span class="co"># spl="Split"</span></span>
<span><span class="co"># spl="VarLevelSplit"</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html" class="external-link">setGeneric</a></span><span class="op">(</span></span>
<span>  <span class="st">"check_validsplit"</span>, <span class="co"># our friend</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html" class="external-link">standardGeneric</a></span><span class="op">(</span><span class="st">"check_validsplit"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Note: check_validsplit is an internal function but may one day be exported.</span></span>
<span><span class="co">#       This is why it does not have the "." prefix.</span></span>
<span></span>
<span><span class="kw"><a href="https://rdrr.io/r/methods/setGeneric.html" class="external-link">setGeneric</a></span><span class="op">(</span></span>
<span>  <span class="st">".applysplit_ref_vals"</span>,</span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/standardGeneric.html" class="external-link">standardGeneric</a></span><span class="op">(</span><span class="st">".applysplit_ref_vals"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Browse[2]&gt; showMethods(.applysplit_ref_vals)</span></span>
<span><span class="co"># Function: .applysplit_ref_vals (package rtables)</span></span>
<span><span class="co"># spl="Split"</span></span>
<span><span class="co"># spl="VarLevWBaselineSplit"</span></span></code></pre></div>
<p>Now, we know that <code>.applysplit_extras</code> is the function
that will be called first. This is because we did not specify any
<code>vals</code> and it is therefore <code>NULL</code>. This is an
<code>S4</code> generic function as can be seen by
<code>showMethod(.applysplit_extras)</code>, and its definition can be
seen in the following:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>Browse[<span class="dv">3</span>]<span class="sc">&gt;</span> <span class="fu">getMethod</span>(<span class="st">".applysplit_rawvals"</span>, <span class="st">"AllSplit"</span>)</span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>Method Definition<span class="sc">:</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a></span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a><span class="cf">function</span> (spl, df)</span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="fu">obj_name</span>(spl)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a></span>
<span id="cb10-8"><a href="#cb10-8" tabindex="-1"></a>Signatures<span class="sc">:</span></span>
<span id="cb10-9"><a href="#cb10-9" tabindex="-1"></a>        spl</span>
<span id="cb10-10"><a href="#cb10-10" tabindex="-1"></a>target  <span class="st">"AllSplit"</span></span>
<span id="cb10-11"><a href="#cb10-11" tabindex="-1"></a>defined <span class="st">"AllSplit"</span></span>
<span id="cb10-12"><a href="#cb10-12" tabindex="-1"></a></span>
<span id="cb10-13"><a href="#cb10-13" tabindex="-1"></a><span class="co"># What is obj_name -&gt; slot in spl</span></span>
<span id="cb10-14"><a href="#cb10-14" tabindex="-1"></a>Browse[<span class="dv">3</span>]<span class="sc">&gt;</span> <span class="fu">obj_name</span>(spl)</span>
<span id="cb10-15"><a href="#cb10-15" tabindex="-1"></a>[<span class="dv">1</span>] <span class="st">"all obs"</span></span>
<span id="cb10-16"><a href="#cb10-16" tabindex="-1"></a></span>
<span id="cb10-17"><a href="#cb10-17" tabindex="-1"></a><span class="co"># coming from</span></span>
<span id="cb10-18"><a href="#cb10-18" tabindex="-1"></a>Browse[<span class="dv">3</span>]<span class="sc">&gt;</span> <span class="fu">getMethod</span>(<span class="st">"obj_name"</span>, <span class="st">"Split"</span>)</span>
<span id="cb10-19"><a href="#cb10-19" tabindex="-1"></a>Method Definition<span class="sc">:</span></span>
<span id="cb10-20"><a href="#cb10-20" tabindex="-1"></a></span>
<span id="cb10-21"><a href="#cb10-21" tabindex="-1"></a><span class="cf">function</span> (obj)</span>
<span id="cb10-22"><a href="#cb10-22" tabindex="-1"></a>obj<span class="sc">@</span>name <span class="do">##### Slot that we could see from str(spl, max.level = 2)</span></span>
<span id="cb10-23"><a href="#cb10-23" tabindex="-1"></a></span>
<span id="cb10-24"><a href="#cb10-24" tabindex="-1"></a>Signatures<span class="sc">:</span></span>
<span id="cb10-25"><a href="#cb10-25" tabindex="-1"></a>        obj</span>
<span id="cb10-26"><a href="#cb10-26" tabindex="-1"></a>target  <span class="st">"Split"</span></span>
<span id="cb10-27"><a href="#cb10-27" tabindex="-1"></a>defined <span class="st">"Split"</span></span></code></pre></div>
<p>Then we have <code>.applysplit_extras</code>, which simply extracts
the extra arguments from the split objects and assigns them to their
relative split values. This function will be covered in more detail in a
later section. If still no split values are available, the function will
exit here with an empty split. Otherwise, the data will be divided into
different splits or data subsets (facets) with
<code>.applysplit_datapart</code>. In our current example, the resulting
list comprises the whole input dataset (do
<code>getMethod(".applysplit_datapart", "AllSplit")</code> and the list
will be evident: <code>function (spl, df, vals) list(df)</code>).</p>
<p>Next, split labels are checked. If they are not present, split values
(<code>vals</code>) will be used with
<code>.applysplit_partlabels</code>, transformed into
<code>as.character(vals)</code> if applied to a <code>Split</code>
object. Otherwise, the inserted labels are checked against the names of
split values.</p>
<p>Lastly, the split values are ordered according to
<code>spl_child_order</code>. In our case, which concerns the general
<code>AllSplit</code>, the sorting will not happen, i.e. it will be
dependent simply on the number of split values
(<code>seq_along(vals)</code>).</p>
</div>
</div>
<div class="section level2">
<h2 id="a-simple-split">A Simple Split<a class="anchor" aria-label="anchor" href="#a-simple-split"></a>
</h2>
<p>In the following, we demonstrate how row splits work using the
features that we have already described. We will add two splits and see
how the behavior of <code>do_split</code> changes. Note that if we do
not add an <code>analyze</code> call the split will behave as before,
giving an empty table with all observations. By default, calling
<code>analyze</code> on a variable will calculate the mean for each data
subset that has been generated by the splits. We want to go beyond the
first call of <code>do_split</code> that is by design applied on all
observations, with the purpose of generating the root split that
contains all data and all splits (indeed <code>AllSplit</code>). To
achieve this we use <code>debug(rtables:::do_split)</code> instead of
<code>debugonce(rtables:::do_split)</code> as we will need to step into
each of the splits. Alternatively, it is possible to use the more
powerful <code>trace</code> function to enter in cases where input is
from a specific class. To do so, the following can be used:
<code>trace("do_split", quote(if(!is(spl, "AllSplit")) browser()), where = asNamespace("rtables"))</code>.
Note that we specify the namespace with <code>where</code>. Multiple
tracer elements can be added with <code>expression(E1, E2)</code>, which
is the same as <code>c(quote(E1), quote(E2))</code>. Specific
<em>steps</em> can be specified with the <code>at</code> parameter.
Remember to call
<code>untrace("do_split", quote(if(!is(spl, "AllSplit")) browser()), where = asNamespace("rtables"))</code>
once finished to remove the trace.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/rtables" class="external-link">rtables</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span></span>
<span><span class="co"># This filter is added to avoid having too many calls to do_split</span></span>
<span><span class="va">DM_tmp</span> <span class="op">&lt;-</span> <span class="va">DM</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ARM</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/table.html" class="external-link">table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">$</span><span class="va">ARM</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># limit to two</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">SEX</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"M"</span>, <span class="st">"F"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># limit to two</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>SEX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">SEX</span><span class="op">)</span>, ARM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">ARM</span><span class="op">)</span><span class="op">)</span> <span class="co"># to drop unused levels</span></span>
<span></span>
<span><span class="co"># debug(rtables:::do_split)</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"BMRKR1"</span><span class="op">)</span> <span class="co"># analyze() is needed for the table to have non-label rows</span></span>
<span></span>
<span><span class="va">lyt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM_tmp</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##              all obs</span></span>
<span><span class="co">## ————————————————————</span></span>
<span><span class="co">## A: Drug X           </span></span>
<span><span class="co">##   F                 </span></span>
<span><span class="co">##     Mean      6.06  </span></span>
<span><span class="co">##   M                 </span></span>
<span><span class="co">##     Mean      5.42  </span></span>
<span><span class="co">## B: Placebo          </span></span>
<span><span class="co">##   F                 </span></span>
<span><span class="co">##     Mean      6.24  </span></span>
<span><span class="co">##   M                 </span></span>
<span><span class="co">##     Mean      5.97</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># undebug(rtables:::do_split)</span></span></code></pre></div>
<p>Before continuing, we want to check the formal class of
<code>spl</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>Browse[<span class="dv">2</span>]<span class="sc">&gt;</span> <span class="fu">str</span>(spl, <span class="at">max.level =</span> <span class="dv">2</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>Formal class <span class="st">'VarLevelSplit'</span> [package <span class="st">"rtables"</span>] with <span class="dv">20</span> slots</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>  ..<span class="sc">@</span> value_label_var        <span class="sc">:</span> chr <span class="st">"ARM"</span></span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>  ..<span class="sc">@</span> value_order            <span class="sc">:</span> chr [<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="st">"A: Drug X"</span> <span class="st">"B: Placebo"</span></span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>  ..<span class="sc">@</span> split_fun              <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>  ..<span class="sc">@</span> payload                <span class="sc">:</span> chr <span class="st">"ARM"</span></span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a>  ..<span class="sc">@</span> name                   <span class="sc">:</span> chr <span class="st">"ARM"</span></span>
<span id="cb14-9"><a href="#cb14-9" tabindex="-1"></a>  ..<span class="sc">@</span> split_label            <span class="sc">:</span> chr <span class="st">"ARM"</span></span>
<span id="cb14-10"><a href="#cb14-10" tabindex="-1"></a>  ..<span class="sc">@</span> split_format           <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb14-11"><a href="#cb14-11" tabindex="-1"></a>  ..<span class="sc">@</span> split_na_str           <span class="sc">:</span> chr <span class="cn">NA</span></span>
<span id="cb14-12"><a href="#cb14-12" tabindex="-1"></a>  ..<span class="sc">@</span> split_label_position   <span class="sc">:</span> chr <span class="st">"hidden"</span></span>
<span id="cb14-13"><a href="#cb14-13" tabindex="-1"></a>  ..<span class="sc">@</span> content_fun            <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb14-14"><a href="#cb14-14" tabindex="-1"></a>  ..<span class="sc">@</span> content_format         <span class="sc">:</span> <span class="cn">NULL</span></span>
<span id="cb14-15"><a href="#cb14-15" tabindex="-1"></a>  ..<span class="sc">@</span> content_na_str         <span class="sc">:</span> chr <span class="cn">NA</span></span>
<span id="cb14-16"><a href="#cb14-16" tabindex="-1"></a>  ..<span class="sc">@</span> content_var            <span class="sc">:</span> chr <span class="st">""</span></span>
<span id="cb14-17"><a href="#cb14-17" tabindex="-1"></a>  ..<span class="sc">@</span> label_children         <span class="sc">:</span> logi <span class="cn">NA</span></span>
<span id="cb14-18"><a href="#cb14-18" tabindex="-1"></a>  ..<span class="sc">@</span> extra_args             <span class="sc">:</span> <span class="fu">list</span>()</span>
<span id="cb14-19"><a href="#cb14-19" tabindex="-1"></a>  ..<span class="sc">@</span> indent_modifier        <span class="sc">:</span> int <span class="dv">0</span></span>
<span id="cb14-20"><a href="#cb14-20" tabindex="-1"></a>  ..<span class="sc">@</span> content_indent_modifier<span class="sc">:</span> int <span class="dv">0</span></span>
<span id="cb14-21"><a href="#cb14-21" tabindex="-1"></a>  ..<span class="sc">@</span> content_extra_args     <span class="sc">:</span> <span class="fu">list</span>()</span>
<span id="cb14-22"><a href="#cb14-22" tabindex="-1"></a>  ..<span class="sc">@</span> page_title_prefix      <span class="sc">:</span> chr <span class="cn">NA</span></span>
<span id="cb14-23"><a href="#cb14-23" tabindex="-1"></a>  ..<span class="sc">@</span> child_section_div      <span class="sc">:</span> chr <span class="cn">NA</span></span></code></pre></div>
<p>From this, we can directly infer that the class is different now
(<code>VarLevelSplit</code>) and understand that the split label will be
hidden (<code>split_label_position</code> slot). Moreover, we see a
specific value order with specific split values.
<code>VarLevelSplit</code> also seems to have three more slots than
<code>AllSplit</code>. What are they precisely?</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="va">slots_as</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">getSlots</a></span><span class="op">(</span><span class="st">"AllSplit"</span><span class="op">)</span> <span class="co"># inherits virtual class Split and is general class for all splits</span></span>
<span><span class="co"># getClass("CustomizableSplit") # -&gt; Extends: "Split", Known Subclasses: Class "VarLevelSplit", directly</span></span>
<span><span class="va">slots_cs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">getSlots</a></span><span class="op">(</span><span class="st">"CustomizableSplit"</span><span class="op">)</span> <span class="co"># Adds split function</span></span>
<span><span class="va">slots_vls</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/methods/slot.html" class="external-link">getSlots</a></span><span class="op">(</span><span class="st">"VarLevelSplit"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">slots_cs</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slots_cs</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slots_as</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co">#        split_fun</span></span>
<span><span class="co"># "functionOrNULL"</span></span>
<span><span class="va">slots_vls</span><span class="op">[</span><span class="op">!</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slots_vls</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">slots_cs</span><span class="op">)</span><span class="op">)</span><span class="op">]</span></span>
<span><span class="co"># value_label_var     value_order</span></span>
<span><span class="co">#     "character"           "ANY"</span></span></code></pre></div>
<p>Remember to always check the constructor and class definition in
<code>R/00tabletrees.R</code> if exploratory tools do not suffice. Now,
<code>check_validsplit(spl, df)</code> will use a different method than
before (<code>getMethod("check_validsplit", "VarLevelSplit")</code>). It
uses the internal utility function <code>.checkvarsok</code> to check if
<code>vars</code>, i.e. the <code>payload</code>, is actually present in
<code>names(df)</code>.</p>
<p>The next relevant function will be <code>.apply_split_inner</code>,
and we will exactly what changes using
<code>debugonce(.apply_split_inner)</code>. Of course, this function is
called directly as no custom split function is provided. Since parameter
<code>vals</code> is not specified (<code>NULL</code>), the split values
are retrieved from <code>df</code> by using the split payload to select
specific columns (<code>varvec &lt;- df[[spl_payload(spl)]]</code>).
Whenever no split values are specified they are retrieved from the
selected column as unique values (<code>character</code>) or levels
(<code>factor</code>).</p>
<p>Next, <code>.applysplit_datapart</code> creates a named list of
facets or data subsets. In this case, the result is actually a mutually
exclusive partition of the data. This is because we did not specify any
split values and as such the column content was retrieved via
<code>unique</code> (in case of a character vector) or
<code>levels</code> (in case of factors).
<code>.applysplit_partlabels</code> is a bit less linear as it has to
take into account the possibility of having specified labels in the
payload. Instead of looking at the function source code with
<code>getMethod(".applysplit_partlabels", "VarLevelSplit")</code>, we
can enter the <code>S4</code> generic function in debugging mode as
follows:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/eval.html" class="external-link">eval</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/utils/debugcall.html" class="external-link">debugcall</a></span><span class="op">(</span><span class="fu">.applysplit_partlabels</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span>, <span class="va">labels</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># We leave to the smart developer to see how the labels are assigned</span></span>
<span></span>
<span><span class="co"># Remember to undebugcall() similarly!</span></span></code></pre></div>
<p>In our case, the final labels are <code>vals</code> because they were
not explicitly assigned. Their order is retrieved from the split object
(<code>spl_child_order(spl)</code>) and matched with current split
values. The returned list is then processed as it was before.</p>
<p>If we continue with the next call of <code>do_split</code>, the same
procedure is followed for the second <code>ARM</code> split. This is
applied to the partition that was created in the first split. The main
<code>df</code> is now constituted by a subset (facet) of the total
data, determined by the first split. This will be repeated iteratively
for as many data splits as requested. Before concluding this iteration,
we take a moment to discuss in detail how
<code>.fixupvals(partinfo)</code> works. This is not a generic function
and the source code can be easily accessed. We suggest running through
it with <code>debugonce(.fixupvals)</code> to understand what it does in
practice. The fundamental aspects of <code>.fixupvals(partinfo)</code>
are as follows:</p>
<ul>
<li>Ensures that labels are character and not factor.</li>
<li>Ensures that the splits of data and list of values are named
according to labels.</li>
<li>Guarantees that <code>ret$values</code> contains
<code>SplitValue</code> objects.</li>
<li>Removes the list element <code>extra</code> since it is now included
in the <code>SplitValue</code>.</li>
</ul>
<p>Note that this function can occasionally be called more than once on
the same return object (a named list for now). Of course, after the
first call only checks are applied.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a><span class="co"># Can find the following core function:</span></span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a><span class="co"># vals &lt;- make_splvalue_vec(vals, extr, labels = labels)</span></span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a><span class="co"># ---&gt; Main list of SplitValue objects: iterative call of</span></span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a><span class="co">#      new("SplitValue", value = val, extra = extr, label = label)</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a></span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a><span class="co"># Structure of ret before calling .fixupvals</span></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>Browse[<span class="dv">2</span>]<span class="sc">&gt;</span> <span class="fu">str</span>(ret, <span class="at">max.level =</span> <span class="dv">2</span>)</span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>List of <span class="dv">4</span></span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a> <span class="sc">$</span> values   <span class="sc">:</span> chr [<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="st">"A: Drug X"</span> <span class="st">"B: Placebo"</span></span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a> <span class="sc">$</span> datasplit<span class="sc">:</span>List of <span class="dv">2</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>  ..<span class="sc">$</span> A<span class="sc">:</span> Drug X <span class="sc">:</span> tibble [<span class="dv">121</span> × <span class="dv">8</span>] (S3<span class="sc">:</span> tbl_df<span class="sc">/</span>tbl<span class="sc">/</span>data.frame)</span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  ..<span class="sc">$</span> B<span class="sc">:</span> Placebo<span class="sc">:</span> tibble [<span class="dv">106</span> × <span class="dv">8</span>] (S3<span class="sc">:</span> tbl_df<span class="sc">/</span>tbl<span class="sc">/</span>data.frame)</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a> <span class="sc">$</span> labels   <span class="sc">:</span> Named chr [<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="st">"A: Drug X"</span> <span class="st">"B: Placebo"</span></span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>  ..<span class="sc">-</span> <span class="fu">attr</span>(<span class="sc">*</span>, <span class="st">"names"</span>)<span class="ot">=</span> chr [<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="st">"A: Drug X"</span> <span class="st">"B: Placebo"</span></span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a> <span class="sc">$</span> extras   <span class="sc">:</span>List of <span class="dv">2</span></span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>  ..<span class="sc">$</span> <span class="er">:</span> <span class="fu">list</span>()</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>  ..<span class="sc">$</span> <span class="er">:</span> <span class="fu">list</span>()</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a></span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a><span class="co"># Structure of ret after the function call</span></span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>Browse[<span class="dv">2</span>]<span class="sc">&gt;</span> <span class="fu">str</span>(<span class="fu">.fixupvals</span>(ret), <span class="at">max.level =</span> <span class="dv">2</span>)</span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>List of <span class="dv">3</span></span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a> <span class="sc">$</span> values   <span class="sc">:</span>List of <span class="dv">2</span></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>  ..<span class="sc">$</span> A<span class="sc">:</span> Drug X <span class="sc">:</span>Formal class <span class="st">'SplitValue'</span> [package <span class="st">"rtables"</span>] with <span class="dv">3</span> slots</span>
<span id="cb17-26"><a href="#cb17-26" tabindex="-1"></a>  ..<span class="sc">$</span> B<span class="sc">:</span> Placebo<span class="sc">:</span>Formal class <span class="st">'SplitValue'</span> [package <span class="st">"rtables"</span>] with <span class="dv">3</span> slots</span>
<span id="cb17-27"><a href="#cb17-27" tabindex="-1"></a> <span class="sc">$</span> datasplit<span class="sc">:</span>List of <span class="dv">2</span></span>
<span id="cb17-28"><a href="#cb17-28" tabindex="-1"></a>  ..<span class="sc">$</span> A<span class="sc">:</span> Drug X <span class="sc">:</span> tibble [<span class="dv">121</span> × <span class="dv">8</span>] (S3<span class="sc">:</span> tbl_df<span class="sc">/</span>tbl<span class="sc">/</span>data.frame)</span>
<span id="cb17-29"><a href="#cb17-29" tabindex="-1"></a>  ..<span class="sc">$</span> B<span class="sc">:</span> Placebo<span class="sc">:</span> tibble [<span class="dv">106</span> × <span class="dv">8</span>] (S3<span class="sc">:</span> tbl_df<span class="sc">/</span>tbl<span class="sc">/</span>data.frame)</span>
<span id="cb17-30"><a href="#cb17-30" tabindex="-1"></a> <span class="sc">$</span> labels   <span class="sc">:</span> Named chr [<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="st">"A: Drug X"</span> <span class="st">"B: Placebo"</span></span>
<span id="cb17-31"><a href="#cb17-31" tabindex="-1"></a>  ..<span class="sc">-</span> <span class="fu">attr</span>(<span class="sc">*</span>, <span class="st">"names"</span>)<span class="ot">=</span> chr [<span class="dv">1</span><span class="sc">:</span><span class="dv">2</span>] <span class="st">"A: Drug X"</span> <span class="st">"B: Placebo"</span></span>
<span id="cb17-32"><a href="#cb17-32" tabindex="-1"></a></span>
<span id="cb17-33"><a href="#cb17-33" tabindex="-1"></a><span class="co"># The SplitValue object is fundamental</span></span>
<span id="cb17-34"><a href="#cb17-34" tabindex="-1"></a>Browse[<span class="dv">2</span>]<span class="sc">&gt;</span> <span class="fu">str</span>(ret<span class="sc">$</span>values)</span>
<span id="cb17-35"><a href="#cb17-35" tabindex="-1"></a>List of <span class="dv">2</span></span>
<span id="cb17-36"><a href="#cb17-36" tabindex="-1"></a> <span class="sc">$</span> A<span class="sc">:</span> Drug X <span class="sc">:</span>Formal class <span class="st">'SplitValue'</span> [package <span class="st">"rtables"</span>] with <span class="dv">3</span> slots</span>
<span id="cb17-37"><a href="#cb17-37" tabindex="-1"></a>  .. ..<span class="sc">@</span> extra<span class="sc">:</span> <span class="fu">list</span>()</span>
<span id="cb17-38"><a href="#cb17-38" tabindex="-1"></a>  .. ..<span class="sc">@</span> value<span class="sc">:</span> chr <span class="st">"A: Drug X"</span></span>
<span id="cb17-39"><a href="#cb17-39" tabindex="-1"></a>  .. ..<span class="sc">@</span> label<span class="sc">:</span> chr <span class="st">"A: Drug X"</span></span>
<span id="cb17-40"><a href="#cb17-40" tabindex="-1"></a> <span class="sc">$</span> B<span class="sc">:</span> Placebo<span class="sc">:</span>Formal class <span class="st">'SplitValue'</span> [package <span class="st">"rtables"</span>] with <span class="dv">3</span> slots</span>
<span id="cb17-41"><a href="#cb17-41" tabindex="-1"></a>  .. ..<span class="sc">@</span> extra<span class="sc">:</span> <span class="fu">list</span>()</span>
<span id="cb17-42"><a href="#cb17-42" tabindex="-1"></a>  .. ..<span class="sc">@</span> value<span class="sc">:</span> chr <span class="st">"B: Placebo"</span></span>
<span id="cb17-43"><a href="#cb17-43" tabindex="-1"></a>  .. ..<span class="sc">@</span> label<span class="sc">:</span> chr <span class="st">"B: Placebo"</span></span></code></pre></div>
<div class="section level3">
<h3 id="pre-made-split-functions">Pre-Made Split Functions<a class="anchor" aria-label="anchor" href="#pre-made-split-functions"></a>
</h3>
<p>We start by examining a split function that is already defined in
<code>rtables</code>. Its scope is filtering out specific values as
follows:</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/rtables" class="external-link">rtables</a></span><span class="op">)</span></span>
<span><span class="co"># debug(rtables:::do_split) # uncomment to see into the main split function</span></span>
<span><span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">drop_split_levels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"BMRKR1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##          all obs</span></span>
<span><span class="co">## ————————————————</span></span>
<span><span class="co">## F               </span></span>
<span><span class="co">##   Mean    6.04  </span></span>
<span><span class="co">## M               </span></span>
<span><span class="co">##   Mean    5.64</span></span></code></pre>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># undebug(rtables:::do_split)</span></span>
<span></span>
<span><span class="co"># This produces the same output as before (when filters were used)</span></span></code></pre></div>
<p>After the root split, we enter the split based on <code>SEX</code>.
As we have specified a split function, we can retrieve the split
function by using <code>splfun &lt;- split_fun(spl)</code> and enter an
if-else statement for the two possible cases: whether there is split
context or not. In both cases, an error catching framework is used to
give informative errors in case of failure. Later we will see more in
depth how this works.</p>
<p>We invite the reader to always keep an eye on
<code>spl_context</code>, as it is fundamental to more sophisticated
splits, e.g. in the cases where the split itself depends mainly on
preceding splits or values. When the split function is called, please
take a moment to look at how <code>drop_split_levels</code> is defined.
You will see that the function is fundamentally a wrapper of
<code>.apply_split_inner</code> that drops empty factor levels,
therefore avoiding empty splits.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a><span class="sc">&gt;</span> drop_split_levels</span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="cf">function</span>(df,</span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>         spl,</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>         <span class="at">vals =</span> <span class="cn">NULL</span>,</span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>         <span class="at">labels =</span> <span class="cn">NULL</span>,</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>         <span class="at">trim =</span> <span class="cn">FALSE</span>) {</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a>  <span class="co"># Retrieve split column</span></span>
<span id="cb21-9"><a href="#cb21-9" tabindex="-1"></a>  var <span class="ot">&lt;-</span> <span class="fu">spl_payload</span>(spl)</span>
<span id="cb21-10"><a href="#cb21-10" tabindex="-1"></a>  df2 <span class="ot">&lt;-</span> df</span>
<span id="cb21-11"><a href="#cb21-11" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" tabindex="-1"></a>  <span class="do">## This call is exactly the one we used when filtering to get rid of empty levels</span></span>
<span id="cb21-13"><a href="#cb21-13" tabindex="-1"></a>  df2[[var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(df[[var]])</span>
<span id="cb21-14"><a href="#cb21-14" tabindex="-1"></a></span>
<span id="cb21-15"><a href="#cb21-15" tabindex="-1"></a>  <span class="do">## Our main function!</span></span>
<span id="cb21-16"><a href="#cb21-16" tabindex="-1"></a>  <span class="fu">.apply_split_inner</span>(spl, df2,</span>
<span id="cb21-17"><a href="#cb21-17" tabindex="-1"></a>    <span class="at">vals =</span> vals,</span>
<span id="cb21-18"><a href="#cb21-18" tabindex="-1"></a>    <span class="at">labels =</span> labels,</span>
<span id="cb21-19"><a href="#cb21-19" tabindex="-1"></a>    <span class="at">trim =</span> trim</span>
<span id="cb21-20"><a href="#cb21-20" tabindex="-1"></a>  )</span>
<span id="cb21-21"><a href="#cb21-21" tabindex="-1"></a>}</span></code></pre></div>
<p>There are many pre-made split functions included in
<code>rtables</code>. A list of these functions can be found in the <a href="https://insightsengineering.github.io/rtables/main/articles/split_functions.html">Split
Functions vignette</a>, or via <code><a href="../../reference/split_funcs.html">?split_funcs</a></code>. We leave it to
the developer to look into how some of these split functions work, in
particular <code>trim_levels_to_map</code> may be of interest.</p>
</div>
<div class="section level3">
<h3 id="creating-custom-split-functions">Creating Custom Split Functions<a class="anchor" aria-label="anchor" href="#creating-custom-split-functions"></a>
</h3>
<p>Now we will create a custom split function. Firstly, we will see how
the system manages error messages. For a general understanding of how
custom split functions are created, please read the <a href="https://insightsengineering.github.io/rtables/main/articles/advanced_usage.html#custom-split-functions">Custom
Split Functions section</a> of the Advanced Usage vignette or see
<code><a href="../../reference/custom_split_funs.html">?custom_split_funs</a></code>. In the following code we use
<code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> to enter our custom split functions. We invite
the reader to activate <code>options(error = recover)</code> to
investigate cases where we encounter an error. Note that you can revert
to default behavior by restarting your <code>R</code> session, by
caching the default option value, or by using <code>callr</code> to
retrieve the default as follows:
<code>default_opts &lt;- callr::r(function(){options()}); options(error = default_opts$error)</code>.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="co"># Table call with only the function changing</span></span>
<span><span class="va">simple_table</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">DM</span>, <span class="va">f</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span>, split_fun <span class="op">=</span> <span class="va">f</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"BMRKR1"</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">lyt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># First round will fail because there are unused arguments</span></span>
<span><span class="va">exploratory_split_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span><span class="op">)</span> <span class="cn">NULL</span></span>
<span><span class="co"># debug(rtables:::do_split)</span></span>
<span><span class="va">err_msg</span> <span class="op">&lt;-</span> <span class="kw"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">tryCatch</a></span><span class="op">(</span><span class="fu">simple_table</span><span class="op">(</span><span class="va">DM</span>, <span class="va">exploratory_split_fun</span><span class="op">)</span>, error <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">e</span><span class="op">)</span> <span class="va">e</span><span class="op">)</span></span>
<span><span class="co"># undebug(rtables:::do_split)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="va">err_msg</span><span class="op">$</span><span class="va">message</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Error applying custom split function: unused arguments (vals, labels, trim = trim)</span></span>
<span><span class="co">##  split: VarLevelSplit (ARM)</span></span>
<span><span class="co">##  occured at path: root</span></span></code></pre>
<p>The commented debugging lines above will allow you to inspect the
error. Alternatively, using the recover option will allow you the
possibility to select the frame number, i.e. the trace level, to enter.
Selecting the last frame number (10 in this case) will allow you to see
the value of <code>ret</code> from <code>rtables:::do_split</code> that
causes the error and how the informative error message that follows is
created.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a><span class="co"># Debugging level</span></span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="dv">10</span><span class="sc">:</span> tt_dotabulation.R<span class="co">#627: do_split(spl, df, spl_context = spl_context)</span></span>
<span id="cb24-4"><a href="#cb24-4" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" tabindex="-1"></a><span class="co"># Original call and final error</span></span>
<span id="cb24-6"><a href="#cb24-6" tabindex="-1"></a><span class="sc">&gt;</span> <span class="fu">simple_table</span>(DM, exploratory_split_fun)</span>
<span id="cb24-7"><a href="#cb24-7" tabindex="-1"></a>Error <span class="cf">in</span> <span class="fu">do_split</span>(spl, df, <span class="at">spl_context =</span> spl_context) <span class="sc">:</span></span>
<span id="cb24-8"><a href="#cb24-8" tabindex="-1"></a>  Error applying custom split <span class="cf">function</span><span class="sc">:</span> unused <span class="fu">arguments</span> (vals, labels, <span class="at">trim =</span> trim) <span class="co"># This is main error</span></span>
<span id="cb24-9"><a href="#cb24-9" tabindex="-1"></a>    split<span class="sc">:</span> <span class="fu">VarLevelSplit</span> (ARM) <span class="co"># Split reference</span></span>
<span id="cb24-10"><a href="#cb24-10" tabindex="-1"></a>    occured at path<span class="sc">:</span> root <span class="co"># Path level (where it occurred)</span></span></code></pre></div>
<p>The previous split function fails because
<code>exploratory_split_fun</code> is given more arguments than it
accepts. A simple way to avoid this is to add <code>...</code> to the
function call. Now let’s construct an interesting split function (and
error):</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="va">f_brakes_if</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">split_col</span> <span class="op">=</span> <span class="cn">NULL</span>, <span class="va">error</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span> <span class="co"># order matters! more than naming</span></span>
<span>    <span class="co"># browser() # To check how it works</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">split_col</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span> <span class="co"># Retrieves the default</span></span>
<span>      <span class="va">split_col</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/spl_variable.html">spl_variable</a></span><span class="op">(</span><span class="va">spl</span><span class="op">)</span> <span class="co"># Internal accessor to split obj</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">my_payload</span> <span class="op">&lt;-</span> <span class="va">split_col</span> <span class="co"># Changing split column value</span></span>
<span></span>
<span>    <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">my_payload</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="co"># Extracting values to split</span></span>
<span>    <span class="va">datasplit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_along</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">df</span><span class="op">[</span><span class="va">df</span><span class="op">[[</span><span class="va">my_payload</span><span class="op">]</span><span class="op">]</span> <span class="op">==</span> <span class="va">vals</span><span class="op">[[</span><span class="va">i</span><span class="op">]</span><span class="op">]</span>, <span class="op">]</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">datasplit</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Error</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">error</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="co"># browser() # If you need to check how it works</span></span>
<span>      <span class="va">mystery_error_values</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="va">datasplit</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">x</span><span class="op">$</span><span class="va">BMRKR1</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">mystery_error_values</span> <span class="op">&gt;</span> <span class="fl">6</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span></span>
<span>          <span class="st">"It should not be more than 6! Should it be? Found in split values: "</span>,</span>
<span>          <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">datasplit</span><span class="op">)</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">mystery_error_values</span> <span class="op">&gt;</span> <span class="fl">6</span><span class="op">)</span><span class="op">]</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Handy function to return a split result!!</span></span>
<span>    <span class="fu"><a href="../../reference/make_split_result.html">make_split_result</a></span><span class="op">(</span><span class="va">vals</span>, <span class="va">datasplit</span>, <span class="va">vals</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span><span class="fu">simple_table</span><span class="op">(</span><span class="va">DM</span>, <span class="fu">f_brakes_if</span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="co"># works!</span></span></code></pre></div>
<pre><code><span><span class="co">##                  all obs</span></span>
<span><span class="co">## ————————————————————————</span></span>
<span><span class="co">## A: Drug X               </span></span>
<span><span class="co">##   Mean            5.79  </span></span>
<span><span class="co">## B: Placebo              </span></span>
<span><span class="co">##   Mean            6.11  </span></span>
<span><span class="co">## C: Combination          </span></span>
<span><span class="co">##   Mean            5.69</span></span></code></pre>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">simple_table</span><span class="op">(</span><span class="va">DM</span>, <span class="fu">f_brakes_if</span><span class="op">(</span>split_col <span class="op">=</span> <span class="st">"STRATA1"</span><span class="op">)</span><span class="op">)</span> <span class="co"># works!</span></span></code></pre></div>
<pre><code><span><span class="co">##          all obs</span></span>
<span><span class="co">## ————————————————</span></span>
<span><span class="co">## A               </span></span>
<span><span class="co">##   Mean    5.95  </span></span>
<span><span class="co">## B               </span></span>
<span><span class="co">##   Mean    5.90  </span></span>
<span><span class="co">## C               </span></span>
<span><span class="co">##   Mean    5.71</span></span></code></pre>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># simple_table(DM, f_brakes_if(error = TRUE)) # does not work, but returns an informative message</span></span>
<span></span>
<span><span class="co"># Error in do_split(spl, df, spl_context = spl_context) :</span></span>
<span><span class="co"># Error applying custom split function: It should not be more than 6! Should it be? Found in split values: B: Placebo</span></span>
<span><span class="co"># split: VarLevelSplit (ARM)</span></span>
<span><span class="co"># occurred at path: root</span></span></code></pre></div>
<p>Now we will take a moment to dwell on the machinery included in
<code>rtables</code> to create custom split functions. Before doing so,
please read the relevant documentation at <code><a href="../../reference/make_split_fun.html">?make_split_fun</a></code>.
Most of the pre-made split functions included in <code>rtables</code>
are or will be written with <code>make_split_fun</code> as it is a more
stable constructor for such functions than was previously used. We
invite the reader to take a look at <code>make_split_fun.R</code>. The
majority of the functions here should be understandable with the
knowledge you have gained from this guide so far. It is important to
note that if no core split function is specified, which is commonly the
case, <code>make_split_fun</code> calls <code>do_base_split</code>
directly, which is a minimal wrapper of the well-known
<code>do_split</code>. <code>drop_facet_levels</code>, for example, is a
pre-processing function that at its core simply removes empty factor
levels from the split “column”, thus avoiding showing empty lines.</p>
<p>It is also possible to provide a list of functions, as it can be seen
in the examples of <code><a href="../../reference/make_split_fun.html">?make_split_fun</a></code>. Note that pre- and
post-processing requires a list as input to support the possibility of
combining multiple functions. In contrast, the core splitting function
must be a single function call as it is not expected to have stacked
features. This rarely needs to be modified and the majority of the
included split functions work with pre- or post-processing. Included
post-processing functions are interesting as they interact with the
split object, e.g. by reordering the facets or by adding an overall
facet (<code>add_overall_facet</code>). The attentive reader will have
noticed that the core function relies on <code>do_split</code> and many
of the post-processing functions rely on <code>make_split_result</code>,
which is the best way to get the correct split return structure. Note
that modifying the core split only works in the row space at the
moment.</p>
<div class="section level4">
<h4 id="spl_context---adding-context-to-our-splits">
<code>.spl_context</code> - Adding Context to Our Splits<a class="anchor" aria-label="anchor" href="#spl_context---adding-context-to-our-splits"></a>
</h4>
<p>The best way to understand what split context does, and how to use
it, is to read the <a href="https://insightsengineering.github.io/rtables/main/articles/advanced_usage.html#leveraging--spl_context">Leveraging
<code>.spl_context</code> section</a> of the Advanced Usage vignette,
and to use <code><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser()</a></code> within a split function to see how it
is structured. As <code>.spl_context</code> is needed for rewriting core
functions, we propose a wrapper of <code>do_base_split</code> here,
which is a handy redirection to the standard <code>do_split</code>
without the split function part (i.e. it is a wrapper of
<code>.apply_split_inner</code>, the real core splitting machinery). Out
of curiosity, we set <code>trim = TRUE</code> here. This trimming only
works when there is a mixed table (some values are 0s and some have
content), for which it will trim 0s. This is rarely the case, and we
encourage using the replacement functions
<code>trim_levels_to_group</code> and <code>trim_levels_to_map</code>
for trimming. Nowadays, it should even be impossible to set it
differently from <code>trim = FALSE</code>.</p>
<p>(write an issue informative error for not list xxx).</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="co"># rtables 0.6.2</span></span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a>browsing_f <span class="ot">&lt;-</span> <span class="cf">function</span>(df, spl, .spl_context, ...) {</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a>  <span class="co"># browser()</span></span>
<span id="cb30-4"><a href="#cb30-4" tabindex="-1"></a>  <span class="co"># do_base_split(df, spl, ...) # order matters!! This would fail if done</span></span>
<span id="cb30-5"><a href="#cb30-5" tabindex="-1"></a>  <span class="fu">do_base_split</span>(<span class="at">spl =</span> spl, <span class="at">df =</span> df, <span class="at">vals =</span> <span class="cn">NULL</span>, <span class="at">labels =</span> <span class="cn">NULL</span>, <span class="at">trim =</span> <span class="cn">TRUE</span>)</span>
<span id="cb30-6"><a href="#cb30-6" tabindex="-1"></a>}</span>
<span id="cb30-7"><a href="#cb30-7" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" tabindex="-1"></a>fnc_tmp <span class="ot">&lt;-</span> <span class="cf">function</span>(innervar) { <span class="co"># Exploring trim_levels_in_facets (check its form)</span></span>
<span id="cb30-9"><a href="#cb30-9" tabindex="-1"></a>  <span class="cf">function</span>(ret, ...) {</span>
<span id="cb30-10"><a href="#cb30-10" tabindex="-1"></a>    <span class="co"># browser()</span></span>
<span id="cb30-11"><a href="#cb30-11" tabindex="-1"></a>    <span class="cf">for</span> (var <span class="cf">in</span> innervar) { <span class="co"># of course AGE is not here, so nothing is dropped!!</span></span>
<span id="cb30-12"><a href="#cb30-12" tabindex="-1"></a>      ret<span class="sc">$</span>datasplit <span class="ot">&lt;-</span> <span class="fu">lapply</span>(ret<span class="sc">$</span>datasplit, <span class="cf">function</span>(df) {</span>
<span id="cb30-13"><a href="#cb30-13" tabindex="-1"></a>        df[[var]] <span class="ot">&lt;-</span> <span class="fu">factor</span>(df[[var]])</span>
<span id="cb30-14"><a href="#cb30-14" tabindex="-1"></a>        df</span>
<span id="cb30-15"><a href="#cb30-15" tabindex="-1"></a>      })</span>
<span id="cb30-16"><a href="#cb30-16" tabindex="-1"></a>    }</span>
<span id="cb30-17"><a href="#cb30-17" tabindex="-1"></a>    ret</span>
<span id="cb30-18"><a href="#cb30-18" tabindex="-1"></a>  }</span>
<span id="cb30-19"><a href="#cb30-19" tabindex="-1"></a>}</span>
<span id="cb30-20"><a href="#cb30-20" tabindex="-1"></a></span>
<span id="cb30-21"><a href="#cb30-21" tabindex="-1"></a><span class="fu">basic_table</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-22"><a href="#cb30-22" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"ARM"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-23"><a href="#cb30-23" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"STRATA1"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb30-24"><a href="#cb30-24" tabindex="-1"></a>  <span class="fu">split_rows_by_cuts</span>(<span class="st">"AGE"</span>,</span>
<span id="cb30-25"><a href="#cb30-25" tabindex="-1"></a>    <span class="at">cuts =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">100</span>),</span>
<span id="cb30-26"><a href="#cb30-26" tabindex="-1"></a>    <span class="at">cutlabels =</span> <span class="fu">c</span>(<span class="st">"young"</span>, <span class="st">"old"</span>)</span>
<span id="cb30-27"><a href="#cb30-27" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb30-28"><a href="#cb30-28" tabindex="-1"></a>  <span class="fu">split_rows_by</span>(<span class="st">"SEX"</span>, <span class="at">split_fun =</span> <span class="fu">make_split_fun</span>(</span>
<span id="cb30-29"><a href="#cb30-29" tabindex="-1"></a>    <span class="at">pre =</span> <span class="fu">list</span>(drop_facet_levels), <span class="co"># This is dropping the SEX levels (AGE is upper level)</span></span>
<span id="cb30-30"><a href="#cb30-30" tabindex="-1"></a>    <span class="at">core_split =</span> browsing_f,</span>
<span id="cb30-31"><a href="#cb30-31" tabindex="-1"></a>    <span class="at">post =</span> <span class="fu">list</span>(<span class="fu">fnc_tmp</span>(<span class="st">"AGE"</span>)) <span class="co"># To drop these we should use a split_fun in the above level</span></span>
<span id="cb30-32"><a href="#cb30-32" tabindex="-1"></a>  )) <span class="sc">%&gt;%</span></span>
<span id="cb30-33"><a href="#cb30-33" tabindex="-1"></a>  <span class="fu">summarize_row_groups</span>() <span class="sc">%&gt;%</span></span>
<span id="cb30-34"><a href="#cb30-34" tabindex="-1"></a>  <span class="fu">build_table</span>(DM)</span>
<span id="cb30-35"><a href="#cb30-35" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" tabindex="-1"></a><span class="co"># The following is the .spl_contest printout:</span></span>
<span id="cb30-37"><a href="#cb30-37" tabindex="-1"></a>Browse[<span class="dv">1</span>]<span class="sc">&gt;</span> .spl_context</span>
<span id="cb30-38"><a href="#cb30-38" tabindex="-1"></a>    split     value full_parent_df all_cols_n      all obs</span>
<span id="cb30-39"><a href="#cb30-39" tabindex="-1"></a><span class="dv">1</span>    root      root   <span class="fu">c</span>(<span class="st">"S1"</span>, ....        <span class="dv">356</span> <span class="cn">TRUE</span>, TR....</span>
<span id="cb30-40"><a href="#cb30-40" tabindex="-1"></a><span class="dv">2</span>     ARM A<span class="sc">:</span> Drug X   <span class="fu">c</span>(<span class="st">"S6"</span>, ....        <span class="dv">121</span> <span class="cn">TRUE</span>, TR....</span>
<span id="cb30-41"><a href="#cb30-41" tabindex="-1"></a><span class="dv">3</span> STRATA1         A   <span class="fu">c</span>(<span class="st">"S14"</span>,....         <span class="dv">36</span> <span class="cn">TRUE</span>, TR....</span>
<span id="cb30-42"><a href="#cb30-42" tabindex="-1"></a><span class="dv">4</span>     AGE     young   <span class="fu">c</span>(<span class="st">"S14"</span>,....         <span class="dv">36</span> <span class="cn">TRUE</span>, TR....</span>
<span id="cb30-43"><a href="#cb30-43" tabindex="-1"></a></span>
<span id="cb30-44"><a href="#cb30-44" tabindex="-1"></a><span class="co"># </span><span class="al">NOTE</span><span class="co">: make_split_fun(pre = list(drop_facet_levels)) and drop_split_levels</span></span>
<span id="cb30-45"><a href="#cb30-45" tabindex="-1"></a><span class="co">#       do the same thing in this case</span></span></code></pre></div>
<p>Here we can see what the split column variable is
(<code>split</code>, first column) at this level of the splitting
procedure. <code>value</code> is the current split value that is being
dealt with. For the next column, let’s see the number of rows of these
data frames:
<code>sapply(.spl_context$full_parent_df, nrow) # [1] 356 121  36  36</code>.
Indeed, the <code>root</code> level contains the full input data frame,
while the other levels are subgroups of the full data according to the
split value. <code>all_cols_n</code> shows exactly the numbers just
described. <code>all obs</code> is the current filter applied to the
columns. Applying this to the root data (or the row subgroup data)
reveals the current column-wise facet (or row-wise for a row split). It
is also possible to use the same information to make complex splits in
the column space by using the full data frame and the value splits to
select the interested values. This is something we will change and
simplify within <code>rtables</code> as the need becomes apparent.</p>
</div>
</div>
<div class="section level3">
<h3 id="extra-arguments-extra_args">Extra Arguments: <code>extra_args</code><a class="anchor" aria-label="anchor" href="#extra-arguments-extra_args"></a>
</h3>
<p>This functionality is well-known and used in the setting of analysis
functions (a somewhat complicated example of this can be found in the <a href="https://insightsengineering.github.io/rtables/main/articles/example_analysis_coxreg.html#constructing-the-table">Example
Complex Analysis Function vignette</a>), but we will show here how this
can also apply to splits.</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span></span>
<span><span class="co"># Let's use the tracer!!</span></span>
<span><span class="va">my_tracer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">spl</span><span class="op">@</span><span class="va">extra_args</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">trace</a></span><span class="op">(</span></span>
<span>  what <span class="op">=</span> <span class="st">"do_split"</span>,</span>
<span>  tracer <span class="op">=</span> <span class="va">my_tracer</span>,</span>
<span>  where <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"rtables"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">custom_mean_var</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">var</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">labelstr</span>, <span class="va">na.rm</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># browser()</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">var</span><span class="op">]</span><span class="op">]</span>, na.rm <span class="op">=</span> <span class="va">na.rm</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">DM_ageNA</span> <span class="op">&lt;-</span> <span class="va">DM</span></span>
<span><span class="va">DM_ageNA</span><span class="op">$</span><span class="va">AGE</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">drop_split_levels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/summarize_row_groups.html">summarize_row_groups</a></span><span class="op">(</span></span>
<span>    cfun <span class="op">=</span> <span class="fu">custom_mean_var</span><span class="op">(</span><span class="st">"AGE"</span><span class="op">)</span>,</span>
<span>    extra_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>, format <span class="op">=</span> <span class="st">"xx.x"</span>,</span>
<span>    label_fstr <span class="op">=</span> <span class="st">"label %s"</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># content_extra_args, c_extra_args are different slots!! (xxx)</span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"STRATA1"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../../reference/split_funcs.html">keep_split_levels</a></span><span class="op">(</span><span class="st">"A"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"AGE"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># check with the extra_args (xxx)</span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM_ageNA</span><span class="op">)</span></span>
<span><span class="co"># You can pass extra_args down to other splits. It is possible this will not not</span></span>
<span><span class="co">#   work. Should it? That is why extra_args lives only in splits (xxx) check if it works</span></span>
<span><span class="co">#   as is. Difficult to find an use case for this. Maybe it could work for the ref_group</span></span>
<span><span class="co">#   info. That does not work with nesting already (fairly sure that it will break stuff).</span></span>
<span><span class="co">#   Does it make sense to have more than one ref_group at any point of the analysis? No docs,</span></span>
<span><span class="co">#   send a warning if users try to nest things with ref_group (that is passed around via</span></span>
<span><span class="co">#   extra_args)</span></span>
<span></span>
<span><span class="co"># As we can see that was not possible. What if we now force it a bit?</span></span>
<span><span class="va">my_split_fun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span>, <span class="va">.spl_context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">spl</span><span class="op">@</span><span class="va">extra_args</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="co"># does not work because do_split is not changing the object</span></span>
<span>  <span class="co"># the split does not do anything with it</span></span>
<span>  <span class="fu"><a href="../../reference/split_funcs.html">drop_split_levels</a></span><span class="op">(</span><span class="va">df</span>, <span class="va">spl</span><span class="op">)</span></span>
<span><span class="op">}</span> <span class="co"># does not work</span></span>
<span></span>
<span><span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">my_split_fun</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"AGE"</span>, inclNAs <span class="op">=</span> <span class="cn">TRUE</span>, afun <span class="op">=</span> <span class="va">mean</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># include_NAs is set FALSE</span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM_ageNA</span><span class="op">)</span></span>
<span><span class="co"># extra_args is in available in cols but not in rows, because different columns</span></span>
<span><span class="co">#  may need it for different col space. Row-wise it seems not necessary.</span></span>
<span><span class="co">#  The only thing that works is adding it to analyze (xxx) check if it is worth adding</span></span>
<span></span>
<span><span class="co"># We invite the developer now to test all the test files of this package with the tracer on</span></span>
<span><span class="co"># therefore -&gt; extra_args is not currently used in splits (xxx could be wrong)</span></span>
<span><span class="co"># could be not being hooked up</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">untrace</a></span><span class="op">(</span>what <span class="op">=</span> <span class="st">"do_split"</span>, where <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"rtables"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Let's try with the other variables identically</span></span>
<span><span class="va">my_tracer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span> <span class="op">||</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">labels</span><span class="op">)</span> <span class="op">||</span> <span class="fu"><a href="https://rdrr.io/r/base/Logic.html" class="external-link">isTRUE</a></span><span class="op">(</span><span class="va">trim</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/print.html" class="external-link">print</a></span><span class="op">(</span><span class="st">"A LOT TO SAY"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/message.html" class="external-link">message</a></span><span class="op">(</span><span class="st">"CANT BLOCK US ALL"</span><span class="op">)</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/stop.html" class="external-link">stop</a></span><span class="op">(</span><span class="st">"NOW FOR SURE"</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="op">}</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">trace</a></span><span class="op">(</span></span>
<span>  what <span class="op">=</span> <span class="st">"do_split"</span>,</span>
<span>  tracer <span class="op">=</span> <span class="va">my_tracer</span>,</span>
<span>  where <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"rtables"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># Run tests by copying the above in setup-fakedata.R (then devtools::test())</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">untrace</a></span><span class="op">(</span></span>
<span>  what <span class="op">=</span> <span class="st">"do_split"</span>,</span>
<span>  where <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"rtables"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>As we have demonstrated, all of the above seem like impossible cases
and are to be considered as vestigial and to be deprecated.</p>
</div>
</div>
<div class="section level2">
<h2 id="multivarsplit-compoundsplit-examples">
<code>MultiVarSplit</code> &amp; <code>CompoundSplit</code>
Examples<a class="anchor" aria-label="anchor" href="#multivarsplit-compoundsplit-examples"></a>
</h2>
<p>The final part of this article is still under construction, hence the
non-specific mentions and the to do list. xxx <code>CompoundSplit</code>
generates facets from one variable (e.g. cumulative distributions) while
<code>MultiVarSplit</code> uses different variables for the split. See
<code>AnalyzeMultiVars</code>, which inherits from
<code>CompoundSplit</code> for more details on how it analyzes the same
facets multiple times. <code>MultiVarColSplit</code> works with
<code>analyze_colvars</code>, which is out of the scope of this article.
<code>.set_kids_sect_sep</code> adds things between children (can be set
from split).</p>
<p>First, we want to see how the <code>MultiVarSplit</code> class
behaves for an example case taken from
<code><a href="../../reference/split_rows_by_multivar.html">?split_rows_by_multivar</a></code>.</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span></span>
<span><span class="va">my_tracer</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/substitute.html" class="external-link">quote</a></span><span class="op">(</span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/methods/is.html" class="external-link">is</a></span><span class="op">(</span><span class="va">spl</span>, <span class="st">"MultiVarSplit"</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/browser.html" class="external-link">browser</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">trace</a></span><span class="op">(</span></span>
<span>  what <span class="op">=</span> <span class="st">"do_split"</span>,</span>
<span>  tracer <span class="op">=</span> <span class="va">my_tracer</span>,</span>
<span>  where <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"rtables"</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co"># We want also to take a look at the following:</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/debug.html" class="external-link">debugonce</a></span><span class="op">(</span><span class="fu">rtables</span><span class="fu">:::</span><span class="va">.apply_split_inner</span><span class="op">)</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by_multivar.html">split_rows_by_multivar</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"BMRKR1"</span>, <span class="st">"BMRKR1"</span><span class="op">)</span>,</span>
<span>    varlabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SD"</span>, <span class="st">"MEAN"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"COUNTRY"</span>,</span>
<span>    split_fun <span class="op">=</span> <span class="fu"><a href="../../reference/split_funcs.html">keep_split_levels</a></span><span class="op">(</span><span class="st">"PAK"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># xxx for #690 #691</span></span>
<span>  <span class="fu"><a href="../../reference/summarize_row_groups.html">summarize_row_groups</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGE"</span>, <span class="st">"SEX"</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt</span>, <span class="va">DM</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># xxx check empty space on top -&gt; check if it is a bug, file it</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/trace.html" class="external-link">untrace</a></span><span class="op">(</span></span>
<span>  what <span class="op">=</span> <span class="st">"do_split"</span>,</span>
<span>  where <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ns-internal.html" class="external-link">asNamespace</a></span><span class="op">(</span><span class="st">"rtables"</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>If we print the output, we will notice that the two groups (one
called “SEX” and the other “STRATA1”) are identical along the columns.
This is because no subgroup was actually created. This is an interesting
way to personalize splits with the help of custom split functions and
their split context, and to have widely different subgroups in the
table.</p>
<p>We invite the reader to try to understand why
<code>split_rows_by_multivar</code> can have other row splits under it
(see <code>xxx</code> comment in the previous code), while
<code>split_cols_by_multivar</code> does not. This is a known bug at the
moment, and we will work towards a fix for this. Known issues are often
linked in the source code by their GitHub issue number
(e.g. <code>#690</code>).</p>
<p>Lastly, we will briefly show an example of a split by cut function
and how to replace it to solve the empty age groups problem as we did
before. We propose the same simplified situation:</p>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span></span>
<span><span class="va">cutfun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># browser()</span></span>
<span>  <span class="va">cutpoints</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">cutpoints</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">""</span>, <span class="st">"Younger"</span>, <span class="st">"Older"</span><span class="op">)</span></span>
<span>  <span class="va">cutpoints</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../../reference/split_funcs.html">drop_and_remove_levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"B: Placebo"</span>, <span class="st">"C: Combination"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"STRATA1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/varcuts.html">split_rows_by_cutfun</a></span><span class="op">(</span><span class="st">"AGE"</span>, cutfun <span class="op">=</span> <span class="va">cutfun</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co"># split_rows_by_cuts("AGE", cuts = c(0, 50, 100),</span></span>
<span>  <span class="co">#                    cutlabels = c("young", "old")) %&gt;% # Works the same</span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">drop_split_levels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/summarize_row_groups.html">summarize_row_groups</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># This is degenerate!!!</span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl</span></span></code></pre></div>
<pre><code><span><span class="co">##                  all obs </span></span>
<span><span class="co">##                  (N=356) </span></span>
<span><span class="co">## —————————————————————————</span></span>
<span><span class="co">## A: Drug X                </span></span>
<span><span class="co">##   A                      </span></span>
<span><span class="co">##     AGE                  </span></span>
<span><span class="co">##       Younger            </span></span>
<span><span class="co">##         F       22 (6.2%)</span></span>
<span><span class="co">##         M       14 (3.9%)</span></span>
<span><span class="co">##       Older              </span></span>
<span><span class="co">##   B                      </span></span>
<span><span class="co">##     AGE                  </span></span>
<span><span class="co">##       Younger            </span></span>
<span><span class="co">##         F       26 (7.3%)</span></span>
<span><span class="co">##         M       14 (3.9%)</span></span>
<span><span class="co">##       Older              </span></span>
<span><span class="co">##         F       1 (0.3%) </span></span>
<span><span class="co">##   C                      </span></span>
<span><span class="co">##     AGE                  </span></span>
<span><span class="co">##       Younger            </span></span>
<span><span class="co">##         F       19 (5.3%)</span></span>
<span><span class="co">##         M       21 (5.9%)</span></span>
<span><span class="co">##       Older              </span></span>
<span><span class="co">##         F       2 (0.6%) </span></span>
<span><span class="co">##         M       2 (0.6%)</span></span></code></pre>
<p>For both row split cases (<code>*_cuts</code> and
<code>*_cutfun</code>), we have empty levels that are not dropped. This
is to be expected and can be avoided by using a dedicated split
function. Intentionally looking at the future split is possible in order
to determine if an element is present in it. At the moment it is not
possible to add <code>spl_fun</code> to dedicated split functions like
<code>split_rows_by_cuts</code>.</p>
<p>Note that in the previous table we only used
<code>summarize_row_groups</code>, with no <code>analyze</code> calls.
This rendered the table nicely, but it is not the standard method to use
as <code>summarize_row_groups</code> is intended <em>only</em> to
decorate row groups, i.e. rows with labels. Internally, these rows are
called content rows and that is why analysis functions in
<code>summarize_row_groups</code> are called <code>cfun</code> instead
of <code>afun</code>. Indeed, the tabulation machinery also presents
these two differently as is described in the <a href="https://insightsengineering.github.io/rtables/main/articles/tabulation_concepts.html#tabulation-with-row-structure">Tabulation
with Row Structure section</a> of the Tabulation vignette.</p>
<p>We can try to construct the split function for cuts manually with
<code>make_split_fun</code>:</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_count_afun</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">.N_col</span>, <span class="va">.spl_context</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># browser()</span></span>
<span>  <span class="va">out</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">/</span> <span class="va">.N_col</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">out</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">)</span><span class="op">]</span> <span class="co"># workaround (xxx #689)</span></span>
<span>  <span class="fu"><a href="../../reference/in_rows.html">in_rows</a></span><span class="op">(</span></span>
<span>    .list <span class="op">=</span> <span class="va">out</span>,</span>
<span>    .formats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"xx (xx.x%)"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="co"># ?make_split_fun # To check for docs/examples</span></span>
<span></span>
<span><span class="co"># Core split</span></span>
<span><span class="va">cuts_core</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">spl</span>, <span class="va">df</span>, <span class="va">vals</span>, <span class="va">labels</span>, <span class="va">.spl_context</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># browser() # file an issue xxx</span></span>
<span>  <span class="co"># variables that are split on are converted to factor during the original clean-up</span></span>
<span>  <span class="co"># cut split are not doing it but it is an exception. xxx</span></span>
<span>  <span class="co"># young_v &lt;- as.numeric(df[["AGE"]]) &lt; 50</span></span>
<span>  <span class="co"># current solution:</span></span>
<span>  <span class="va">young_v</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="st">"AGE"</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">&lt;</span> <span class="fl">50</span></span>
<span>  <span class="fu"><a href="../../reference/make_split_result.html">make_split_result</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"young"</span>, <span class="st">"old"</span><span class="op">)</span>,</span>
<span>    datasplit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">df</span><span class="op">[</span><span class="va">young_v</span>, <span class="op">]</span>, <span class="va">df</span><span class="op">[</span><span class="op">!</span><span class="va">young_v</span>, <span class="op">]</span><span class="op">)</span>,</span>
<span>    labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Younger"</span>, <span class="st">"Older"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">drop_empties</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">splret</span>, <span class="va">spl</span>, <span class="va">fulldf</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co"># browser()</span></span>
<span>  <span class="va">nrows_data_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">vapply</a></span><span class="op">(</span><span class="va">splret</span><span class="op">$</span><span class="va">datasplit</span>, <span class="va">nrow</span>, <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">numeric</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">to_keep</span> <span class="op">&lt;-</span> <span class="va">nrows_data_split</span> <span class="op">&gt;</span> <span class="fl">0</span></span>
<span>  <span class="fu"><a href="../../reference/make_split_result.html">make_split_result</a></span><span class="op">(</span></span>
<span>    <span class="va">splret</span><span class="op">$</span><span class="va">values</span><span class="op">[</span><span class="va">to_keep</span><span class="op">]</span>,</span>
<span>    <span class="va">splret</span><span class="op">$</span><span class="va">datasplit</span><span class="op">[</span><span class="va">to_keep</span><span class="op">]</span>,</span>
<span>    <span class="va">splret</span><span class="op">$</span><span class="va">labels</span><span class="op">[</span><span class="va">to_keep</span><span class="op">]</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span>
<span><span class="va">gen_split</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/make_split_fun.html">make_split_fun</a></span><span class="op">(</span></span>
<span>  core_split <span class="op">=</span> <span class="va">cuts_core</span>,</span>
<span>  post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">drop_empties</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../../reference/split_funcs.html">keep_split_levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A: Drug X"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"STRATA1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"AGE"</span>, split_fun <span class="op">=</span> <span class="va">gen_split</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"SEX"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># It is the last step!! No need of BMRKR1 right?</span></span>
<span>  <span class="co"># split_rows_by("SEX", split_fun = drop_split_levels,</span></span>
<span>  <span class="co">#               child_labels = "hidden") %&gt;% # close issue #689. would it work for</span></span>
<span>  <span class="co"># analyze_colvars? probably (xxx)</span></span>
<span>  <span class="co"># analyze("BMRKR1", afun = my_count_afun) %&gt;%  # This is NOT degenerate!!! BMRKR1 is only placeholder</span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl</span></span></code></pre></div>
<p>Alternatively, we could choose to prune these rows out with
<code>prune_table</code>!</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span></span>
<span><span class="va">tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span>show_colcounts <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"ARM"</span>, split_fun <span class="op">=</span> <span class="fu"><a href="../../reference/split_funcs.html">keep_split_levels</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A: Drug X"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"STRATA1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/varcuts.html">split_rows_by_cuts</a></span><span class="op">(</span></span>
<span>    <span class="st">"AGE"</span>,</span>
<span>    cuts <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">50</span>, <span class="fl">100</span><span class="op">)</span>,</span>
<span>    cutlabels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"young"</span>, <span class="st">"old"</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">drop_split_levels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/summarize_row_groups.html">summarize_row_groups</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="co"># This is degenerate!!! # we keep it until #689</span></span>
<span>  <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span>
<span></span>
<span><span class="va">tbl</span></span></code></pre></div>
<pre><code><span><span class="co">##              all obs </span></span>
<span><span class="co">##              (N=356) </span></span>
<span><span class="co">## —————————————————————</span></span>
<span><span class="co">## A: Drug X            </span></span>
<span><span class="co">##   A                  </span></span>
<span><span class="co">##     young            </span></span>
<span><span class="co">##       F     22 (6.2%)</span></span>
<span><span class="co">##       M     14 (3.9%)</span></span>
<span><span class="co">##     old              </span></span>
<span><span class="co">##   B                  </span></span>
<span><span class="co">##     young            </span></span>
<span><span class="co">##       F     26 (7.3%)</span></span>
<span><span class="co">##       M     14 (3.9%)</span></span>
<span><span class="co">##     old              </span></span>
<span><span class="co">##       F     1 (0.3%) </span></span>
<span><span class="co">##   C                  </span></span>
<span><span class="co">##     young            </span></span>
<span><span class="co">##       F     19 (5.3%)</span></span>
<span><span class="co">##       M     21 (5.9%)</span></span>
<span><span class="co">##     old              </span></span>
<span><span class="co">##       F     2 (0.6%) </span></span>
<span><span class="co">##       M     2 (0.6%)</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Trying with pruning</span></span>
<span><span class="fu"><a href="../../reference/prune_table.html">prune_table</a></span><span class="op">(</span><span class="va">tbl</span><span class="op">)</span> <span class="co"># (xxx) what is going on here? it is degenerate so it has no real leaves</span></span></code></pre></div>
<pre><code><span><span class="co">## NULL</span></span></code></pre>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># It is degenerate -&gt; what to do?</span></span>
<span><span class="co"># The same mechanism is applied in the case of NULL leaves, they are rolled up in the</span></span>
<span><span class="co">#  table tree</span></span></code></pre></div>
<ol start="30" style="list-style-type: lower-roman">
<li>add the pre-proc with z-scoring</li>
</ol>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>rtables is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../../analytics.js"></script></footer>
</div>

  

  

  </body>
</html>
