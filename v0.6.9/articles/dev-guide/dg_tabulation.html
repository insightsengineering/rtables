<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rtables">
<title>Tabulation • rtables</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../../apple-touch-icon-60x60.png">
<script src="../../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../../pkgdown.js"></script><meta property="og:title" content="Tabulation">
<meta property="og:description" content="rtables">
<meta property="og:image" content="https://insightsengineering.github.io/rtables/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="../../consent.css">
<script src="../../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">

    <a class="navbar-brand me-2" href="../../index.html">rtables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.9</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../../reference/index.html">Reference</a>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Getting Started</h6>
    <a class="dropdown-item" href="../../articles/introduction.html">Introduction to {rtables}</a>
    <a class="dropdown-item" href="../../articles/exploratory_analysis.html">Exploratory Analysis</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Clinical Trials</h6>
    <a class="dropdown-item" href="../../articles/clinical_trials.html">Example Clinical Trials Tables</a>
    <a class="dropdown-item" href="../../articles/baseline.html">Comparing Against Baselines or Control</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Table Customization</h6>
    <a class="dropdown-item" href="../../articles/custom_appearance.html">Customizing Appearance</a>
    <a class="dropdown-item" href="../../articles/title_footer.html">Titles, Footers, and Referential Footnotes</a>
    <a class="dropdown-item" href="../../articles/sorting_pruning.html">Pruning and Sorting Tables</a>
    <a class="dropdown-item" href="../../articles/col_counts.html">Column Counts and Formats</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../../articles/index.html">More articles...</a>
  </div>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-developer-guide">Developer Guide</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-developer-guide">
    <a class="dropdown-item" href="../../articles/dev-guide/dg_split_machinery.html">Split Machinery</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_tabulation.html">Tabulation</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_table_hierarchy.html">Table Hierarchy</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_debug_rtables.html">Debugging in {rtables} and Beyond</a>
    <a class="dropdown-item" href="../../articles/dev-guide/dg_notes.html">Sparse Notes on {rtables} Internals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../../news/index.html">Changelog</a>
</li>

<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../../unit-test-report/">Unit test report</a>
  </div>
</li>
      <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/release-candidate">release-candidate</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/latest-tag">latest-tag</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.11">v0.6.11</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.10">v0.6.10</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.9">v0.6.9</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.8">v0.6.8</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.7">v0.6.7</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.6">v0.6.6</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.6-rc1">v0.6.6-rc1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.5">v0.6.5</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.4">v0.6.4</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.3">v0.6.3</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.2">v0.6.2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.1">v0.6.1</a>
</div>
</li>
</ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/insightsengineering/rtables">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../../logo.png" class="logo" alt=""><h1>Tabulation</h1>
                        <h4 data-toc-skip class="author">Davide
Garolini</h4>

            <h4 data-toc-skip class="date">2024-06-27</h4>

      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/rtables/blob/main/vignettes/dev-guide/dg_tabulation.Rmd" class="external-link"><code>vignettes/dev-guide/dg_tabulation.Rmd</code></a></small>
      <div class="d-none name"><code>dg_tabulation.Rmd</code></div>
    </div>



<div class="section level2">
<h2 id="disclaimer">Disclaimer<a class="anchor" aria-label="anchor" href="#disclaimer"></a>
</h2>
<p>This article is intended for use by developers only and will contain
low-level explanations of the topics covered. For user-friendly
vignettes, please see the <a href="https://insightsengineering.github.io/rtables/latest-tag/articles/index.html">Articles</a>
page on the <code>rtables</code> website.</p>
<p>Any code or prose which appears in the version of this article on the
<code>main</code> branch of the repository may reflect a specific state
of things that can be more or less recent. This guide describes very
important aspects of the tabulation process that are unlikely to change.
Regardless, we invite the reader to keep in mind that the current
repository code may have drifted from the following material in this
document, and it is always the best practice to read the code directly
on <code>main</code>.</p>
<p>Please keep in mind that <code>rtables</code> is still under active
development, and it has seen the efforts of multiple contributors across
different years. Therefore, there may be legacy mechanisms and ongoing
transformations that could look different in the future.</p>
<p>Being that this a working document that may be subjected to both
deprecation and updates, we keep <code>xxx</code> comments to indicate
placeholders for warnings and to-do’s that need further work.</p>
</div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>Tabulation in <code>rtables</code> is a process that takes a
pre-defined layout and applies it to data. The layout object, with all
of its splits and <code>analyze</code>s, can be applied to different
data to produce valid tables. This process happens principally within
the <code>tt_dotabulation.R</code> file and the user-facing function
<code>build_table</code> that resides in it. We will occasionally use
functions and methods that are present in other files, like
<code>colby_construction.R</code> or <code>make_subset_expr.R</code>. We
assume the reader is already familiar with the documentation for
<code>build_table</code>. We suggest reading the <a href="https://insightsengineering.github.io/rtables/latest-tag/articles/dev-guide/dg_split_machinery.html">Split
Machinery article</a> prior to this one, as it is instrumental in
understanding how the layout object, which is essentially built out of
splits, is tabulated when data is supplied.</p>
</div>
<div class="section level2">
<h2 id="tabulation">Tabulation<a class="anchor" aria-label="anchor" href="#tabulation"></a>
</h2>
<p>We enter into <code>build_table</code> using <code>debugonce</code>
to see how it works.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/rtables" class="external-link">rtables</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/debug.html" class="external-link">debugonce</a></span><span class="op">(</span><span class="va">build_table</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># A very simple layout</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"STRATA1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">drop_split_levels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"BMRKR1"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># lyt must be a PreDataTableLayouts object</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/methods/is.html" class="external-link">is</a></span><span class="op">(</span><span class="va">lyt</span>, <span class="st">"PreDataTableLayouts"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">lyt</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="../../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">DM</span><span class="op">)</span></span></code></pre></div>
<p>Now let’s look within our <code>build_table</code> call. After the
initial check that the layout is a pre-data table layout, it checks if
the column layout is defined (<code>clayout</code> accessor), i.e. it
does not have any column split. If that is the case, a
<code>All obs</code> column is added automatically with all
observations. After this, there are a couple of defensive programming
calls that do checks and transformations as we finally have the data.
These can be divided into two categories: those that mainly concern the
layout, which are defined as generics, and those that concern the data,
which are instead a function as they are not dependent on the layout
class. Indeed, the layout is structured and can be divided into
<code>clayout</code> and <code>rlayout</code> (column and row layout).
The first one is used to create <code>cinfo</code>, which is the general
object and container of the column splits and information. The second
one contains the obligatory all data split, i.e. the root split
(accessible with <code>root_spl</code>), and the row splits’ vectors
which are iterative splits in the row space. In the following, we
consider the initial checks and defensive programming.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## do checks and defensive programming now that we have the data</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/int_methods.html">fix_dyncuts</a></span><span class="op">(</span><span class="va">lyt</span>, <span class="va">df</span><span class="op">)</span> <span class="co"># Create the splits that depends on data</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu">set_def_child_ord</span><span class="op">(</span><span class="va">lyt</span>, <span class="va">df</span><span class="op">)</span> <span class="co"># With the data I set the same order for all splits</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu">fix_analyze_vis</span><span class="op">(</span><span class="va">lyt</span><span class="op">)</span> <span class="co"># Checks if the analyze last split should be visible</span></span>
<span><span class="co"># If there is only one you will not get the variable name, otherwise you get it if you</span></span>
<span><span class="co"># have multivar. Default is NA. You can do it now only because you are sure to</span></span>
<span><span class="co"># have the whole layout.</span></span>
<span><span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">fix_split_vars</span><span class="op">(</span><span class="va">lyt</span>, <span class="va">df</span>, char_ok <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">col_counts</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co"># checks if split vars are present</span></span>
<span></span>
<span><span class="va">lyt</span><span class="op">[</span><span class="op">]</span> <span class="co"># preserve names - warning if names longer, repeats the name value if only one</span></span>
<span><span class="va">lyt</span><span class="op">@</span><span class="va">.Data</span> <span class="co"># might not preserve the names # it works only when it is another class that inherits from lists</span></span>
<span><span class="co"># We suggest doing extensive testing about these behaviors in order to do choose the appropriate one</span></span></code></pre></div>
<p>Along with the various checks and defensive programming, we find
<code>PreDataAxisLayout</code> which is a virtual class that both row
and column layouts inherit from. Virtual classes are handy for group
classes that need to share things like labels or functions that need to
be applicable to their relative classes. See more information about the
<code>rtables</code> class hierarchy in the dedicated article <a href="https://insightsengineering.github.io/rtables/latest-tag/articles/dev-guide/dg_table_hierarchy.html">here</a>.</p>
<p>Now, we continue with <code>build_table</code>. After the checks, we
notice <code>TreePos()</code> which is a constructor for an object that
retains a representation of the tree position along with split values
and labels. This is mainly used by <code>create_colinfo</code>, which we
enter now with <code>debugonce(create_colinfo)</code>. This function
creates the object that represents the column splits and everything else
that may be related to the columns. In particular, the column counts are
calculated in this function. The parameter inputs are as follows:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cinfo</span> <span class="op">&lt;-</span> <span class="fu">create_colinfo</span><span class="op">(</span></span>
<span>  <span class="va">lyt</span>, <span class="co"># Main layout with col split info</span></span>
<span>  <span class="va">df</span>, <span class="co"># df used for splits and col counts if no alt_counts_df is present</span></span>
<span>  <span class="va">rtpos</span>, <span class="co"># TreePos (does not change out of this function)</span></span>
<span>  counts <span class="op">=</span> <span class="va">col_counts</span>, <span class="co"># If we want to overwrite the calculations with df/alt_counts_df</span></span>
<span>  alt_counts_df <span class="op">=</span> <span class="va">alt_counts_df</span>, <span class="co"># alternative data for col counts</span></span>
<span>  total <span class="op">=</span> <span class="va">col_total</span>, <span class="co"># calculated from build_table inputs (nrow of df or alt_counts_df)</span></span>
<span>  <span class="va">topleft</span> <span class="co"># topleft information added into build_table</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p><code>create_colinfo</code> is in <code>make_subset_expr.R</code>.
Here, we see that if <code>topleft</code> is present in
<code>build_table</code>, it will override the one in <code>lyt</code>.
Entering <code>create_colinfo</code>, we will see the following
calls:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">clayout</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/col_accessors.html">clayout</a></span><span class="op">(</span><span class="va">lyt</span><span class="op">)</span> <span class="co"># Extracts column split and info</span></span>
<span></span>
<span><span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">topleft</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">topleft</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/top_left.html">top_left</a></span><span class="op">(</span><span class="va">lyt</span><span class="op">)</span> <span class="co"># If top_left is not present in build_table, it is taken from lyt</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">ctree</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/col_accessors.html">coltree</a></span><span class="op">(</span><span class="va">clayout</span>, df <span class="op">=</span> <span class="va">df</span>, rtpos <span class="op">=</span> <span class="va">rtpos</span><span class="op">)</span> <span class="co"># Main constructor of LayoutColTree</span></span>
<span><span class="co"># The above is referenced as generic and principally represented as</span></span>
<span><span class="co"># setMethod("coltree", "PreDataColLayout", (located in `tree_accessor.R`).</span></span>
<span><span class="co"># This is a call that restructures information from clayout, df, and rtpos</span></span>
<span><span class="co"># to get a more compact column tree layout. Part of this design is related</span></span>
<span><span class="co"># to past implementations.</span></span>
<span></span>
<span><span class="va">cexprs</span> <span class="op">&lt;-</span> <span class="fu">make_col_subsets</span><span class="op">(</span><span class="va">ctree</span>, <span class="va">df</span><span class="op">)</span> <span class="co"># extracts expressions in a compact fashion.</span></span>
<span><span class="co"># WARNING: removing NAs at this step is automatic. This should</span></span>
<span><span class="co"># be coupled with a warning for NAs in the split (xxx)</span></span>
<span></span>
<span><span class="va">colextras</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/int_methods.html">col_extra_args</a></span><span class="op">(</span><span class="va">ctree</span><span class="op">)</span> <span class="co"># retrieves extra_args from the tree. It may not be used</span></span></code></pre></div>
<p>Next in the function is the determination of the column counts.
Currently, this happens only at the leaf level, but it can certainly be
calculated independently for all levels (this is an open issue in
<code>rtables</code>, i.e. how to print other levels’ totals).
Precedence for column counts may be not documented (“xxx todo”). The
main use case is when you are analyzing a participation-level dataset,
with multiple records per subject, and you would like to retain the
total numbers of subjects per column, often taken from a subject-level
dataset, to use as column counts. Originally, counts were only able to
be added as a vector, but it is often the case that users would like the
possibility to use <code>alt_counts_df</code>. The <code>cinfo</code>
object (<code>InstantiatedColumnInfo</code>) is created with all the
above information.</p>
<p>If we continue inside <code>build_table</code>, we see
<code>.make_ctab</code> used to make a root split. This is a general
procedure that generates the initial root split as a content row.
<code>ctab</code> is applied to this content row, which is a row that
contains only a label. From <code><a href="../../reference/summarize_row_groups.html">?summarize_row_groups</a></code>, you know
that this is how <code>rtables</code> defines label rows, i.e. as
content rows. <code>.make_ctab</code> is very similar to the function
that actual creates the table rows, <code>.make_tablerows</code>. Note
that this function uses <code>parent_cfun</code> and
<code>.make_caller</code> to retrieve the content function inserted in
above levels. Here we split the structural handling of the table object
and the row-creation engine, which are divided by a
<code>.make_tablerows</code> call. If you search the package, you will
find that this function is only called twice, once in
<code>.make_ctab</code> and once in <code>.make_analyzed_tab</code>.
These two are the final elements of the table construction: the creation
of rows.</p>
<p>Going back to <code>build_table</code>, you will see that the row
layout is actually a list of split vectors. The fundamental line,
<code>kids &lt;- lapply(seq_along(rlyt), function(i) {</code>, allows us
to appreciate this. Going forward we see how
<code>recursive_applysplit</code> is applied to each split vector. It
may be worthwhile to check what this vector looks like in our test
case.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># rtables 0.6.2</span></span>
<span><span class="co"># A very simple layout</span></span>
<span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"STRATA1"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_rows_by.html">split_rows_by</a></span><span class="op">(</span><span class="st">"SEX"</span>, split_fun <span class="op">=</span> <span class="va">drop_split_levels</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/split_cols_by.html">split_cols_by</a></span><span class="op">(</span><span class="st">"ARM"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="../../reference/analyze.html">analyze</a></span><span class="op">(</span><span class="st">"BMRKR1"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">rlyt</span> <span class="op">&lt;-</span> <span class="fu">rtables</span><span class="fu">:::</span><span class="fu"><a href="../../reference/int_methods.html">rlayout</a></span><span class="op">(</span><span class="va">lyt</span><span class="op">)</span></span>
<span><span class="fu"><a href="../../reference/int_methods.html">str</a></span><span class="op">(</span><span class="va">rlyt</span>, max.level <span class="op">=</span> <span class="fl">2</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>Formal class <span class="ch">'P</span><span class="er">reDataRowLayout</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">2</span> slots</span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a>  <span class="op">..</span>@ <span class="op">.</span>Data     <span class="op">:</span>List of <span class="dv">2</span> # rlyt is a rtables object <span class="op">(</span>PreDataRowLayout<span class="op">)</span> that is also a list<span class="op">!</span></span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a>  <span class="op">..</span>@ root_split<span class="op">:</span>Formal class <span class="ch">'R</span><span class="er">ootSplit</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">17</span> slots # another object<span class="op">!</span></span>
<span id="cb6-4"><a href="#cb6-4" tabindex="-1"></a>  <span class="pp"># If you do summarize_row_groups before anything you act on the root split. We need this to</span></span>
<span id="cb6-5"><a href="#cb6-5" tabindex="-1"></a>  <span class="pp"># </span><span class="er">have a place for the content that is valid for the whole table.</span></span>
<span id="cb6-6"><a href="#cb6-6" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" tabindex="-1"></a>str<span class="op">(</span>rtables<span class="op">:::</span>root_spl<span class="op">(</span>rlyt<span class="op">),</span> max<span class="op">.</span>level <span class="op">=</span> <span class="dv">2</span><span class="op">)</span> # it is still a split</span>
<span id="cb6-8"><a href="#cb6-8" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" tabindex="-1"></a>str<span class="op">(</span>rlyt<span class="op">[[</span><span class="dv">1</span><span class="op">]],</span> max<span class="op">.</span>level <span class="op">=</span> <span class="dv">3</span><span class="op">)</span> # still a rtables object <span class="op">(</span>SplitVector<span class="op">)</span> that is a list</span>
<span id="cb6-10"><a href="#cb6-10" tabindex="-1"></a>Formal class <span class="ch">'S</span><span class="er">plitVector</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">1</span> slot</span>
<span id="cb6-11"><a href="#cb6-11" tabindex="-1"></a>  <span class="op">..</span>@ <span class="op">.</span>Data<span class="op">:</span>List of <span class="dv">3</span></span>
<span id="cb6-12"><a href="#cb6-12" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span>$ <span class="op">:</span>Formal class <span class="ch">'V</span><span class="er">arLevelSplit</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">20</span> slots</span>
<span id="cb6-13"><a href="#cb6-13" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span>$ <span class="op">:</span>Formal class <span class="ch">'V</span><span class="er">arLevelSplit</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">20</span> slots</span>
<span id="cb6-14"><a href="#cb6-14" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span>$ <span class="op">:</span>Formal class <span class="ch">'A</span><span class="er">nalyzeMultiVars</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">17</span> slots</span></code></pre></div>
<p>The last print is very informative. We can see from the layout
construction that this object is built with 2
<code>VarLevelSplit</code>s on the rows and one final
<code>AnalyzeMultiVars</code>, which is the leaf analysis split that has
the final level rows. The second split vector is the following
<code>AnalyzeVarSplit</code>.</p>
<p>xxx To get multiple split vectors, you need to escape the nesting
with <code>nest = FALSE</code> or by adding a <code>split_rows_by</code>
call after an <code>analyze</code> call.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="pp"># </span><span class="er">rtables 0.6.2</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a>str<span class="op">(</span>rlyt<span class="op">[[</span><span class="dv">2</span><span class="op">]],</span> max<span class="op">.</span>level <span class="op">=</span> <span class="dv">5</span><span class="op">)</span></span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a>Formal class <span class="ch">'S</span><span class="er">plitVector</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">1</span> slot</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a>  <span class="op">..</span>@ <span class="op">.</span>Data<span class="op">:</span>List of <span class="dv">1</span></span>
<span id="cb7-5"><a href="#cb7-5" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span>$ <span class="op">:</span>Formal class <span class="ch">'A</span><span class="er">nalyzeVarSplit</span><span class="ch">'</span> <span class="op">[</span>package <span class="st">"rtables"</span><span class="op">]</span> with <span class="dv">21</span> slots</span>
<span id="cb7-6"><a href="#cb7-6" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ analysis_fun           <span class="op">:</span>function <span class="op">(</span>x<span class="op">,</span> <span class="op">...)</span></span>
<span id="cb7-7"><a href="#cb7-7" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..-</span> attr<span class="op">(*,</span> <span class="st">"srcref"</span><span class="op">)=</span> <span class="ch">'s</span><span class="er">rcref</span><span class="ch">'</span> <span class="dt">int</span> <span class="op">[</span><span class="dv">1</span><span class="op">:</span><span class="dv">8</span><span class="op">]</span> <span class="dv">1723</span> <span class="dv">5</span> <span class="dv">1732</span> <span class="dv">5</span> <span class="dv">5</span> <span class="dv">5</span> <span class="dv">4198</span> <span class="dv">4207</span></span>
<span id="cb7-8"><a href="#cb7-8" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..-</span> attr<span class="op">(*,</span> <span class="st">"srcfile"</span><span class="op">)=</span>Classes <span class="ch">'s</span><span class="er">rcfilealias</span><span class="ch">'</span><span class="op">,</span> <span class="ch">'s</span><span class="er">rcfile</span><span class="ch">'</span> <span class="op">&lt;</span>environment<span class="op">:</span> <span class="bn">0x560d8e67b750</span><span class="op">&gt;</span></span>
<span id="cb7-9"><a href="#cb7-9" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ default_rowlabel       <span class="op">:</span> chr <span class="st">"Var3 Counts"</span></span>
<span id="cb7-10"><a href="#cb7-10" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ include_NAs            <span class="op">:</span> logi FALSE</span>
<span id="cb7-11"><a href="#cb7-11" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ var_label_position     <span class="op">:</span> chr <span class="st">"default"</span></span>
<span id="cb7-12"><a href="#cb7-12" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ payload                <span class="op">:</span> chr <span class="st">"VAR3"</span></span>
<span id="cb7-13"><a href="#cb7-13" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ name                   <span class="op">:</span> chr <span class="st">"VAR3"</span></span>
<span id="cb7-14"><a href="#cb7-14" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ split_label            <span class="op">:</span> chr <span class="st">"Var3 Counts"</span></span>
<span id="cb7-15"><a href="#cb7-15" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ split_format           <span class="op">:</span> NULL</span>
<span id="cb7-16"><a href="#cb7-16" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ split_na_str           <span class="op">:</span> chr NA</span>
<span id="cb7-17"><a href="#cb7-17" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ split_label_position   <span class="op">:</span> chr<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb7-18"><a href="#cb7-18" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ content_fun            <span class="op">:</span> NULL</span>
<span id="cb7-19"><a href="#cb7-19" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ content_format         <span class="op">:</span> NULL</span>
<span id="cb7-20"><a href="#cb7-20" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ content_na_str         <span class="op">:</span> chr<span class="op">(</span><span class="dv">0</span><span class="op">)</span></span>
<span id="cb7-21"><a href="#cb7-21" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ content_var            <span class="op">:</span> chr <span class="st">""</span></span>
<span id="cb7-22"><a href="#cb7-22" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ label_children         <span class="op">:</span> logi FALSE</span>
<span id="cb7-23"><a href="#cb7-23" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ extra_args             <span class="op">:</span> list<span class="op">()</span></span>
<span id="cb7-24"><a href="#cb7-24" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ indent_modifier        <span class="op">:</span> <span class="dt">int</span> <span class="dv">0</span></span>
<span id="cb7-25"><a href="#cb7-25" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ content_indent_modifier<span class="op">:</span> <span class="dt">int</span> <span class="dv">0</span></span>
<span id="cb7-26"><a href="#cb7-26" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ content_extra_args     <span class="op">:</span> list<span class="op">()</span></span>
<span id="cb7-27"><a href="#cb7-27" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ page_title_prefix      <span class="op">:</span> chr NA</span>
<span id="cb7-28"><a href="#cb7-28" tabindex="-1"></a>  <span class="op">..</span> <span class="op">..</span> <span class="op">..</span> <span class="op">..</span>@ child_section_div      <span class="op">:</span> chr NA</span></code></pre></div>
<p>Continuing in <code>recursive_applysplit</code>, this is made up of
two main calls: one to <code>.make_ctab</code> which makes the content
row and calculates the counts if specified, and
<code>.make_split_kids</code>. This eventually contains
<code>recursive_applysplit</code> which is applied if the split vector
is built of <code>Split</code>s that are not <code>analyze</code>
splits. It being a generic is very handy here to switch between
different downstream processes. In our case (<code>rlyt[[1]]</code>) we
will call the method <code>getMethod(".make_split_kids", "Split")</code>
twice before getting to the analysis split. There, we have a (xxx)
multi-variable split which applies <code>.make_split_kids</code> to each
of its elements, in turn calling the main
<code>getMethod(".make_split_kids", "VAnalyzeSplit")</code> which would
in turn go to <code>.make_analyzed_tab</code>.</p>
<p>There are interesting edge cases here for different split cases, like
<code>split_by_multivars</code> or when one of the splits has a
reference group. In the internal code here, it is called
<code>baseline</code>. If we follow this variable across the function
layers, we will see that where the split (<code>do_split</code>) happens
(in <code>getMethod(".make_split_kids", "Split")</code>) we have a
second split for the reference group. This is done to make this
available in each row to calculate, for example, differences from the
reference group.</p>
<p>Now we move towards <code>.make_tablerows</code>, and here analysis
functions become key as this is the place where these are applied and
analyzed. First, the external <code>tryCatch</code> is used to cache
errors at a higher level, so as to differentiate the two major blocks.
The function parameters here are quite intuitive, with the exception of
<code>spl_context</code>. This is a fundamental parameter that keeps
information about splits so that it can be visible from analysis
functions. If you look into this value, you will see that is carried and
updated everywhere a split happens, except for columns. Column-related
information is added last, when in <code>gen_onerv</code>, which is the
lowest level where one result value is produced. From
<code>.make_tablerows</code> we go to <code>gen_rowvalues</code>, aside
from some row and referential footers handling.
<code>gen_rowvalues</code> unpacks the <code>cinfo</code> object and
crosses it with the arriving row split information to generate rows. In
particular, <code>rawvals &lt;- mapply(gen_onerv,</code> maps the
columns to generate a list of values corresponding to a table row.
Looking at the final <code>if</code> in <code>gen_onerv</code> we see
<code>if (!is(val, "RowsVerticalSection"))</code> and the function
<code>in_rows</code> is called. We invite the reader to explore what the
building blocks of <code>in_rows</code> are, and how
<code>.make_tablerows</code> constructs a data row
(<code>DataRow</code>) or a content row (<code>ContentRow</code>)
depending on whether it is called from <code>.make_ctab</code> or
<code>.make_analyzed_tab</code>.</p>
<p><code>.make_tablerows</code> either makes a content table or an
“analysis table”. <code>gen_rowvalues</code> generates a list of stacks
(<code>RowsVerticalSection</code>, more than one rows potentially!) for
each column.</p>
<p>To add: conceptual part -&gt; calculating things by column and
putting them side by side and slicing them by rows and putting it
together -&gt; rtables is row dominant.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>rtables is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../../analytics.js"></script></footer>
</div>





  </body>
</html>
