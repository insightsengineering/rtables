<!DOCTYPE html>
<!-- Generated by pkgdown + https://github.com/insightsengineering/r-pkgdown-multiversion -->
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="rtables">
<title>Example Complex Analysis Function: Modelling Cox Regression • rtables</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Example Complex Analysis Function: Modelling Cox Regression">
<meta property="og:description" content="rtables">
<meta property="og:image" content="https://insightsengineering.github.io/rtables/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><link rel="stylesheet" href="../consent.css">
<script src="../consent.js" type="text/javascript" charset="utf-8"></script>
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">rtables</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.6.9</small>

    <div style="width: 140px; margin-left: 0.5rem;"> <small class="nav-text text-muted me-auto">part of</small> <img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/nest.png?raw=true" alt="NEST" style="height: 30px;"><a href="https://pharmaverse.org/" class="external-link"><img src="https://github.com/insightsengineering/hex-stickers/blob/main/PNG/pharmaverse.png?raw=true" alt="pharmaverse" style="height: 28px;"></a> </div>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <h6 class="dropdown-header" data-toc-skip>Getting Started</h6>
    <a class="dropdown-item" href="../articles/introduction.html">Introduction to {rtables}</a>
    <a class="dropdown-item" href="../articles/exploratory_analysis.html">Exploratory Analysis</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Clinical Trials</h6>
    <a class="dropdown-item" href="../articles/clinical_trials.html">Example Clinical Trials Tables</a>
    <a class="dropdown-item" href="../articles/baseline.html">Comparing Against Baselines or Control</a>
    <div class="dropdown-divider"></div>
    <h6 class="dropdown-header" data-toc-skip>Table Customization</h6>
    <a class="dropdown-item" href="../articles/custom_appearance.html">Customizing Appearance</a>
    <a class="dropdown-item" href="../articles/title_footer.html">Titles, Footers, and Referential Footnotes</a>
    <a class="dropdown-item" href="../articles/sorting_pruning.html">Pruning and Sorting Tables</a>
    <a class="dropdown-item" href="../articles/col_counts.html">Column Counts and Formats</a>
    <div class="dropdown-divider"></div>
    <a class="dropdown-item" href="../articles/index.html">More articles...</a>
  </div>
</li>
<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-developer-guide">Developer Guide</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-developer-guide">
    <a class="dropdown-item" href="../articles/dev-guide/dg_split_machinery.html">Split Machinery</a>
    <a class="dropdown-item" href="../articles/dev-guide/dg_tabulation.html">Tabulation</a>
    <a class="dropdown-item" href="../articles/dev-guide/dg_table_hierarchy.html">Table Hierarchy</a>
    <a class="dropdown-item" href="../articles/dev-guide/dg_debug_rtables.html">Debugging in {rtables} and Beyond</a>
    <a class="dropdown-item" href="../articles/dev-guide/dg_notes.html">Sparse Notes on {rtables} Internals</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>

<li class="nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-reports">Reports</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-reports">
    <a class="dropdown-item" href="../coverage-report/">Coverage report</a>
    <a class="dropdown-item" href="../unit-test-report/">Unit test report</a>
  </div>
</li>
      <li class="nav-item dropdown">
    <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-versions">Versions</a>
    <div class="dropdown-menu" aria-labelledby="dropdown-versions">
    <a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/release-candidate">release-candidate</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/main">main</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/latest-release">latest-release</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.14">v0.6.14</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.13">v0.6.13</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.13-rc2">v0.6.13-rc2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.13-rc1">v0.6.13-rc1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.12">v0.6.12</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.12-rc2">v0.6.12-rc2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.12-rc1">v0.6.12-rc1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.11">v0.6.11</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.10">v0.6.10</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.9">v0.6.9</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.8">v0.6.8</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.7">v0.6.7</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.6">v0.6.6</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.6-rc1">v0.6.6-rc1</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.5">v0.6.5</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.4">v0.6.4</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.3">v0.6.3</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.2">v0.6.2</a>
<a class="dropdown-item" data-toggle="tooltip" title="" href="https://insightsengineering.github.io/rtables/v0.6.1">v0.6.1</a>
</div>
</li>
</ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/insightsengineering/rtables">
    <span class="fa fa-github fa-lg"></span>

  </a>
</li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="../logo.png" class="logo" alt=""><h1>Example Complex Analysis Function: Modelling Cox Regression</h1>
                        <h4 data-toc-skip class="author">Emily de la Rua
and Gabriel Becker</h4>

            <h4 data-toc-skip class="date">2024-06-27</h4>

      <small class="dont-index">Source: <a href="https://github.com/insightsengineering/rtables/blob/main/vignettes/example_analysis_coxreg.Rmd" class="external-link"><code>vignettes/example_analysis_coxreg.Rmd</code></a></small>
      <div class="d-none name"><code>example_analysis_coxreg.Rmd</code></div>
    </div>



<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>In this vignette we will demonstrate how a complex analysis function
can be constructed in order to build highly-customized tables with
<code>rtables</code>. This example will detail the steps in creating an
analysis function to calculate a basic univariable Cox regression
summary table to analyze the treatment effect of the <code>ARM</code>
variable and any covariate/interaction effects for a survival analysis.
For a Cox regression analysis function with more customization options
and the capability of fitting multivariable Cox regression models, see
the <a href="https://insightsengineering.github.io/tern/main/reference/cox_regression.html" class="external-link"><code>summarize_coxreg()</code></a>
function from the <a href="https://insightsengineering.github.io/tern/main/index.html" class="external-link"><code>tern</code></a>
package, which builds upon the concepts used in the construction of this
example.</p>
<p>The packages used in this vignette are:</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/insightsengineering/rtables" class="external-link">rtables</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="data-pre-processing">Data Pre-Processing<a class="anchor" aria-label="anchor" href="#data-pre-processing"></a>
</h2>
<p>First, we prepare the data that will be used to generate a table in
this example. We will use the example <code>ADTTE</code> (Time-To-Event
Analysis) dataset <code>ex_adtte</code> from the <code>formatters</code>
package, which contains our treatment variable <code>ARM</code>, several
variables that can be chosen as covariates, and censor variable
<code>CNSR</code> from which we will derive the event variable
<code>EVENT</code> required for our model. For the purpose of this
example, we will use age (<code>AGE</code>) and race (<code>RACE</code>)
as our covariates.</p>
<p>We prepare the data as needed to observe the desired effects in our
summary table. <code>PARAMCD</code> is filtered so that only records of
overall survival (OS) are included, and we filter and mutate to include
only the levels of interest in our covariates. The <code>ARM</code>
variable is mutated to indicate that <code>"B: Placebo"</code> should be
used as the reference level of our treatment variable, and the
<code>EVENT</code> variable is derived from <code>CNSR</code>.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">adtte</span> <span class="op">&lt;-</span> <span class="va">ex_adtte</span></span>
<span></span>
<span><span class="va">anl</span> <span class="op">&lt;-</span> <span class="va">adtte</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">PARAMCD</span> <span class="op">==</span> <span class="st">"OS"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">ARM</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"A: Drug X"</span>, <span class="st">"B: Placebo"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html" class="external-link">filter</a></span><span class="op">(</span><span class="va">RACE</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"ASIAN"</span>, <span class="st">"BLACK OR AFRICAN AMERICAN"</span>, <span class="st">"WHITE"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>RACE <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="va">RACE</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>ARM <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/droplevels.html" class="external-link">droplevels</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/relevel.html" class="external-link">relevel</a></span><span class="op">(</span><span class="va">ARM</span>, <span class="st">"B: Placebo"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>EVENT <span class="op">=</span> <span class="fl">1</span> <span class="op">-</span> <span class="va">CNSR</span><span class="op">)</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-helper-functions-cox-regression-model-calculations">Creating Helper Functions: Cox Regression Model Calculations<a class="anchor" aria-label="anchor" href="#creating-helper-functions-cox-regression-model-calculations"></a>
</h2>
<div class="section level3">
<h3 id="tidy-method-for-summary-coxph-objects-tidy-summary-coxph">
<code>tidy</code> Method for <code>summary.coxph</code> Objects:
<code>tidy.summary.coxph</code><a class="anchor" aria-label="anchor" href="#tidy-method-for-summary-coxph-objects-tidy-summary-coxph"></a>
</h3>
<p>This method allows the <code>tidy</code> function from the
<code>broom</code> package to operate on <code>summary.coxph</code>
output, extracting the values of interest to this analysis and returning
a tidied <code><a href="https://tibble.tidyverse.org/reference/tibble.html" class="external-link">tibble::tibble()</a></code> object.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">tidy.summary.coxph</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, <span class="va">...</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/methods/is.html" class="external-link">is</a></span><span class="op">(</span><span class="va">x</span>, <span class="st">"summary.coxph"</span><span class="op">)</span></span>
<span>  <span class="va">pval</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">coefficients</span></span>
<span>  <span class="va">confint</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">$</span><span class="va">conf.int</span></span>
<span>  <span class="va">levels</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span></span>
<span>  <span class="va">pval</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span></span>
<span>  <span class="va">confint</span> <span class="op">&lt;-</span> <span class="fu">tibble</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html" class="external-link">as_tibble</a></span><span class="op">(</span><span class="va">confint</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">ret</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">pval</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"Pr"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">pval</span><span class="op">)</span><span class="op">)</span><span class="op">]</span>, <span class="va">confint</span><span class="op">)</span></span>
<span>  <span class="va">ret</span><span class="op">$</span><span class="va">level</span> <span class="op">&lt;-</span> <span class="va">levels</span></span>
<span>  <span class="va">ret</span><span class="op">$</span><span class="va">n</span> <span class="op">&lt;-</span> <span class="va">x</span><span class="op">[[</span><span class="st">"n"</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="va">ret</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="function-to-estimate-interaction-effects-h_coxreg_inter_effect">Function to Estimate Interaction Effects:
<code>h_coxreg_inter_effect</code><a class="anchor" aria-label="anchor" href="#function-to-estimate-interaction-effects-h_coxreg_inter_effect"></a>
</h3>
<p>The <code>h_coxreg_inter_effect</code> helper function is used within
the following helper function,
<code>h_coxreg_extract_interaction</code>, to estimate interaction
effects from a given model for a given covariate. The function
calculates the desired statistics from the given model and returns a
<code>data.frame</code> with label information for each row as well as
the statistics <code>n</code>, <code>hr</code> (hazard ratio),
<code>lcl</code> (CI lower bound), <code>ucl</code> (CI upper bound),
<code>pval</code> (effect p-value), and <code>pval_inter</code>
(interaction p-value). If a numeric covariate is selected, the median
value is used as the sole “level” for which an interaction effect is
calculated. For non-numeric covariates, an interaction effect is
calculated for each level of the covariate, with each result returned on
a separate row.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h_coxreg_inter_effect</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>,</span>
<span>                                  <span class="va">effect</span>,</span>
<span>                                  <span class="va">covar</span>,</span>
<span>                                  <span class="va">mod</span>,</span>
<span>                                  <span class="va">label</span>,</span>
<span>                                  <span class="va">control</span>,</span>
<span>                                  <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span>    <span class="va">attrs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>, <span class="st">"term.labels"</span><span class="op">)</span></span>
<span>    <span class="va">term_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="va">effect</span>, x <span class="op">=</span> <span class="va">attrs</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="st">"strata\\("</span>, <span class="va">attrs</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="va">betas</span> <span class="op">&lt;-</span> <span class="va">betas</span><span class="op">[</span><span class="va">term_indices</span><span class="op">]</span></span>
<span>    <span class="va">betas_var</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diag.html" class="external-link">diag</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">)</span><span class="op">[</span><span class="va">term_indices</span><span class="op">]</span></span>
<span>    <span class="va">betas_cov</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">[</span><span class="va">term_indices</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="va">term_indices</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">xval</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    <span class="va">effect_index</span> <span class="op">&lt;-</span> <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">covar</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">betas</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">coef_hat</span> <span class="op">&lt;-</span> <span class="va">betas</span><span class="op">[</span><span class="va">effect_index</span><span class="op">]</span> <span class="op">+</span> <span class="va">xval</span> <span class="op">*</span> <span class="va">betas</span><span class="op">[</span><span class="op">!</span><span class="va">effect_index</span><span class="op">]</span></span>
<span>    <span class="va">coef_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">betas_var</span><span class="op">[</span><span class="va">effect_index</span><span class="op">]</span> <span class="op">+</span> <span class="va">xval</span><span class="op">^</span><span class="fl">2</span> <span class="op">*</span> <span class="va">betas_var</span><span class="op">[</span><span class="op">!</span><span class="va">effect_index</span><span class="op">]</span> <span class="op">+</span> <span class="fl">2</span> <span class="op">*</span> <span class="va">xval</span> <span class="op">*</span> <span class="va">betas_cov</span><span class="op">)</span></span>
<span>    <span class="va">q_norm</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">control</span><span class="op">$</span><span class="va">conf_level</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">var_lvl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">effect</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">effect</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span> <span class="co"># [-1]: reference level</span></span>
<span>    <span class="va">giv_lvl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">covar</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">design_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/expand.grid.html" class="external-link">expand.grid</a></span><span class="op">(</span>effect <span class="op">=</span> <span class="va">var_lvl</span>, covar <span class="op">=</span> <span class="va">giv_lvl</span><span class="op">)</span></span>
<span>    <span class="va">design_mat</span> <span class="op">&lt;-</span> <span class="va">design_mat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html" class="external-link">order</a></span><span class="op">(</span><span class="va">design_mat</span><span class="op">$</span><span class="va">effect</span>, <span class="va">design_mat</span><span class="op">$</span><span class="va">covar</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">design_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/with.html" class="external-link">within</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">design_mat</span>, expr <span class="op">=</span> <span class="op">{</span></span>
<span>      <span class="va">inter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">effect</span>, <span class="st">":"</span>, <span class="va">covar</span><span class="op">)</span></span>
<span>      <span class="va">rev_inter</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="va">covar</span>, <span class="st">":"</span>, <span class="va">effect</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">split_by_variable</span> <span class="op">&lt;-</span> <span class="va">design_mat</span><span class="op">$</span><span class="va">effect</span></span>
<span>    <span class="va">interaction_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="va">design_mat</span><span class="op">$</span><span class="va">effect</span>, <span class="va">design_mat</span><span class="op">$</span><span class="va">covar</span>, sep <span class="op">=</span> <span class="st">"/"</span><span class="op">)</span></span>
<span>    <span class="va">mmat</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/model.matrix.html" class="external-link">model.matrix</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span></span>
<span>    <span class="va">mmat</span><span class="op">[</span><span class="op">!</span><span class="va">mmat</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>    <span class="va">design_mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">design_mat</span>, MARGIN <span class="op">=</span> <span class="fl">1</span>, FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">mmat</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">mmat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">x</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">==</span> <span class="st">"covar"</span><span class="op">)</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span>      <span class="va">mmat</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">design_mat</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="va">interaction_names</span></span>
<span>    <span class="va">coef</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/coef.html" class="external-link">coef</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span>    <span class="va">vcov</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/vcov.html" class="external-link">vcov</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span></span>
<span>    <span class="va">betas</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">coef</span><span class="op">)</span></span>
<span>    <span class="va">coef_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">design_mat</span><span class="op">)</span> <span class="op"><a href="https://rdrr.io/r/base/matmult.html" class="external-link">%*%</a></span> <span class="va">betas</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/dimnames.html" class="external-link">dimnames</a></span><span class="op">(</span><span class="va">coef_hat</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">"coef"</span></span>
<span>    <span class="va">coef_se</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">design_mat</span>, <span class="fl">2</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">vcov_el</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="va">vcov</span><span class="op">[</span><span class="va">vcov_el</span>, <span class="va">vcov_el</span><span class="op">]</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>      <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">sqrt</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>      <span class="va">y</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">q_norm</span> <span class="op">&lt;-</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">qnorm</a></span><span class="op">(</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="va">control</span><span class="op">$</span><span class="va">conf_level</span><span class="op">)</span> <span class="op">/</span> <span class="fl">2</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">cbind</a></span><span class="op">(</span><span class="va">coef_hat</span>, `se(coef)` <span class="op">=</span> <span class="va">coef_se</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">y</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="st">"hr"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="st">"coef"</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="st">"lcl"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="st">"coef"</span><span class="op">]</span> <span class="op">-</span> <span class="va">q_norm</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"se(coef)"</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">x</span><span class="op">[</span><span class="st">"ucl"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">x</span><span class="op">[</span><span class="st">"coef"</span><span class="op">]</span> <span class="op">+</span> <span class="va">q_norm</span> <span class="op">*</span> <span class="va">x</span><span class="op">[</span><span class="st">"se(coef)"</span><span class="op">]</span><span class="op">)</span></span>
<span>      <span class="va">x</span></span>
<span>    <span class="op">}</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">y</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/by.html" class="external-link">by</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">split_by_variable</span>, <span class="va">identity</span><span class="op">)</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">y</span>, <span class="va">as.matrix</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="va">y</span>, <span class="st">"details"</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span></span>
<span>      <span class="st">"Estimations of "</span>, <span class="va">effect</span>, <span class="st">" hazard ratio given the level of "</span>, <span class="va">covar</span>, <span class="st">" compared to "</span>,</span>
<span>      <span class="va">effect</span>, <span class="st">" level "</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">effect</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"."</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">xval</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>    effect <span class="op">=</span> <span class="st">"Covariate:"</span>,</span>
<span>    term <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">covar</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">xval</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    term_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"  "</span>, <span class="va">xval</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="va">xval</span><span class="op">)</span>,</span>
<span>    n <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    hr <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">coef_hat</span><span class="op">)</span> <span class="kw">else</span> <span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"hr"</span><span class="op">]</span>,</span>
<span>    lcl <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">coef_hat</span> <span class="op">-</span> <span class="va">q_norm</span> <span class="op">*</span> <span class="va">coef_se</span><span class="op">)</span> <span class="kw">else</span> <span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"lcl"</span><span class="op">]</span>,</span>
<span>    ucl <span class="op">=</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">is.numeric</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">coef_hat</span> <span class="op">+</span> <span class="va">q_norm</span> <span class="op">*</span> <span class="va">coef_se</span><span class="op">)</span> <span class="kw">else</span> <span class="va">y</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>, <span class="st">"ucl"</span><span class="op">]</span>,</span>
<span>    pval <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    pval_inter <span class="op">=</span> <span class="cn">NA</span>,</span>
<span>    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level3">
<h3 id="function-to-extract-effect-information-h_coxreg_extract_interaction">Function to Extract Effect Information:
<code>h_coxreg_extract_interaction</code><a class="anchor" aria-label="anchor" href="#function-to-extract-effect-information-h_coxreg_extract_interaction"></a>
</h3>
<p>Using the previous two helper functions,
<code>h_coxreg_extract_interaction</code> uses ANOVA to extract
information from the given model about the given covariate. This
function will extract different information depending on whether the
effect of interest is a treatment/main effect or an interaction effect,
and returns a <code>data.frame</code> with label information for each
row (corresponding to each effect) as well as the statistics
<code>n</code>, <code>hr</code>, <code>lcl</code>, <code>ucl</code>,
<code>pval</code>, and <code>pval_inter</code> (for interaction effects
only). This helper function is used directly within our analysis
function to analyze the Cox regression model and extract relevant
information to be processed and displayed within our output table.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">h_coxreg_extract_interaction</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">effect</span>, <span class="va">covar</span>, <span class="va">mod</span>, <span class="va">data</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="va">control</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>pval_method <span class="op">=</span> <span class="st">"wald"</span>, ties <span class="op">=</span> <span class="st">"exact"</span>, conf_level <span class="op">=</span> <span class="fl">0.95</span>, interaction <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">test_statistic</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span>wald <span class="op">=</span> <span class="st">"Wald"</span>, likelihood <span class="op">=</span> <span class="st">"LR"</span><span class="op">)</span><span class="op">[</span><span class="va">control</span><span class="op">$</span><span class="va">pval_method</span><span class="op">]</span></span>
<span>  <span class="va">mod_aov</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">withCallingHandlers</a></span><span class="op">(</span></span>
<span>    expr <span class="op">=</span> <span class="fu">car</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/car/man/Anova.html" class="external-link">Anova</a></span><span class="op">(</span><span class="va">mod</span>, test.statistic <span class="op">=</span> <span class="va">test_statistic</span>, type <span class="op">=</span> <span class="st">"III"</span><span class="op">)</span>,</span>
<span>    message <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">m</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/conditions.html" class="external-link">invokeRestart</a></span><span class="op">(</span><span class="st">"muffleMessage"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  <span class="va">msum</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>, <span class="st">"order"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">mod</span>, conf.int <span class="op">=</span> <span class="va">control</span><span class="op">$</span><span class="va">conf_level</span><span class="op">)</span> <span class="kw">else</span> <span class="va">mod_aov</span></span>
<span>  <span class="va">sum_anova</span> <span class="op">&lt;-</span> <span class="fu">broom</span><span class="fu">::</span><span class="fu"><a href="https://generics.r-lib.org/reference/tidy.html" class="external-link">tidy</a></span><span class="op">(</span><span class="va">msum</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/attr.html" class="external-link">attr</a></span><span class="op">(</span><span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/terms.html" class="external-link">terms</a></span><span class="op">(</span><span class="va">mod</span><span class="op">)</span>, <span class="st">"order"</span><span class="op">)</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">effect_aov</span> <span class="op">&lt;-</span> <span class="va">mod_aov</span><span class="op">[</span><span class="va">effect</span>, , drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span></span>
<span>    <span class="va">pval</span> <span class="op">&lt;-</span> <span class="va">effect_aov</span><span class="op">[[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span>pattern <span class="op">=</span> <span class="st">"Pr"</span>, x <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">effect_aov</span><span class="op">)</span><span class="op">)</span>, drop <span class="op">=</span> <span class="cn">TRUE</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">sum_main</span> <span class="op">&lt;-</span> <span class="va">sum_anova</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grepl</a></span><span class="op">(</span><span class="va">effect</span>, <span class="va">sum_anova</span><span class="op">$</span><span class="va">level</span><span class="op">)</span>, <span class="op">]</span></span>
<span>    <span class="va">term_label</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">effect</span> <span class="op">==</span> <span class="va">covar</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>, <span class="st">" vs control ("</span>, <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">")"</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu">formatters</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/formatters/latest-tag/reference/var_labels.html" class="external-link">var_labels</a></span><span class="op">(</span><span class="va">data</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      effect <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">covar</span> <span class="op">==</span> <span class="va">effect</span>, <span class="st">"Treatment:"</span>, <span class="st">"Covariate:"</span><span class="op">)</span>,</span>
<span>      term <span class="op">=</span> <span class="va">covar</span>, term_label <span class="op">=</span> <span class="va">term_label</span>,</span>
<span>      level <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">data</span><span class="op">[[</span><span class="va">effect</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span>,</span>
<span>      n <span class="op">=</span> <span class="va">mod</span><span class="op">[[</span><span class="st">"n"</span><span class="op">]</span><span class="op">]</span>, hr <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">sum_main</span><span class="op">[</span><span class="st">"exp(coef)"</span><span class="op">]</span><span class="op">)</span>, lcl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">sum_main</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"lower"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sum_main</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      ucl <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">sum_main</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">"upper"</span>, <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">sum_main</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span>, pval <span class="op">=</span> <span class="va">pval</span>,</span>
<span>      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="va">y</span><span class="op">$</span><span class="va">pval_inter</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span>    <span class="va">y</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="va">pval</span> <span class="op">&lt;-</span> <span class="va">sum_anova</span><span class="op">[</span><span class="va">sum_anova</span><span class="op">$</span><span class="va">term</span> <span class="op">==</span> <span class="va">effect</span>, <span class="op">]</span><span class="op">[[</span><span class="st">"p.value"</span><span class="op">]</span><span class="op">]</span></span>
<span></span>
<span>    <span class="co">## Test the interaction effect</span></span>
<span>    <span class="va">pval_inter</span> <span class="op">&lt;-</span> <span class="va">sum_anova</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/grep.html" class="external-link">grep</a></span><span class="op">(</span><span class="st">":"</span>, <span class="va">sum_anova</span><span class="op">$</span><span class="va">term</span><span class="op">)</span>, <span class="op">]</span><span class="op">[[</span><span class="st">"p.value"</span><span class="op">]</span><span class="op">]</span></span>
<span>    <span class="va">covar_test</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span></span>
<span>      effect <span class="op">=</span> <span class="st">"Covariate:"</span>,</span>
<span>      term <span class="op">=</span> <span class="va">covar</span>, term_label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu">formatters</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/formatters/latest-tag/reference/var_labels.html" class="external-link">var_labels</a></span><span class="op">(</span><span class="va">data</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      level <span class="op">=</span> <span class="st">""</span>,</span>
<span>      n <span class="op">=</span> <span class="va">mod</span><span class="op">$</span><span class="va">n</span>, hr <span class="op">=</span> <span class="cn">NA</span>, lcl <span class="op">=</span> <span class="cn">NA</span>, ucl <span class="op">=</span> <span class="cn">NA</span>, pval <span class="op">=</span> <span class="va">pval</span>,</span>
<span>      pval_inter <span class="op">=</span> <span class="va">pval_inter</span>,</span>
<span>      stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co">## Estimate the interaction</span></span>
<span>    <span class="va">y</span> <span class="op">&lt;-</span> <span class="fu">h_coxreg_inter_effect</span><span class="op">(</span></span>
<span>      <span class="va">data</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span>,</span>
<span>      covar <span class="op">=</span> <span class="va">covar</span>,</span>
<span>      effect <span class="op">=</span> <span class="va">effect</span>,</span>
<span>      mod <span class="op">=</span> <span class="va">mod</span>,</span>
<span>      label <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="fu">formatters</span><span class="fu">::</span><span class="fu"><a href="https://insightsengineering.github.io/formatters/latest-tag/reference/var_labels.html" class="external-link">var_labels</a></span><span class="op">(</span><span class="va">data</span>, fill <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">[[</span><span class="va">covar</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>      control <span class="op">=</span> <span class="va">control</span>,</span>
<span>      data <span class="op">=</span> <span class="va">data</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="fu"><a href="../reference/rbind.html">rbind</a></span><span class="op">(</span><span class="va">covar_test</span>, <span class="va">y</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
</div>
<div class="section level2">
<h2 id="creating-a-helper-function-cached_model">Creating a Helper Function: <code>cached_model</code><a class="anchor" aria-label="anchor" href="#creating-a-helper-function-cached_model"></a>
</h2>
<p>Next, we will create a helper function, <code>cached_model</code>,
which will be used within our analysis function to cache and return the
fitted Cox regression model for the current covariate. The
<code>df</code> argument will be directly inherited from the
<code>df</code> argument passed to the analysis function, which contains
the full dataset being analyzed. The <code>cov</code> argument will be
the covariate that is being analyzed depending on the current row
context. If the treatment effect is currently being analyzed, this value
will be an empty string. The <code>cache_env</code> parameter will be an
environment object which is used to store the model for the current
covariate, also passed down from the analysis function. Of course, this
function can also be run outside of the analysis function and will still
cache and return a Cox regression model.</p>
<p>Using these arguments, the <code>cached_model</code> function first
checks if a model for the given covariate <code>cov</code> is already
stored in the caching environment <code>cache_env</code>. If so, then
this model is retrieved and returned by <code>cached_model</code>. If
not, the model must be constructed. This is done by first constructing
the model formula, <code>model_form</code>, starting with only the
treatment effect (<code>ARM</code>) and adding a covariate effect if one
is currently being analyzed. Then a Cox regression model is fit using
<code>df</code> and the model formula, and this model is both returned
and stored in the caching environment object as
<code>cache_env[[cov]]</code>.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cached_model</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>, <span class="va">cov</span>, <span class="va">cache_env</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Check if a model already exists for</span></span>
<span>  <span class="co">## `cov` in the caching environment</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">cache_env</span><span class="op">[[</span><span class="va">cov</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## If model already exists, retrieve it from cache_env</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="va">cache_env</span><span class="op">[[</span><span class="va">cov</span><span class="op">]</span><span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co">## Build model formula</span></span>
<span>    <span class="va">model_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="st">"survival::Surv(AVAL, EVENT) ~ ARM"</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span> <span class="op">&gt;</span> <span class="fl">0</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">model_form</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">model_form</span>, <span class="va">cov</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">" * "</span><span class="op">)</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">cov</span> <span class="op">&lt;-</span> <span class="st">"ARM"</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co">## Calculate Cox regression model</span></span>
<span>    <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">survival</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/coxph.html" class="external-link">coxph</a></span><span class="op">(</span></span>
<span>      formula <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/formula.html" class="external-link">as.formula</a></span><span class="op">(</span><span class="va">model_form</span><span class="op">)</span>,</span>
<span>      data <span class="op">=</span> <span class="va">df</span>,</span>
<span>      ties <span class="op">=</span> <span class="st">"exact"</span></span>
<span>    <span class="op">)</span></span>
<span>    <span class="co">## Store model in the caching environment</span></span>
<span>    <span class="va">cache_env</span><span class="op">[[</span><span class="va">cov</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">model</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="va">model</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="creating-the-analysis-function-a_cox_summary">Creating the Analysis Function: <code>a_cox_summary</code><a class="anchor" aria-label="anchor" href="#creating-the-analysis-function-a_cox_summary"></a>
</h2>
<p>With our data prepared and helper function created, we can proceed to
construct our analysis function <code>a_cox_summary</code>, which will
be used to populate all of the rows in our table. In order to be used to
generate both data rows (for interaction effects) and content rows (for
main effects), we must create a function that can be used as both
<code>afun</code> in <code>analyze</code> and <code>cfun</code> in
<code>summarize_row_groups</code>. Therefore, our function must accept
the <code>labelstr</code> parameter.</p>
<p>The arguments of our analysis function will be as follows:</p>
<ul>
<li>
<code>df</code> - a <code>data.frame</code> of the full dataset
required to fit the Cox regression model.</li>
<li>
<code>labelstr</code> - the <code>string</code> label for the
variable being analyzed in the current row/column split context.</li>
<li>
<code>.spl_context</code> - a <code>data.frame</code> containing the
<code>value</code> column which is used by this analysis function to
determine the name of the variable/covariate in the current split. For
more details on the information stored by <code>.spl_context</code> see
<code><a href="../reference/analyze.html">?analyze</a></code>.</li>
<li>
<code>stat</code> and <code>format</code> - <code>string</code>s
that indicate which statistic column we are currently in and what format
should be applied to print the statistic.</li>
<li>
<code>cache_env</code> - an <code>environment</code> object that can
be used to store cached models so that we can prevent repeatedly fitting
the same model. Instead, each model will be generated once per covariate
and then reused. This argument will be passed directly to the
<code>cached_model</code> helper function we defined previously.</li>
<li>
<code>cov_main</code> - a <code>logical</code> value indicating
whether or not the current row is summarizing covariate main
effects.</li>
</ul>
<p>The analysis function works within a given row/column split context
by using the current covariate (<code>cov</code>) and the
<code>cached_model</code> function to obtain the desired Cox regression
model. From this model, the <code>h_coxreg_extract_interaction</code>
function is able to extract information/statistics relevant to the
analysis and store it in a <code>data.frame</code>. The rows in this
<code>data.frame</code> that are of interest in the current row/column
split context are then extracted and the statistic to be printed in the
current column is retrieved from these rows. Finally, the formatted
cells with this statistic are returned as a
<code>VerticalRowsSection</code> object. For more detail see the
commented function code below, where the purpose of each line within
<code>a_cox_summary</code> is described.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">a_cox_summary</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">df</span>,</span>
<span>                          <span class="va">labelstr</span> <span class="op">=</span> <span class="st">""</span>,</span>
<span>                          <span class="va">.spl_context</span>,</span>
<span>                          <span class="va">stat</span>,</span>
<span>                          <span class="va">format</span>,</span>
<span>                          <span class="va">cache_env</span>,</span>
<span>                          <span class="va">cov_main</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>  <span class="co">## Get current covariate (variable used in latest row split)</span></span>
<span>  <span class="va">cov</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/head_tail.html">tail</a></span><span class="op">(</span><span class="va">.spl_context</span><span class="op">$</span><span class="va">value</span>, <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## If currently analyzing treatment effect (ARM) replace empty</span></span>
<span>  <span class="co">## value of cov with "ARM" so the correct model row is analyzed</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">cov</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span><span class="op">)</span> <span class="va">cov</span> <span class="op">&lt;-</span> <span class="st">"ARM"</span></span>
<span></span>
<span>  <span class="co">## Use cached_model to get the fitted Cox regression</span></span>
<span>  <span class="co">## model for the current covariate</span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">cached_model</span><span class="op">(</span>df <span class="op">=</span> <span class="va">df</span>, cov <span class="op">=</span> <span class="va">cov</span>, cache_env <span class="op">=</span> <span class="va">cache_env</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Extract levels of cov to be used as row labels for interaction effects.</span></span>
<span>  <span class="co">## If cov is numeric, the median value of cov is used as a row label instead</span></span>
<span>  <span class="va">cov_lvls</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">is.factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">cov</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span> <span class="fu"><a href="https://rdrr.io/r/base/levels.html" class="external-link">levels</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">cov</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="kw">else</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html" class="external-link">as.character</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/median.html" class="external-link">median</a></span><span class="op">(</span><span class="va">df</span><span class="op">[[</span><span class="va">cov</span><span class="op">]</span><span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## Use function to calculate and extract information relevant to cov from the model</span></span>
<span>  <span class="va">cov_rows</span> <span class="op">&lt;-</span> <span class="fu">h_coxreg_extract_interaction</span><span class="op">(</span>effect <span class="op">=</span> <span class="st">"ARM"</span>, covar <span class="op">=</span> <span class="va">cov</span>, mod <span class="op">=</span> <span class="va">model</span>, data <span class="op">=</span> <span class="va">df</span><span class="op">)</span></span>
<span>  <span class="co">## Effect p-value is only printed for treatment effect row</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">cov</span> <span class="op">==</span> <span class="st">"ARM"</span><span class="op">)</span> <span class="va">cov_rows</span><span class="op">[</span>, <span class="st">"pval"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA_real_</span></span>
<span>  <span class="co">## Extract rows containing statistics for cov from model information</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">cov_main</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co">## Extract rows for main effect</span></span>
<span>    <span class="va">cov_rows</span> <span class="op">&lt;-</span> <span class="va">cov_rows</span><span class="op">[</span><span class="va">cov_rows</span><span class="op">$</span><span class="va">level</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">cov_lvls</span>, <span class="op">]</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>    <span class="co">## Extract all non-main effect rows</span></span>
<span>    <span class="va">cov_rows</span> <span class="op">&lt;-</span> <span class="va">cov_rows</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/nchar.html" class="external-link">nchar</a></span><span class="op">(</span><span class="va">cov_rows</span><span class="op">$</span><span class="va">level</span><span class="op">)</span> <span class="op">==</span> <span class="fl">0</span>, <span class="op">]</span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="co">## Extract value(s) of statistic for current column and variable/levels</span></span>
<span>  <span class="va">stat_vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">as.list</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span><span class="va">cov_rows</span><span class="op">[</span><span class="va">stat</span><span class="op">]</span>, <span class="fl">1</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">x</span>, simplify <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="co">## Assign labels: covariate name for main effect (content) rows, ARM comparison description</span></span>
<span>  <span class="co">## for treatment effect (content) row, cov_lvls for interaction effect (data) rows</span></span>
<span>  <span class="va">nms</span> <span class="op">&lt;-</span> <span class="kw">if</span> <span class="op">(</span><span class="va">cov_main</span><span class="op">)</span> <span class="va">labelstr</span> <span class="kw">else</span> <span class="kw">if</span> <span class="op">(</span><span class="va">cov</span> <span class="op">==</span> <span class="st">"ARM"</span><span class="op">)</span> <span class="va">cov_rows</span><span class="op">$</span><span class="va">term_label</span> <span class="kw">else</span> <span class="va">cov_lvls</span></span>
<span>  <span class="co">## Return formatted/labelled row</span></span>
<span>  <span class="fu"><a href="../reference/in_rows.html">in_rows</a></span><span class="op">(</span></span>
<span>    .list <span class="op">=</span> <span class="va">stat_vals</span>,</span>
<span>    .names <span class="op">=</span> <span class="va">nms</span>,</span>
<span>    .labels <span class="op">=</span> <span class="va">nms</span>,</span>
<span>    .formats <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">format</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nms</span><span class="op">)</span><span class="op">)</span>, <span class="va">nms</span><span class="op">)</span>,</span>
<span>    .format_na_strs <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/setNames.html" class="external-link">setNames</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">""</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">nms</span><span class="op">)</span><span class="op">)</span>, <span class="va">nms</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="selecting-parameters">Selecting Parameters<a class="anchor" aria-label="anchor" href="#selecting-parameters"></a>
</h2>
<p>We are able to customize our Cox regression summary using this
analysis function by selecting covariates (and their labels), statistics
(and their labels), and statistic formats to use when generating the
output table. We also initialize a new environment object to be used by
the analysis function as the caching environment to store our models in.
For the purpose of this example, we will choose all 5 of the possible
statistics to include in the table: n, hazard ratio, confidence
interval, effect p-value, and interaction p-value.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">my_covs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"AGE"</span>, <span class="st">"RACE"</span><span class="op">)</span> <span class="co">## Covariates</span></span>
<span><span class="va">my_cov_labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Age"</span>, <span class="st">"Race"</span><span class="op">)</span> <span class="co">## Covariate labels</span></span>
<span><span class="va">my_stats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"hr"</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"lcl"</span>, <span class="st">"ucl"</span><span class="op">)</span>, <span class="st">"pval"</span>, <span class="st">"pval_inter"</span><span class="op">)</span> <span class="co">## Statistics</span></span>
<span><span class="va">my_stat_labs</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"n"</span>, <span class="st">"Hazard Ratio"</span>, <span class="st">"95% CI"</span>, <span class="st">"p-value\n(effect)"</span>, <span class="st">"p-value\n(interaction)"</span><span class="op">)</span> <span class="co">## Statistic labels</span></span>
<span><span class="va">my_formats</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span>
<span>  n <span class="op">=</span> <span class="st">"xx"</span>, hr <span class="op">=</span> <span class="st">"xx.xx"</span>, lcl <span class="op">=</span> <span class="st">"(xx.xx, xx.xx)"</span>, pval <span class="op">=</span> <span class="st">"xx.xxxx"</span>, pval_inter <span class="op">=</span> <span class="st">"xx.xxxx"</span> <span class="co">## Statistic formats</span></span>
<span><span class="op">)</span></span>
<span><span class="va">my_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/environment.html" class="external-link">new.env</a></span><span class="op">(</span><span class="op">)</span></span>
<span><span class="va">ny_cache_env</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">replicate</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">my_stats</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">my_env</span><span class="op">)</span><span class="op">)</span> <span class="co">## Caching environment</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="constructing-the-table">Constructing the Table<a class="anchor" aria-label="anchor" href="#constructing-the-table"></a>
</h2>
<p>Finally, the table layout can be constructed and used to build the
desired table.</p>
<p>We first split our <code>basic_table</code> using
<code>split_cols_by_multivar</code> to ensure that each statistic exists
in its own column. To do so, we choose a variable (in this case
<code>STUDYID</code>) which shares the same value in every row, and use
it as the split variable for every column so that the full dataset is
used to compute the model for every column. We use the
<code>extra_args</code> argument for which each list element’s element
positions correspond to the children of (columns generated by) this
split. These arguments are inherited by all following layout elements
operating within this split, which use these elements as argument
inputs. To elaborate on this, we have three elements in
<code>extra_args</code>: <code>stat</code>, <code>format</code>, and
<code>cache_env</code> - each of which are arguments of
<code>a_cox_summary</code> and have length equal to the number of
columns (as defined above). For each use of our analysis function
following this column split, depending on the current column context,
the corresponding element of each of these three list elements will be
inherited from <code>extra_args</code> and used as input. For example,
if <code>analyze_colvars</code> is called with
<code>a_cox_summary</code> as <code>afun</code> and is performing
calculations for column 1, <code>my_stats[1]</code> (<code>"n"</code>)
will be given as argument <code>stat</code>, <code>my_formats[1]</code>
(<code>"xx"</code>) as argument <code>format</code>, and
<code>my_cache_env[1]</code> (<code>my_env</code>) as
<code>cache_env</code>. This is useful for our table since we want each
column to print out values for a different statistic and apply its
corresponding format.</p>
<p>Next, we can use <code>summarize_row_groups</code> to generate the
content row for treatment effect. This is the first instance where
<code>extra_args</code> from the column split will be inherited and used
as argument input in <code>cfun</code>.</p>
<p>After generating the treatment effect row, we want to add rows for
covariates. We use <code>split_rows_by_multivar</code> to split rows by
covariate and apply appropriate labels.</p>
<p>Following this row split, we use <code>summarize_row_groups</code>
with <code>a_cox_summary</code> as <code>cfun</code> to generate one
content row for each covariate main effect. Once again the contents of
<code>extra_args</code> from the column split are inherited as input.
Here we specify <code>cov_main = TRUE</code> in the
<code>extra_args</code> argument so that main effects rather than
interactions are considered. Since this is not a split, this instance of
<code>extra_args</code> is not inherited by any following layout
elements. As <code>cov_main</code> is a singular value,
<code>cov_main = TRUE</code> will be used within every column
context.</p>
<p>The last part of our table is the covariate interaction effects. We
use <code>analyze_colvars</code> with <code>a_cox_summary</code> as
<code>afun</code>, and again inherit <code>extra_args</code> from the
column split. Using an <code>rtables</code> “analyze” function generates
data rows, with one row corresponding to each covariate level (or median
value, for numeric covariates), nested under the content row (main
effect) for that same covariate.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">lyt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/basic_table.html">basic_table</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co">## Column split: one column for each statistic</span></span>
<span>  <span class="fu"><a href="../reference/split_cols_by_multivar.html">split_cols_by_multivar</a></span><span class="op">(</span></span>
<span>    vars <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="st">"STUDYID"</span>, <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">my_stats</span><span class="op">)</span><span class="op">)</span>,</span>
<span>    varlabels <span class="op">=</span> <span class="va">my_stat_labs</span>,</span>
<span>    extra_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>      stat <span class="op">=</span> <span class="va">my_stats</span>,</span>
<span>      format <span class="op">=</span> <span class="va">my_formats</span>,</span>
<span>      cache_env <span class="op">=</span> <span class="va">ny_cache_env</span></span>
<span>    <span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co">## Create content row for treatment effect</span></span>
<span>  <span class="fu"><a href="../reference/summarize_row_groups.html">summarize_row_groups</a></span><span class="op">(</span>cfun <span class="op">=</span> <span class="va">a_cox_summary</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co">## Row split: one content row for each covariate</span></span>
<span>  <span class="fu"><a href="../reference/split_rows_by_multivar.html">split_rows_by_multivar</a></span><span class="op">(</span></span>
<span>    vars <span class="op">=</span> <span class="va">my_covs</span>,</span>
<span>    varlabels <span class="op">=</span> <span class="va">my_cov_labs</span>,</span>
<span>    split_label <span class="op">=</span> <span class="st">"Covariate:"</span>,</span>
<span>    indent_mod <span class="op">=</span> <span class="op">-</span><span class="fl">1</span> <span class="co">## Align split label left</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co">## Create content rows for covariate main effects</span></span>
<span>  <span class="fu"><a href="../reference/summarize_row_groups.html">summarize_row_groups</a></span><span class="op">(</span></span>
<span>    cfun <span class="op">=</span> <span class="va">a_cox_summary</span>,</span>
<span>    extra_args <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>cov_main <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="co">## Create data rows for covariate interaction effects</span></span>
<span>  <span class="fu"><a href="../reference/analyze_colvars.html">analyze_colvars</a></span><span class="op">(</span>afun <span class="op">=</span> <span class="va">a_cox_summary</span><span class="op">)</span></span></code></pre></div>
<p>Using our pre-processed <code>anl</code> dataset, we can now build
and output our final Cox regression summary table.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">cox_tbl</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/build_table.html">build_table</a></span><span class="op">(</span><span class="va">lyt</span>, <span class="va">anl</span><span class="op">)</span></span>
<span><span class="va">cox_tbl</span></span></code></pre></div>
<pre><code><span><span class="co">##                                                                         p-value       p-value   </span></span>
<span><span class="co">##                                      n    Hazard Ratio      95% CI      (effect)   (interaction)</span></span>
<span><span class="co">## ————————————————————————————————————————————————————————————————————————————————————————————————</span></span>
<span><span class="co">## A: Drug X vs control (B: Placebo)   247       0.97       (0.71, 1.32)    0.8243                 </span></span>
<span><span class="co">## Covariate:                                                                                      </span></span>
<span><span class="co">##   Age                               247                                               0.7832    </span></span>
<span><span class="co">##     34                                        0.92       (0.68, 1.26)                           </span></span>
<span><span class="co">##   Race                              247                                               0.7441    </span></span>
<span><span class="co">##     ASIAN                                     1.03       (0.68, 1.57)                           </span></span>
<span><span class="co">##     BLACK OR AFRICAN AMERICAN                 0.78       (0.41, 1.49)                           </span></span>
<span><span class="co">##     WHITE                                     1.06       (0.55, 2.04)</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="nest">
  <p>rtables is a part of the <strong>NEST</strong> and <a href="https://pharmaverse.org/" class="external-link"><strong>pharmaverse</strong></a>.</p>
</div>
<script type="text/javascript" src="../analytics.js"></script></footer>
</div>





  </body>
</html>
