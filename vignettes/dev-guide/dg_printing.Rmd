---
title: "Printing Machinery"
author: "Davide Garolini"
date: '`r Sys.Date()`'
output:
  html_document:
    theme: spacelab
    toc: true
    toc_float:
      collapsed: false
editor_options:
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


## Disclaimer

In comparison to other entries of the dev-guide, this is intended to keep track of the general concepts and processing pipeline behind the printing machinery. It is not intended to be a complete documentation of the machinery itself, but rather a collection of notes that can be used to understand the machinery and its internals. Hence, be aware that this is a working document that captures a snapshot of the machinery at a certain point in time. It is not meant to be fully maintained, but it can be used as a starting point for one.


### How `print` works

Lets track down what is going under the hood when a standard table is printed. The following is the code that is executed when a table is printed:

```{r}
library(rtables)
library(dplyr)
lyt <- basic_table() %>% 
  split_rows_by("SEX", split_fun = keep_split_levels(c("F", "M"))) %>% 
  split_cols_by("ARM") %>% 
  analyze("BMRKR1") %>% 
  print()
tbl <- build_table(lyt, ex_adsl) %>% 
  print()
```

We see that also a layout object (`PreDataTableLayouts`) is created and printed. This is because `print` is a generic function that dispatches to different methods depending on the class of the object. In this case, the S4 class of the object is `PreDataTableLayouts` and the method that is called is `print`. In the case of {rtables} the method is dispatched towards the `show` method of the class `PreDataTableLayouts`. It can be found by searching `A Pre-data Table Layout` into {rtables} source code. I think R dispatcher for `print` methods looks for `show` S4 methods instead if there are no S3 `print` methods available. Indeed, this is the code that is executed:

```{r, eval=FALSE}
setMethod(
  "show", "PreDataTableLayouts",
  function(object) {
    cat("A Pre-data Table Layout\n")
    cat("\nColumn-Split Structure:\n")
    docat_predataxis(object@col_layout)
    cat("\nRow-Split Structure:\n")
    docat_predataxis(object@row_layout)
    cat("\n")
    invisible(object)
  }
)
```

This was evident if we searched for methods associated with the class `PreDataTableLayouts`, where only show is connected to a sort of printing machinery:

```{r, eval=TRUE}
methods(class = "PreDataTableLayouts")
```

Now, lets see the same for our result table `tbl`: 

```{r}
class(tbl) %>% print()

getClass("TableTree") %>% print() # Main object representing a table in {rtables}

methods(class = "TableTree") %>% print() # more than 70 methods but no print method
```

Again, lets see how the `show` method is used here. Note: if you search for `VTableTree"` you will find the `show` method for the `TableTree` class. This is because `VTableTree` is a virtual class that inherits from `TableTree` and is used to define the `show` method for `TableTree` objects. You will find also a `print` statement that does the same thing, i.e. it calls `toString` and `cat` on the object. Hence, we know that every table is printed by `toString` with `\n` as separator for different lines while `cat` reproduces the object into file.


### `toString`
