---
title: "Introduction to rtables"
author: "Gabriel Becker and Adrian Waddell"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to rtables}
  %\VignetteEncoding{UTF-8}
  %\VignetteEngine{knitr::rmarkdown}
editor_options: 
  chunk_output_type: console
---



```{r, echo=FALSE}
knitr::opts_chunk$set(comment = "")
```

## Introduction

The `rtables` R package provides a framework to create, tabulate and output tables in `R`. Most of the requirements in the design phase of `rtables` were taken from tables that are commonly used to report analyses from clinical trials, however, we were careful to keep `rtables` a general purpose toolkit. 

There are a number of other table frameworks available in `R` such as [gt](https://gt.rstudio.com/) from RStudio, [xtable](https://cran.r-project.org/web/packages/xtable/index.html), [tableone](https://cran.r-project.org/web/packages/tableone/vignettes/introduction.html) and [tables](https://cran.r-project.org/web/packages/tables/index.html) to name a few. One reason to implement `rtables` was that to report clinical trials data the tables are often outputted in ASCII and paginated, a functionality not found in the packages just mentioned. `rtables` has a strong focus on tabulation and organizing and accessing information where other packages such as `gt` provide more functionality to markup and output tables (in html and markdown). We are currently not planning to extend the `rtables` features to add those type of functionality, instead it is on our roadmap to provide coercion functions from `rtable` to `gt`.

In the remainder of this vignette we give a short introduction into `rtables` and tabulating a table. The content is based on the useR 2020 presentation from Gabriel Becker.

The packages used for this vignettes ar `rtables` and `dplyr`:

```{r, message=FALSE}
library(rtables)
library(dplyr)
```

## Data 

The data used in this vignette is a made up using random number generators. The data content is relatively simple: one row per represents one observation of an imaginary person where we measure a study arm, the country of origin, gender, handedness, age, and weight:

```{r data}
n <- 400

set.seed(1)

df <- tibble(
  arm = factor(sample(c("Arm A", "Arm B"), n, replace = TRUE), levels = c("Arm A", "Arm B")),
  country = factor(sample(c("CAN", "USA"), n, replace = TRUE, prob = c(.55, .45)), levels = c("CAN", "USA")),
  gender = factor(sample(c("Female", "Male"), n, replace = TRUE), levels = c("Female", "Male")),
  handed = factor(sample(c("Left", "Right"), n, prob = c(.6, .4), replace = TRUE), levels = c("Left", "Right")),
  age = rchisq(n, 30) + 10
) %>% mutate(
  weight = 35 * rnorm(n, sd = .5) + ifelse(gender == "Female", 140, 180)
) 

head(df)
```

Note that we use factors so that the level order is represented in the row or column order in the tabulation that will follow.


## Building an Table

We will build the following table:

```{r, echo=FALSE}
basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  add_colcounts() %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  summarize_row_groups() %>%
  analyze("age", afun = mean, format = "xx.x") %>%
  build_table(df)
```

Please take a moment and think about the information packed in this table:

* is the layout intuitive
* what data has been used in which cell
* which summary functions have been used?

## Layout Instructions

* Nested splitting
  - in row space: `split_rows_by`, `split_rows_by_*`
  - in column space: `split_cols_by`, `split_cols_by_*`
* Summarizing Groups: `summarize_row_groups`
* Analyzing Variables: `analyze`, `analyze_against_ref_group`


## Starting Simple

A basic table has one column representing all data and 0 rows. Analyzing a variable is one way of adding a row:

```{r}
l <- basic_table() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

Note, a number of things happen in the code above. We first define a layout and save it to the variable `l`. The layout here contains the information that we have one column for all the data and that the `age` variable should be analyzed with the `mean` analysis function and the result should be rounded to `1` precision. And then the layout is used to build a table using the actual data `df`. Hence, the layout is pre-data, that is, we do not need any data to say how to build a table. We can look at the layout isolated:

```{r}
l
```


### Adding Column Structure

Next, we will add more structure to the columns by splitting column space by the levels in the factor defined by the `arm` variable:


```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

We can continue the column space splitting by adding another `split_cols_by` instruction. By default this will add nested splitting. Here we splitting each arm further by the gender:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

So the first column represents the data in `df` where `df$arm == "A" & df$gender == "Female"` and the second column the data in `df` where `df$arm == "A" & df$gender == "Male"` and so on.

### Adding Row Structure

So far we have added analysis information and column structure. This resulted in multiple columns and one analysis or data row. We now continue to add column structure defined by the data using row splits by country:

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

In this table the data used to derive the first cell (average of age of female canadians in arm A) is  where `df$country == "CAN" & df$arm == "Arm A" & df$gender == "Female"`, hence the cell value can also be calculated manually:

```{r}
mean(df$age[df$country == "CAN" & df$arm == "Arm A" & df$gender == "Female"])
```

or in `dplyr` syntax:

```{r}
df %>%
  filter(country == "CAN", arm == "Arm A", gender == "Female") %>%
  summarise(mean_age = mean(age))
```

On a side note, we can actually easily get the first row with `dplyr`:

```{r}
df %>%
  group_by(arm, gender) %>%
  filter(country == "CAN") %>%
  summarise(mean_age = mean(age))
```

or all the data in the table above:

```{r}
df %>%
  group_by(arm, gender, country) %>%
  summarise(mean_age = mean(age))
```

and it also possible to reshape the data to look similar as displayed in the table above:

```{r, message=FALSE}
library(tidyr)

df %>%
  group_by(arm, gender, country) %>%
  summarise(mean_age = mean(age)) %>%
  pivot_wider(names_from = c(arm, gender), values_from = mean_age)
```

### Adding Group Information

Often a group of dat

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

Splitting Each Country By Handedness

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```

Summarizing Handedness Within Each Country

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  summarize_row_groups() %>%
  analyze("age", afun = mean, format = "xx.x")

build_table(l, df)
```



Add Column Observation Counts

```{r}
l <- basic_table() %>%
  split_cols_by("arm") %>%
  split_cols_by("gender") %>%
  split_rows_by("country") %>%
  summarize_row_groups() %>%
  split_rows_by("handed") %>%
  summarize_row_groups() %>%
  add_colcounts() %>%
  analyze("age", afun = mean, format = "xx.x")

tbl <- build_table(l, df)
tbl
```


```{r}
rtables:::treestruct(tbl)
```


## Subsetting

with `[` and `[[` and `cell_value`


## Deriving the information with dplyr only



